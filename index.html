<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ éº»å°‡é›²ç«¯è¨˜å¸³æœ¬ (é€£ç·šç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .player-row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .name-wrapper { flex: 2; display: flex; }
        .name-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; background: white; }
        .custom-name { width: 100%; padding: 10px; border: 1px solid #3498db; border-radius: 6px; font-size: 16px; display: none; }
        
        .sign-btn { flex: 0 0 45px; height: 42px; font-size: 24px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; }
        .btn-plus { background-color: #e74c3c; color: white; }
        .btn-minus { background-color: #27ae60; color: white; }

        .score-input { flex: 1.5; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; text-align: center; }
        .action-btn { width: 100%; padding: 14px; background-color: #2c3e50; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .delete-btn { background-color: #e74c3c; color: white; border:none; padding: 6px 12px; border-radius: 4px; cursor: pointer;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 15px; }
        th { background-color: #f8f9fa; color: #666; font-weight: 600; padding: 12px 8px; text-align: center; border-bottom: 2px solid #eee; }
        td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; }
        
        .win-text { color: #e74c3c; font-weight: bold; }
        .lose-text { color: #27ae60; font-weight: bold; }
        .zero-text { color: #95a5a6; }
        .error-msg { color: #e74c3c; text-align: center; font-weight: bold; margin-top: 10px; display: none; background: #fadbd8; padding: 10px; border-radius: 6px; }
        
        #status { text-align: center; font-size: 12px; color: #888; margin-bottom: 10px; }
        .online-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background-color: #2ecc71; }
    </style>
</head>
<body>

    <h1>ğŸ€„ éº»å°‡é›²ç«¯è¨˜å¸³</h1>
    <div id="status"><span class="online-dot" id="dot"></span><span id="statusText">é€£ç·šä¸­...</span></div>

    <div class="card">
        <h3>âœï¸ æ–°å¢æˆ°ç¸¾</h3>
        <div style="margin-bottom: 15px;">
            <label style="font-weight:bold;">æ—¥æœŸï¼š</label>
            <input type="date" id="dateInput" style="padding: 8px; border:1px solid #ddd; border-radius:4px;">
        </div>

        <div id="playersArea"></div>
        <p id="errorMsg" class="error-msg"></p>
        <button class="action-btn" onclick="addRecord()">â• é›²ç«¯åŒæ­¥å„²å­˜</button>
    </div>

    <div class="card">
        <h3>ğŸ† ç¸½çµç®—æ’è¡Œæ¦œ</h3>
        <table>
            <thead><tr><th width="20%">æ’å</th><th width="40%">å§“å</th><th width="40%">ç¸½æˆ°ç¸¾</th></tr></thead>
            <tbody id="summaryBody"><tr><td colspan="3">è¼‰å…¥ä¸­...</td></tr></tbody>
        </table>
    </div>

    <div class="card">
        <h3>ğŸ“œ é›²ç«¯æ­·å²ç´€éŒ„</h3>
        <button onclick="exportCSV()" style="background-color: #3498db; color:white; border:none; padding:8px 12px; border-radius:4px; font-size: 14px; margin-bottom: 10px;">ğŸ“¥ åŒ¯å‡º Excel</button>
        <div style="overflow-x:auto;">
            <table id="historyTable">
                <thead><tr><th width="25%">æ—¥æœŸ</th><th width="60%">æˆ°æ³</th><th width="15%">åˆªé™¤</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ==========================================
        // â–¼ æ‚¨çš„ Firebase è¨­å®š â–¼
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBuqMMuRwgysCZrSJagYmZLd2OOciJC1Rc",
            authDomain: "mahjong-app-d6267.firebaseapp.com",
            projectId: "mahjong-app-d6267",
            storageBucket: "mahjong-app-d6267.firebasestorage.app",
            messagingSenderId: "1083238926870",
            appId: "1:1083238926870:web:f1ffe3b5eadf959bcd8337",
            measurementId: "G-H7T8N8YCG1"
        };
        // ==========================================
        // â–² è¨­å®šçµæŸ â–²
        // ==========================================

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const recordsRef = db.ref('records');
        let localRecords = [];

        // ç›£è½é€£ç·šç‹€æ…‹
        db.ref('.info/connected').on('value', function(snap) {
            const statusText = document.getElementById('statusText');
            const dot = document.getElementById('dot');
            if (snap.val() === true) {
                statusText.innerText = "å·²é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«";
                dot.classList.add('connected');
            } else {
                statusText.innerText = "é€£ç·šä¸­æ–·ï¼Œå˜—è©¦é‡é€£...";
                dot.classList.remove('connected');
            }
        });

        // ç›£è½è³‡æ–™è®Šæ›´
        recordsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            localRecords = [];
            if (data) {
                Object.keys(data).forEach(key => {
                    localRecords.push({
                        id: key,
                        ...data[key]
                    });
                });
                // ä¾ç…§æ—¥æœŸé™åºæ’åˆ—
                localRecords.sort((a, b) => b.timestamp - a.timestamp);
            }
            render();
        });

        const PREDEFINED_NAMES = ["å®¥è¾°", "å¤ç‘‹", "H", "å­¸å§Š", "ä¸€ä¸­", "ç››å®‰"];
        document.getElementById('dateInput').valueAsDate = new Date();
        initPlayerInputs();

        function initPlayerInputs() {
            const container = document.getElementById('playersArea');
            let html = '';
            let optionsHtml = `<option value="" disabled selected>é¸æ“‡ç©å®¶</option>`;
            PREDEFINED_NAMES.forEach(name => optionsHtml += `<option value="${name}">${name}</option>`);
            optionsHtml += `<option value="Other">âœï¸ å…¶ä»–</option>`;

            for (let i = 1; i <= 4; i++) {
                html += `
                <div class="player-row">
                    <div class="name-wrapper">
                        <select class="name-select" onchange="handleNameChange(this)">${optionsHtml}</select>
                        <input type="text" class="custom-name" placeholder="è¼¸å…¥åå­—">
                    </div>
                    <button class="sign-btn btn-plus" onclick="toggleSign(this)">+</button>
                    <input type="number" class="score-input" placeholder="é‡‘é¡" inputmode="numeric">
                </div>`;
            }
            container.innerHTML = html;
        }

        function handleNameChange(select) {
            const wrapper = select.parentElement;
            const custom = wrapper.querySelector('.custom-name');
            if (select.value === 'Other') { select.style.display='none'; custom.style.display='block'; custom.focus(); }
            else { custom.style.display='none'; select.style.display='block'; custom.value=''; }
        }

        function toggleSign(btn) {
            if (btn.innerText === '+') { btn.innerText = '-'; btn.className = 'sign-btn btn-minus'; } 
            else { btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; }
        }

        function addRecord() {
            const date = document.getElementById('dateInput').value;
            const rows = document.querySelectorAll('.player-row');
            let currentEntry = [];
            let totalScore = 0;
            let namesCheck = new Set();

            for (let row of rows) {
                const select = row.querySelector('.name-select');
                const customInput = row.querySelector('.custom-name');
                const signBtn = row.querySelector('.sign-btn');
                const scoreInput = row.querySelector('.score-input');
                
                let name = select.style.display !== 'none' ? select.value : customInput.value.trim();
                if (!name || name === "Other") { showError("âš ï¸ è«‹å®Œæ•´è¼¸å…¥æ‰€æœ‰åå­—"); return; }
                if (namesCheck.has(name)) { showError(`âš ï¸ åå­—é‡è¤‡ï¼š${name}`); return; }
                namesCheck.add(name);

                let rawScore = parseInt(scoreInput.value);
                if (isNaN(rawScore)) { showError(`âš ï¸ è«‹è¼¸å…¥ ${name} çš„é‡‘é¡`); return; }
                let finalScore = Math.abs(rawScore) * (signBtn.innerText === '+' ? 1 : -1);

                currentEntry.push({ name: name, score: finalScore });
                totalScore += finalScore;
            }

            if (totalScore !== 0) { showError(`âš ï¸ å¸³ç›®ä¸å¹³ï¼ç›®å‰ç¸½å’Œ ${totalScore}`); return; }

            // å¯«å…¥ Firebase
            recordsRef.push({
                date: date,
                timestamp: Date.now(),
                details: currentEntry
            }).then(() => {
                rows.forEach(row => {
                    row.querySelector('.score-input').value = '';
                    let btn = row.querySelector('.sign-btn');
                    btn.innerText = '+'; btn.className = 'sign-btn btn-plus';
                });
                showError("");
                alert("âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼");
            }).catch(error => {
                alert("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + error.message);
            });
        }

        function deleteRecord(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ(æ‰€æœ‰äººçš„ç•«é¢éƒ½æœƒåˆªé™¤)")) return;
            recordsRef.child(id).remove();
        }

        function render() {
            // æ¸²æŸ“æ­·å²
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            if (localRecords.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="color:#999;">æš«ç„¡é›²ç«¯è³‡æ–™</td></tr>'; }
            
            localRecords.forEach(rec => {
                let detailsHtml = rec.details.map(p => {
                    let colorClass = p.score > 0 ? 'win-text' : (p.score < 0 ? 'lose-text' : 'zero-text');
                    let sign = p.score > 0 ? '+' : '';
                    return `<div style="display:flex; justify-content:space-between; max-width:180px; margin:0 auto;">
                        <span>${p.name}</span><span class="${colorClass}">${sign}${p.score}</span>
                    </div>`;
                }).join('');
                let row = `<tr><td style="font-size:13px; color:#666;">${rec.date}</td><td>${detailsHtml}</td><td><button class="delete-btn" onclick="deleteRecord('${rec.id}')">x</button></td></tr>`;
                tbody.innerHTML += row;
            });

            // æ¸²æŸ“çµ±è¨ˆ
            let stats = {};
            localRecords.forEach(rec => {
                rec.details.forEach(p => {
                    if (!stats[p.name]) stats[p.name] = 0;
                    stats[p.name] += p.score;
                });
            });
            
            const summaryBody = document.getElementById('summaryBody');
            summaryBody.innerHTML = '';
            if (Object.keys(stats).length === 0) { summaryBody.innerHTML = '<tr><td colspan="3" style="color:#999;">æš«ç„¡è³‡æ–™</td></tr>'; return; }

            Object.entries(stats).sort(([,a], [,b]) => b - a).forEach(([name, score], index) => {
                let colorClass = score > 0 ? 'win-text' : (score < 0 ? 'lose-text' : 'zero-text');
                let sign = score > 0 ? '+' : '';
                let rank = index + 1;
                if(index===0) rank='ğŸ¥‡'; if(index===1) rank='ğŸ¥ˆ'; if(index===2) rank='ğŸ¥‰';
                summaryBody.innerHTML += `<tr><td>${rank}</td><td style="font-weight:500;">${name}</td><td class="${colorClass}" style="font-size:16px;">${sign}${score}</td></tr>`;
            });
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg; el.style.display = msg ? 'block' : 'none';
        }

        function exportCSV() {
            let csv = "\uFEFFæ—¥æœŸ,ç©å®¶,é‡‘é¡\n";
            localRecords.forEach(rec => {
                rec.details.forEach(p => {
                    csv += `${rec.date},${p.name},${p.score}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `éº»å°‡é›²ç«¯æˆ°ç¸¾_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</body>
</html>
