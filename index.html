<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ éº»å°‡æˆ°ç¸¾è¨˜å¸³æœ¬</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #2c3e50; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-group { margin-bottom: 10px; display: flex; align-items: center; }
        .input-group label { flex: 1; font-weight: bold; }
        .input-group input { flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        button { width: 100%; padding: 12px; background-color: #27ae60; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #219150; }
        button.delete-btn { background-color: #e74c3c; width: auto; padding: 5px 10px; font-size: 12px; margin-top: 0;}
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #ecf0f1; }
        .win { color: #e74c3c; font-weight: bold; } /* ç´…è‰²è´éŒ¢ */
        .lose { color: #27ae60; font-weight: bold; } /* ç¶ è‰²è¼¸éŒ¢ */
        .error-msg { color: red; text-align: center; font-weight: bold; display: none; margin-top: 10px;}
        .stat-box { display: flex; justify-content: space-around; flex-wrap: wrap; }
        .stat-item { background: #ecf0f1; padding: 10px; border-radius: 5px; margin: 5px; text-align: center; flex: 1; min-width: 80px; }
    </style>
</head>
<body>

    <h1>ğŸ€„ éº»å°‡æˆ°ç¸¾è¨˜å¸³</h1>

    <div class="card">
        <h3>æ–°å¢æˆ°ç¸¾</h3>
        <div class="input-group">
            <label>æ—¥æœŸ</label>
            <input type="date" id="dateInput">
        </div>
        <div id="playersArea">
            <div class="input-group"><input type="text" placeholder="ç©å®¶ 1 åå­—" class="p-name" value="æˆ‘"><input type="number" placeholder="é‡‘é¡" class="p-score"></div>
            <div class="input-group"><input type="text" placeholder="ç©å®¶ 2 åå­—" class="p-name"><input type="number" placeholder="é‡‘é¡" class="p-score"></div>
            <div class="input-group"><input type="text" placeholder="ç©å®¶ 3 åå­—" class="p-name"><input type="number" placeholder="é‡‘é¡" class="p-score"></div>
            <div class="input-group"><input type="text" placeholder="ç©å®¶ 4 åå­—" class="p-name"><input type="number" placeholder="é‡‘é¡" class="p-score"></div>
        </div>
        <p id="errorMsg" class="error-msg"></p>
        <button onclick="addRecord()">â• è¨˜ä¸Šä¸€ç­†</button>
    </div>

    <div class="card">
        <h3>ğŸ† ç´¯è¨ˆæˆ°ç¸¾ (ç¸½çµç®—)</h3>
        <div id="statsBoard" class="stat-box">
            <p style="color:#777; width:100%; text-align:center;">æš«ç„¡è³‡æ–™</p>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“œ æ­·å²ç´€éŒ„</h3>
        <button onclick="exportCSV()" style="background-color: #3498db; font-size: 14px; margin-bottom: 10px;">ğŸ“¥ åŒ¯å‡º Excel (CSV)</button>
        <button onclick="clearAll()" style="background-color: #95a5a6; font-size: 14px; margin-bottom: 10px;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        <div style="overflow-x:auto;">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>ç©å®¶ & é‡‘é¡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æ—¥æœŸç‚ºä»Šå¤©
        document.getElementById('dateInput').valueAsDate = new Date();

        // è®€å–èˆŠè³‡æ–™
        let records = JSON.parse(localStorage.getItem('mahjong_records')) || [];
        render();

        function addRecord() {
            const date = document.getElementById('dateInput').value;
            const names = document.querySelectorAll('.p-name');
            const scores = document.querySelectorAll('.p-score');
            const errorMsg = document.getElementById('errorMsg');

            let currentEntry = [];
            let totalScore = 0;
            let playerNames = [];

            // æ”¶é›†è³‡æ–™
            for (let i = 0; i < 4; i++) {
                let name = names[i].value.trim();
                let score = parseInt(scores[i].value);

                if (!name) {
                    showError("âš ï¸ è«‹è¼¸å…¥æ‰€æœ‰ç©å®¶åå­—");
                    return;
                }
                if (isNaN(score)) {
                    showError(`âš ï¸ è«‹è¼¸å…¥ ${name} çš„é‡‘é¡`);
                    return;
                }
                
                currentEntry.push({ name: name, score: score });
                totalScore += score;
                playerNames.push(name);
            }

            // æª¢æŸ¥æ˜¯å¦å¹³å¸³
            if (totalScore !== 0) {
                showError(`âš ï¸ å¸³ç›®ä¸å¹³ï¼ç›®å‰ç¸½å’Œç‚º ${totalScore} (æ‡‰ç‚º 0)`);
                return;
            }

            // å„²å­˜ä¸¦æ›´æ–°
            records.unshift({ id: Date.now(), date: date, details: currentEntry });
            localStorage.setItem('mahjong_records', JSON.stringify(records));
            
            // æ¸…ç©ºè¼¸å…¥æ¡†é‡‘é¡ï¼Œä¿ç•™åå­—ï¼ˆæ–¹ä¾¿ä¸‹ä¸€å±€ï¼‰
            scores.forEach(s => s.value = '');
            showError(""); // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
            render();
            alert("âœ… ç´€éŒ„æˆåŠŸï¼");
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg;
            el.style.display = msg ? 'block' : 'none';
        }

        function deleteRecord(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
            records = records.filter(r => r.id !== id);
            localStorage.setItem('mahjong_records', JSON.stringify(records));
            render();
        }

        function clearAll() {
            if(!confirm("âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) return;
            records = [];
            localStorage.removeItem('mahjong_records');
            render();
        }

        function render() {
            // 1. æ¸²æŸ“æ­·å²åˆ—è¡¨
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            
            records.forEach(rec => {
                let detailsHtml = rec.details.map(p => 
                    `${p.name}: <span class="${p.score > 0 ? 'win' : (p.score < 0 ? 'lose' : '')}">${p.score > 0 ? '+' : ''}${p.score}</span>`
                ).join('<br>');

                let row = `<tr>
                    <td>${rec.date}</td>
                    <td style="text-align:left;">${detailsHtml}</td>
                    <td><button class="delete-btn" onclick="deleteRecord(${rec.id})">åˆªé™¤</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // 2. è¨ˆç®—ä¸¦æ¸²æŸ“çµ±è¨ˆæ¦œ
            let stats = {};
            records.forEach(rec => {
                rec.details.forEach(p => {
                    if (!stats[p.name]) stats[p.name] = 0;
                    stats[p.name] += p.score;
                });
            });

            const statsBoard = document.getElementById('statsBoard');
            if (Object.keys(stats).length === 0) {
                statsBoard.innerHTML = '<p style="color:#777; width:100%; text-align:center;">æš«ç„¡è³‡æ–™</p>';
            } else {
                statsBoard.innerHTML = '';
                // æ’åºï¼šè´æœ€å¤šçš„åœ¨å‰é¢
                Object.entries(stats)
                    .sort(([,a], [,b]) => b - a) 
                    .forEach(([name, score]) => {
                        let colorClass = score > 0 ? 'win' : (score < 0 ? 'lose' : '');
                        let sign = score > 0 ? '+' : '';
                        statsBoard.innerHTML += `
                            <div class="stat-item">
                                <div>${name}</div>
                                <div class="${colorClass}" style="font-size:18px; margin-top:5px;">${sign}${score}</div>
                            </div>
                        `;
                    });
            }
        }

        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // åŠ å…¥ BOM é˜²æ­¢äº‚ç¢¼
            csvContent += "æ—¥æœŸ,ç©å®¶,é‡‘é¡\n";
            
            records.forEach(rec => {
                rec.details.forEach(p => {
                    csvContent += `${rec.date},${p.name},${p.score}\n`;
                });
            });

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "éº»å°‡æˆ°ç¸¾_" + new Date().toISOString().slice(0,10) + ".csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
