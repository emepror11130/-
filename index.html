<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ éº»å°‡æˆ°ç¸¾è¨˜å¸³æœ¬ (å¿«é€Ÿç‰ˆ)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* è¼¸å…¥å€æ¨£å¼ */
        .player-row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        
        /* å§“åé¸å–® */
        .name-wrapper { flex: 2; display: flex; }
        .name-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; background: white; }
        .custom-name { width: 100%; padding: 10px; border: 1px solid #3498db; border-radius: 6px; font-size: 16px; display: none; }
        
        /* æ­£è² è™ŸæŒ‰éˆ• */
        .sign-btn { flex: 0 0 45px; height: 42px; font-size: 24px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; }
        .btn-plus { background-color: #e74c3c; color: white; } /* ç´…è‰²è´ */
        .btn-minus { background-color: #27ae60; color: white; } /* ç¶ è‰²è¼¸ */

        /* é‡‘é¡è¼¸å…¥æ¡† */
        .score-input { flex: 1.5; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; text-align: center; }

        /* ä¸»æŒ‰éˆ• */
        .action-btn { width: 100%; padding: 14px; background-color: #2c3e50; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.2s; }
        .action-btn:active { transform: scale(0.98); }
        
        .delete-btn { background-color: #e74c3c; color: white; border:none; padding: 6px 12px; border-radius: 4px; cursor: pointer;}
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 15px; }
        th { background-color: #f8f9fa; color: #666; font-weight: 600; padding: 12px 8px; text-align: center; border-bottom: 2px solid #eee; }
        td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; }
        
        .win-text { color: #e74c3c; font-weight: bold; } /* ç´…å­— */
        .lose-text { color: #27ae60; font-weight: bold; } /* ç¶ å­— */
        .zero-text { color: #95a5a6; }

        .error-msg { color: #e74c3c; text-align: center; font-weight: bold; margin-top: 10px; display: none; background: #fadbd8; padding: 10px; border-radius: 6px; }

        /* ç¸½çµç®—è¡¨å°ˆç”¨ */
        #summaryTable th { background-color: #2c3e50; color: white; }
        #summaryTable tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>

    <h1>ğŸ€„ éº»å°‡æˆ°ç¸¾è¨˜å¸³</h1>

    <div class="card">
        <h3>âœï¸ æ–°å¢æˆ°ç¸¾</h3>
        <div style="margin-bottom: 15px;">
            <label style="font-weight:bold;">æ—¥æœŸï¼š</label>
            <input type="date" id="dateInput" style="padding: 8px; border:1px solid #ddd; border-radius:4px;">
        </div>

        <div id="playersArea">
            </div>

        <p id="errorMsg" class="error-msg"></p>
        <button class="action-btn" onclick="addRecord()">â• è¨˜ä¸Šä¸€ç­†</button>
    </div>

    <div class="card">
        <h3>ğŸ† ç¸½çµç®—æ’è¡Œæ¦œ</h3>
        <table>
            <thead>
                <tr id="summaryHead">
                    <th width="20%">æ’å</th>
                    <th width="40%">å§“å</th>
                    <th width="40%">ç¸½æˆ°ç¸¾</th>
                </tr>
            </thead>
            <tbody id="summaryBody">
                </tbody>
        </table>
    </div>

    <div class="card">
        <h3>ğŸ“œ è©³ç´°æ­·å²ç´€éŒ„</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onclick="exportCSV()" style="background-color: #3498db; color:white; border:none; padding:8px 12px; border-radius:4px; font-size: 14px;">ğŸ“¥ åŒ¯å‡º Excel</button>
            <button onclick="clearAll()" style="background-color: #95a5a6; color:white; border:none; padding:8px 12px; border-radius:4px; font-size: 14px;">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <div style="overflow-x:auto;">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th width="25%">æ—¥æœŸ</th>
                        <th width="60%">æˆ°æ³</th>
                        <th width="15%">åˆªé™¤</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. è¨­å®šå›ºå®šåå–®
        const PREDEFINED_NAMES = ["å®¥è¾°", "å¤ç‘‹", "H", "å­¸å§Š", "ä¸€ä¸­", "ç››å®‰"];

        document.getElementById('dateInput').valueAsDate = new Date();
        let records = JSON.parse(localStorage.getItem('mahjong_records')) || [];

        initPlayerInputs();
        render();

        function initPlayerInputs() {
            const container = document.getElementById('playersArea');
            let html = '';
            
            let optionsHtml = `<option value="" disabled selected>é¸æ“‡ç©å®¶</option>`;
            PREDEFINED_NAMES.forEach(name => {
                optionsHtml += `<option value="${name}">${name}</option>`;
            });
            optionsHtml += `<option value="Other">âœï¸ å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option>`;

            for (let i = 1; i <= 4; i++) {
                html += `
                <div class="player-row">
                    <div class="name-wrapper">
                        <select class="name-select" onchange="handleNameChange(this)">${optionsHtml}</select>
                        <input type="text" class="custom-name" placeholder="è¼¸å…¥åå­—">
                    </div>
                    
                    <button class="sign-btn btn-plus" onclick="toggleSign(this)">+</button>
                    
                    <input type="number" class="score-input" placeholder="é‡‘é¡" inputmode="numeric">
                </div>`;
            }
            container.innerHTML = html;
        }

        function handleNameChange(selectElement) {
            const wrapper = selectElement.parentElement;
            const customInput = wrapper.querySelector('.custom-name');
            
            if (selectElement.value === 'Other') {
                selectElement.style.display = 'none';
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                selectElement.style.display = 'block';
                customInput.value = '';
            }
        }

        // åˆ‡æ›æ­£è² è™ŸæŒ‰éˆ•
        function toggleSign(btn) {
            if (btn.innerText === '+') {
                btn.innerText = '-';
                btn.className = 'sign-btn btn-minus'; // è®Šç¶ è‰²
            } else {
                btn.innerText = '+';
                btn.className = 'sign-btn btn-plus'; // è®Šç´…è‰²
            }
        }

        function addRecord() {
            const date = document.getElementById('dateInput').value;
            const rows = document.querySelectorAll('.player-row');
            
            let currentEntry = [];
            let totalScore = 0;
            let namesCheck = new Set();

            for (let row of rows) {
                const select = row.querySelector('.name-select');
                const customInput = row.querySelector('.custom-name');
                const signBtn = row.querySelector('.sign-btn'); // å–å¾—æ­£è² æŒ‰éˆ•
                const scoreInput = row.querySelector('.score-input');
                
                // è™•ç†åå­—
                let name = select.style.display !== 'none' ? select.value : customInput.value.trim();
                
                if (!name || name === "Other") {
                    showError("âš ï¸ è«‹å®Œæ•´è¼¸å…¥æ‰€æœ‰ç©å®¶åå­—");
                    return;
                }

                if (namesCheck.has(name)) {
                    showError(`âš ï¸ åå­—é‡è¤‡äº†ï¼š${name}`);
                    return;
                }
                namesCheck.add(name);

                // è™•ç†é‡‘é¡
                let rawScore = parseInt(scoreInput.value);
                if (isNaN(rawScore)) {
                    showError(`âš ï¸ è«‹è¼¸å…¥ ${name} çš„é‡‘é¡`);
                    return;
                }

                // é—œéµé‚è¼¯ï¼šæ ¹æ“šæŒ‰éˆ•æ±ºå®šæ­£è² 
                let multiplier = signBtn.innerText === '+' ? 1 : -1;
                let finalScore = Math.abs(rawScore) * multiplier; // ç¢ºä¿è¼¸å…¥è² æ•¸ä¹Ÿæœƒè¢«æ ¡æ­£

                currentEntry.push({ name: name, score: finalScore });
                totalScore += finalScore;
            }

            if (totalScore !== 0) {
                showError(`âš ï¸ å¸³ç›®ä¸å¹³ï¼ç›®å‰ç¸½å’Œç‚º ${totalScore} (æ‡‰ç‚º 0)`);
                return;
            }

            records.unshift({ id: Date.now(), date: date, details: currentEntry });
            localStorage.setItem('mahjong_records', JSON.stringify(records));
            
            // é‡ç½®è¼¸å…¥ (ä¿ç•™åå­—ï¼Œé‡‘é¡æ¸…ç©ºï¼Œç¬¦è™Ÿé‡ç½®ç‚º +)
            rows.forEach(row => {
                row.querySelector('.score-input').value = '';
                let btn = row.querySelector('.sign-btn');
                btn.innerText = '+';
                btn.className = 'sign-btn btn-plus';
            });
            
            showError("");
            render();
        }

        function render() {
            renderHistory();
            renderSummary();
        }

        function renderHistory() {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            
            records.forEach(rec => {
                let detailsHtml = rec.details.map(p => {
                    let colorClass = p.score > 0 ? 'win-text' : (p.score < 0 ? 'lose-text' : 'zero-text');
                    let sign = p.score > 0 ? '+' : '';
                    return `<div style="display:flex; justify-content:space-between; max-width:180px; margin:0 auto;">
                        <span>${p.name}</span>
                        <span class="${colorClass}">${sign}${p.score}</span>
                    </div>`;
                }).join('');

                let row = `<tr>
                    <td style="font-size:13px; color:#666;">${rec.date}</td>
                    <td>${detailsHtml}</td>
                    <td><button class="delete-btn" onclick="deleteRecord(${rec.id})">x</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderSummary() {
            let stats = {};
            records.forEach(rec => {
                rec.details.forEach(p => {
                    if (!stats[p.name]) stats[p.name] = 0;
                    stats[p.name] += p.score;
                });
            });

            const tbody = document.getElementById('summaryBody');
            tbody.innerHTML = '';

            if (Object.keys(stats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="color:#999;">æš«ç„¡è³‡æ–™</td></tr>';
                return;
            }

            let sortedStats = Object.entries(stats).sort(([,a], [,b]) => b - a);

            sortedStats.forEach(([name, score], index) => {
                let colorClass = score > 0 ? 'win-text' : (score < 0 ? 'lose-text' : 'zero-text');
                let sign = score > 0 ? '+' : '';
                
                let rank = index + 1;
                if(index === 0) rank = 'ğŸ¥‡';
                if(index === 1) rank = 'ğŸ¥ˆ';
                if(index === 2) rank = 'ğŸ¥‰';

                let row = `<tr>
                    <td>${rank}</td>
                    <td style="font-weight:500;">${name}</td>
                    <td class="${colorClass}" style="font-size:16px;">${sign}${score}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function deleteRecord(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
            records = records.filter(r => r.id !== id);
            localStorage.setItem('mahjong_records', JSON.stringify(records));
            render();
        }

        function clearAll() {
            if(!confirm("âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) return;
            records = [];
            localStorage.removeItem('mahjong_records');
            render();
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg;
            el.style.display = msg ? 'block' : 'none';
        }

        function exportCSV() {
            let csv = "\uFEFFæ—¥æœŸ,ç©å®¶,é‡‘é¡\n";
            records.forEach(rec => {
                rec.details.forEach(p => {
                    csv += `${rec.date},${p.name},${p.score}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `éº»å°‡æˆ°ç¸¾_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</body>
</html>
