<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ€„ é›€ç¥é›²ç«¯è¨˜å¸³</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --bg-color: #1e6f50; --card-bg: #ffffff; --win-color: #e74c3c; --lose-color: #27ae60; --text-main: #2c3e50; }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            padding: 12px; 
            padding-bottom: 60px;
        }

        h1 { text-align: center; color: #fff; margin: 5px 0 10px 0; font-size: 20px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        #status { text-align: center; font-size: 12px; color: rgba(255,255,255,0.9); margin-bottom: 12px; }
        .online-dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        .card { 
            background: var(--card-bg); 
            padding: 16px; 
            border-radius: 16px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 15px; 
            width: 100%; 
            overflow: hidden; 
        }
        
        .card h3 { margin: 0 0 12px 0; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; color: var(--bg-color); font-size: 17px; display: flex; justify-content: space-between; align-items: center; }

        /* === è¼¸å…¥å€ === */
        .row-date { margin-bottom: 12px; }
        .row-date label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; font-weight: bold; margin-left: 2px; }
        
        .row-stats { display: flex; gap: 12px; margin-bottom: 20px; }
        .col-half { flex: 1; }
        .col-half label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; font-weight: bold; margin-left: 2px; }
        
        .input-style { 
            width: 100%; height: 44px; padding: 0 12px; border: 1px solid #ddd; border-radius: 8px; 
            font-size: 16px; background: #f9f9f9; color: #333; line-height: normal;
            display: flex; align-items: center; justify-content: center;
        }
        
        input[type="date"] { -webkit-appearance: none; appearance: none; display: flex; align-items: center; justify-content: center; line-height: normal; padding: 0; }
        input[type="date"]::-webkit-date-and-time-value { line-height: 1.5; padding-top: 2px; }

        .player-row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .name-wrapper { flex: 1; min-width: 0; position: relative; } 
        
        .name-select, .custom-name { 
            width: 100%; height: 44px; padding: 0 10px; border: 1px solid #ddd; border-radius: 8px; 
            font-size: 15px; background: white; appearance: none; -webkit-appearance: none; color: #333;
        }
        .name-select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 8px center; background-size: 16px;
        }

        .sign-btn { 
            flex: 0 0 40px; height: 40px; width: 40px; font-size: 24px; font-weight: bold; border: none; border-radius: 50%; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; padding: 0; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-plus { background-color: #fff; color: var(--win-color); border: 1.5px solid var(--win-color); }
        .btn-minus { background-color: var(--lose-color); color: white; border: 1.5px solid var(--lose-color); }

        .score-input { width: 80px; height: 44px; padding: 0 5px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; font-weight: bold; color: var(--text-main); }

        .action-btn { width: 100%; padding: 14px; background-color: var(--text-main); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .cancel-btn { width: 100%; padding: 10px; background-color: #95a5a6; color: white; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; margin-top: 8px; display: none; }

        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 14px; table-layout: fixed; }
        th { background-color: #f8f9fa; color: #888; font-weight: 600; padding: 10px 4px; text-align: center; font-size: 13px; border-radius: 4px; }
        td { padding: 12px 4px; text-align: center; border-bottom: 1px solid #eee; word-wrap: break-word; }
        
        .win-text { color: var(--win-color); font-weight: bold; }
        .lose-text { color: var(--lose-color); font-weight: bold; }
        
        .rank-badge { display: inline-block; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; font-size: 14px; }
        .rank-1 { background: transparent; font-size: 20px; line-height: 24px; text-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .rank-2 { background: transparent; font-size: 20px; line-height: 24px; text-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .rank-3 { background: transparent; font-size: 20px; line-height: 24px; text-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .rank-boss { background: #2c3e50; color: #f1c40f; font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; width: auto; height: auto; line-height: normal; }
        .rank-other { background: #eee; font-size: 12px; color: #666; }

        .dashboard-grid { display: flex; gap: 10px; margin-bottom: 5px; }
        .dash-box { flex: 1; padding: 12px 5px; border-radius: 10px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .dash-label { font-size: 11px; color: #666; margin-bottom: 2px; }
        .dash-value { font-size: 18px; font-weight: bold; line-height: 1.2; }

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .history-header { margin-bottom: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .history-date { font-size: 13px; color: #333; font-weight: 500; }
        .history-tag { font-size: 11px; padding: 1px 5px; border-radius: 4px; display: inline-block; white-space: nowrap; }
        .tag-holiday { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-weight: bold; }
        .tag-lunar { background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        .tag-info { background-color: #f5f5f5; color: #666; border: 1px solid #e0e0e0; }
        
        .history-scores { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 10px; margin-top: 5px; font-size: 13px; }
        
        .edit-btn { background: #f39c12; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 14px; }
        .delete-btn { background: #ff7675; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 14px; margin-left: 8px;}
        .error-msg { background: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; display: none; margin-top: 10px; font-size: 14px;}
        .editing-mode { border: 2px solid #f39c12; }

        .backup-btn { background: transparent; border: 1px solid #2ecc71; color: #2ecc71; border-radius: 20px; padding: 2px 8px; font-size: 12px; cursor: pointer; margin-left: 5px;}
        
        .manage-area { margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 10px; display: none; }
        .manage-btn { background: none; border: none; color: #7f8c8d; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .manage-btn:hover { color: #2c3e50; }
        .player-tag { background: #f0f2f5; border: 1px solid #dcdfe6; border-radius: 20px; padding: 5px 12px; font-size: 14px; color: #606266; display: flex; align-items: center; gap: 8px; }
        .player-delete { color: #f56c6c; cursor: pointer; font-weight: bold; font-size: 16px; line-height: 1; }
        .player-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>ğŸ€„ é›€ç¥è¨˜å¸³æœ¬</h1>
    <div id="status"><span class="online-dot" id="dot"></span><span id="statusText">é€£ç·šä¸­...</span></div>

    <div class="card" id="inputCard">
        <h3 id="inputTitle"><span>âœï¸ æ–°å¢æˆ°ç¸¾</span></h3>
        
        <div class="row-date">
            <label>æ—¥æœŸ</label>
            <input type="date" id="dateInput" class="input-style">
        </div>
        
        <div class="row-stats">
            <div class="col-half">
                <label>å°‡æ•¸</label>
                <input type="number" id="jiangInput" class="input-style" placeholder="0" value="1" inputmode="numeric">
            </div>
            <div class="col-half">
                <label>æ±éŒ¢</label>
                <input type="number" id="dongInput" class="input-style" placeholder="0" value="0" inputmode="numeric">
            </div>
        </div>

        <div id="playersArea"></div>
        <p id="errorMsg" class="error-msg"></p>
        
        <button class="action-btn" id="saveBtn" onclick="saveData()">å„²å­˜ç´€éŒ„</button>
        
        <div style="display:flex; justify-content:space-between; margin-top:10px; align-items:center;">
            <button class="manage-btn" onclick="togglePlayerManager()">âš™ï¸ ç®¡ç†é¸æ‰‹</button>
            <button class="cancel-btn" id="cancelBtn" onclick="cancelEdit()" style="margin:0;">å–æ¶ˆä¿®æ”¹</button>
        </div>

        <div id="manageArea" class="manage-area">
            <div style="font-size:12px; color:#999; margin-bottom:5px;">é»æ“Š âœ• å¯åˆªé™¤é¸æ‰‹ (éœ€å¯†ç¢¼é©—è­‰)</div>
            <div id="manageList" class="player-list"></div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ† è‹±é›„æ¦œ</h3>
        <table>
            <thead><tr><th width="15%">#</th><th width="40%">å§“å</th><th width="45%">ç´¯ç©</th></tr></thead>
            <tbody id="summaryBody"><tr><td colspan="3">è¼‰å…¥ä¸­...</td></tr></tbody>
        </table>
    </div>

    <div class="card">
        <h3>ğŸ“Š çµ±è¨ˆæ•¸æ“š</h3>
        <div class="dashboard-grid">
            <div class="dash-box" style="background: #e8f5e9;">
                <div class="dash-label">æ­·å²ç¸½å°‡æ•¸</div>
                <div class="dash-value" style="color: #2e7d32;" id="grandTotalJiang">0</div>
            </div>
            <div class="dash-box" style="background: #fff3e0;">
                <div class="dash-label">æ­·å²ç¸½æ±éŒ¢</div>
                <div class="dash-value" style="color: #ef6c00;" id="grandTotalDong">$0</div>
            </div>
        </div>
        <table>
            <thead><tr><th>æœˆä»½</th><th>å ´æ¬¡</th><th>æ±éŒ¢</th></tr></thead>
            <tbody id="monthlyStatsBody"><tr><td colspan="3">è¨ˆç®—ä¸­...</td></tr></tbody>
        </table>
        <div id="yearlyStatsFoot" style="text-align:center; margin-top:10px; font-weight:bold; color:#1e6f50; font-size: 13px;"></div>
    </div>

    <div class="card">
        <h3>
            ğŸ“œ ç´€éŒ„
            <div>
                <button class="backup-btn" onclick="backupData()">ğŸ’¾ å‚™ä»½</button>
                <button onclick="exportCSV()" style="background:transparent; border:1px solid #3498db; color:#3498db; border-radius:20px; padding:2px 8px; font-size:12px; margin-left:5px;">ğŸ“¥ Excel</button>
            </div>
        </h3>
        <div id="historyList"></div>
    </div>

    <script>
        // ==========================================
        // â–¼ Firebase è¨­å®š â–¼
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBuqMMuRwgysCZrSJagYmZLd2OOciJC1Rc",
            authDomain: "mahjong-app-d6267.firebaseapp.com",
            projectId: "mahjong-app-d6267",
            storageBucket: "mahjong-app-d6267.firebasestorage.app",
            messagingSenderId: "1083238926870",
            appId: "1:1083238926870:web:f1ffe3b5eadf959bcd8337",
            measurementId: "G-H7T8N8YCG1"
        };
        // ==========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const recordsRef = db.ref('records');
        const playersRef = db.ref('players'); 

        const SAFETY_PASSWORD = "8888";

        let localRecords = [];
        let currentEditId = null;
        
        // ä¿®æ­£å¾Œçš„é è¨­åå–®
        const DEFAULT_PLAYERS = ["å®¥è¾°", "å¤ç‘‹", "è•™å„€", "H", "ç››å®‰", "ä¸€ä¸­"];
        let allPlayers = [...DEFAULT_PLAYERS];

        db.ref('.info/connected').on('value', function(snap) {
            const statusText = document.getElementById('statusText');
            const dot = document.getElementById('dot');
            if (snap.val() === true) {
                statusText.innerText = "å·²é€£ç·š"; dot.classList.add('connected');
            } else {
                statusText.innerText = "é€£ç·šä¸­..."; dot.classList.remove('connected');
            }
        });

        playersRef.on('value', (snap) => {
            const data = snap.val();
            if (data) {
                const cloudPlayers = Object.keys(data);
                // ç¢ºä¿ DEFAULT_PLAYERS çš„äººæ’åœ¨å‰é¢
                const newPlayers = cloudPlayers.filter(p => !DEFAULT_PLAYERS.includes(p));
                // é€™è£¡åšå€‹éæ¿¾ï¼Œç¢ºä¿ DEFAULT_PLAYERS è£¡çš„äººå¦‚æœè¢«é›²ç«¯åˆªäº†ï¼Œå°±ä¸é¡¯ç¤º
                // ä½†ç‚ºäº†ç¬¦åˆã€Œä»¥é›²ç«¯ç‚ºä¸»ã€çš„é‚è¼¯ï¼Œæˆ‘å€‘åªç”¨ cloudPlayers
                // ä¸éç‚ºäº†ç¬¦åˆæ‚¨çš„é †åºè¦æ±‚ï¼Œæˆ‘å€‘å˜—è©¦æ’åºï¼šå¦‚æœé›²ç«¯æœ‰é€™äº›äººï¼Œå°±å„ªå…ˆæ’å‰é¢
                let sortedPlayers = [];
                // 1. å…ˆæ”¾æ‚¨æŒ‡å®šé †åºçš„äºº (å¦‚æœé›²ç«¯æœ‰)
                DEFAULT_PLAYERS.forEach(p => {
                    if (cloudPlayers.includes(p)) {
                        sortedPlayers.push(p);
                    }
                });
                // 2. å†æ”¾å‰©ä¸‹çš„å…¶ä»–äºº
                cloudPlayers.forEach(p => {
                    if (!sortedPlayers.includes(p)) {
                        sortedPlayers.push(p);
                    }
                });
                allPlayers = sortedPlayers;
            } else {
                let updates = {};
                DEFAULT_PLAYERS.forEach(n => updates[n] = true);
                playersRef.update(updates);
                allPlayers = DEFAULT_PLAYERS;
            }
            updateAllPlayerSelects(); 
            renderManageList(); 
        });

        recordsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            localRecords = [];
            if (data) {
                Object.keys(data).forEach(key => {
                    localRecords.push({ id: key, ...data[key] });
                });
                localRecords.sort((a, b) => b.timestamp - a.timestamp);
            }
            render();
        });

        document.getElementById('dateInput').valueAsDate = new Date();
        initPlayerInputs();

        function initPlayerInputs() {
            const container = document.getElementById('playersArea');
            let html = '';
            for (let i = 1; i <= 4; i++) {
                html += `
                <div class="player-row">
                    <div class="name-wrapper">
                        <select class="name-select" onchange="handleNameChange(this)"></select>
                        <input type="text" class="custom-name" placeholder="è¼¸å…¥åå­—" style="display:none;">
                    </div>
                    <button class="sign-btn btn-plus" onclick="toggleSign(this)">+</button>
                    <input type="number" class="score-input" placeholder="0" inputmode="numeric">
                </div>`;
            }
            container.innerHTML = html;
        }

        function updateAllPlayerSelects() {
            let optionsHtml = `<option value="" disabled selected>è«‹é¸æ“‡é¸æ‰‹...</option>`;
            allPlayers.forEach(name => {
                optionsHtml += `<option value="${name}">${name}</option>`;
            });
            optionsHtml += `<option value="ADD_NEW" style="color:#2ecc71; font-weight:bold;">â• æ–°å¢å›ºå®šç‰Œå‹...</option>`;
            optionsHtml += `<option value="Other" style="color:#e67e22;">âœï¸ å–®æ¬¡è‡ªè¨‚...</option>`;

            document.querySelectorAll('.name-select').forEach(select => {
                const currentVal = select.value;
                select.innerHTML = optionsHtml;
                if (currentVal && (allPlayers.includes(currentVal) || currentVal === 'Other' || currentVal === 'ADD_NEW')) {
                    select.value = currentVal;
                }
            });
        }

        function togglePlayerManager() {
            const area = document.getElementById('manageArea');
            if (area.style.display === 'block') {
                area.style.display = 'none';
            } else {
                if (checkPassword()) {
                    area.style.display = 'block';
                    renderManageList();
                } else {
                    alert("âŒ å¯†ç¢¼éŒ¯èª¤");
                }
            }
        }

        function renderManageList() {
            const list = document.getElementById('manageList');
            list.innerHTML = '';
            allPlayers.forEach(name => {
                list.innerHTML += `
                    <div class="player-tag">
                        ${name} 
                        <span class="player-delete" onclick="deletePlayerFromList('${name}')">âœ•</span>
                    </div>`;
            });
        }

        function deletePlayerFromList(name) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ\nä»¥å¾Œé¸å–®å°±ä¸æœƒå‡ºç¾é€™å€‹åå­—å›‰ã€‚`)) {
                playersRef.child(name).remove();
            }
        }

        function handleNameChange(select) {
            const wrapper = select.parentElement;
            const custom = wrapper.querySelector('.custom-name');
            const val = select.value;

            if (val === 'Other') {
                select.style.display = 'none';
                custom.style.display = 'block';
                custom.focus();
            } else if (val === 'ADD_NEW') {
                const newName = prompt("è«‹è¼¸å…¥æ–°ç‰Œå‹çš„åå­—ï¼š");
                if (newName && newName.trim() !== "") {
                    playersRef.child(newName.trim()).set(true).then(() => {
                        setTimeout(() => { select.value = newName.trim(); }, 100);
                    });
                } else {
                    select.value = "";
                }
            } else {
                custom.style.display = 'none';
                select.style.display = 'block';
                custom.value = '';
            }
        }

        function toggleSign(btn) {
            if (btn.innerText === '+') { btn.innerText = '-'; btn.className = 'sign-btn btn-minus'; } 
            else { btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; }
        }

        function checkPassword() {
            let p = prompt("è«‹è¼¸å…¥å®‰å…¨å¯†ç¢¼ (é è¨­ 8888)ï¼š");
            return p === SAFETY_PASSWORD;
        }

        function saveData() {
            if (currentEditId) {
                if (!checkPassword()) { alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œæ‹’çµ•ä¿®æ”¹"); return; }
            }

            const date = document.getElementById('dateInput').value;
            const jiangCount = parseInt(document.getElementById('jiangInput').value) || 0;
            const dongQian = parseInt(document.getElementById('dongInput').value) || 0;
            const rows = document.querySelectorAll('.player-row');
            
            let currentEntry = [];
            let totalScore = 0;
            let namesCheck = new Set();

            for (let row of rows) {
                const select = row.querySelector('.name-select');
                const customInput = row.querySelector('.custom-name');
                const signBtn = row.querySelector('.sign-btn');
                const scoreInput = row.querySelector('.score-input');
                
                let name = "";
                if (select.style.display !== 'none') {
                    name = select.value;
                    if (name === "ADD_NEW") name = ""; 
                } else {
                    name = customInput.value.trim();
                }

                if (!name) { showError("âš ï¸ è«‹è¼¸å…¥/é¸æ“‡é¸æ‰‹åå­—"); return; }
                if (namesCheck.has(name)) { showError(`âš ï¸ åå­—é‡è¤‡ï¼š${name}`); return; }
                namesCheck.add(name);

                let rawScore = parseInt(scoreInput.value);
                if (isNaN(rawScore)) { showError(`âš ï¸ è«‹è¼¸å…¥é‡‘é¡`); return; }
                let finalScore = Math.abs(rawScore) * (signBtn.innerText === '+' ? 1 : -1);

                currentEntry.push({ name: name, score: finalScore });
                totalScore += finalScore;
            }

            if (totalScore !== 0) { showError(`âš ï¸ å¸³ç›®ä¸å¹³ï¼ç›®å‰ç¸½å’Œ ${totalScore}`); return; }

            const recordData = {
                date: date,
                timestamp: Date.now(),
                jiangCount: jiangCount,
                dongQian: dongQian,
                details: currentEntry
            };

            if (currentEditId) {
                recordsRef.child(currentEditId).update(recordData)
                    .then(() => { alert("âœ… ä¿®æ”¹æˆåŠŸ"); cancelEdit(); })
                    .catch(err => alert("å¤±æ•—: " + err.message));
            } else {
                recordsRef.push(recordData)
                    .then(() => { resetForm(); alert("âœ… å„²å­˜æˆåŠŸ"); })
                    .catch(err => alert("å¤±æ•—: " + err.message));
            }
        }

        function editRecord(id) {
            const record = localRecords.find(r => r.id === id);
            if (!record) return;

            document.getElementById('dateInput').value = record.date;
            document.getElementById('jiangInput').value = record.jiangCount || 0;
            document.getElementById('dongInput').value = record.dongQian || 0;

            const rows = document.querySelectorAll('.player-row');
            for (let i = 0; i < 4; i++) {
                if (i < record.details.length) {
                    const p = record.details[i];
                    const row = rows[i];
                    const select = row.querySelector('.name-select');
                    const custom = row.querySelector('.custom-name');
                    const score = row.querySelector('.score-input');
                    const btn = row.querySelector('.sign-btn');

                    if (allPlayers.includes(p.name)) {
                        select.value = p.name; 
                        select.style.display = 'block'; 
                        custom.style.display = 'none';
                    } else {
                        select.value = 'Other'; 
                        select.style.display = 'none'; 
                        custom.style.display = 'block'; 
                        custom.value = p.name;
                    }

                    score.value = Math.abs(p.score);
                    if (p.score < 0) { btn.innerText = '-'; btn.className = 'sign-btn btn-minus'; }
                    else { btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; }
                }
            }

            currentEditId = id;
            document.getElementById('inputCard').classList.add('editing-mode');
            document.getElementById('inputTitle').innerText = "âœï¸ ä¿®æ”¹ä¸­...";
            document.getElementById('saveBtn').innerText = "ç¢ºèªä¿®æ”¹ (éœ€å¯†ç¢¼)";
            document.getElementById('saveBtn').style.backgroundColor = "#f39c12";
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            currentEditId = null;
            document.getElementById('inputCard').classList.remove('editing-mode');
            document.getElementById('inputTitle').innerText = "âœï¸ æ–°å¢æˆ°ç¸¾";
            document.getElementById('saveBtn').innerText = "å„²å­˜ç´€éŒ„";
            document.getElementById('saveBtn').style.backgroundColor = "";
            document.getElementById('cancelBtn').style.display = "none";
            document.getElementById('manageArea').style.display = 'none';
            resetForm();
        }

        function resetForm() {
            const rows = document.querySelectorAll('.player-row');
            rows.forEach(row => {
                row.querySelector('.score-input').value = '';
                let btn = row.querySelector('.sign-btn');
                btn.innerText = '+'; btn.className = 'sign-btn btn-plus';
                
                const select = row.querySelector('.name-select');
                const custom = row.querySelector('.custom-name');
                select.value = "";
                select.style.display = 'block';
                custom.style.display = 'none';
            });
            document.getElementById('dongInput').value = 0;
            document.getElementById('jiangInput').value = 1;
            showError("");
        }

        function deleteRecord(id) {
            if (!checkPassword()) { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); return; }
            if(!confirm("âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) return;
            recordsRef.child(id).remove();
            if (currentEditId === id) cancelEdit();
        }

        function getHolidayTag(dateStr) {
            try {
                const dateParts = dateStr.split('-');
                const y = parseInt(dateParts[0]);
                const m = parseInt(dateParts[1]);
                const d = parseInt(dateParts[2]);
                
                if (m === 2 && d === 14) return '<span class="history-tag tag-holiday">ğŸ’˜ æƒ…äººç¯€</span>';
                if (m === 12 && d === 25) return '<span class="history-tag tag-holiday">ğŸ„ è–èª•ç¯€</span>';
                if (m === 1 && d === 1) return '<span class="history-tag tag-holiday">ğŸ‰ å…ƒæ—¦</span>';
                if (m === 10 && d === 10) return '<span class="history-tag tag-holiday">ğŸ‡¹ğŸ‡¼ åœ‹æ…¶</span>';

                const lunar = Lunar.fromDate(new Date(y, m - 1, d));
                const lMonth = lunar.getMonth();
                const lDay = lunar.getDay();

                if (lMonth === 1 && lDay === 1) return '<span class="history-tag tag-holiday">ğŸ§§ æ˜¥ç¯€</span>';
                if (lMonth === 1 && lDay === 15) return '<span class="history-tag tag-holiday">ğŸ® å…ƒå®µ</span>';
                if (lMonth === 5 && lDay === 5) return '<span class="history-tag tag-holiday">ğŸ‰ ç«¯åˆ</span>';
                if (lMonth === 7 && lDay === 7) return '<span class="history-tag tag-holiday">ğŸ‹ ä¸ƒå¤•</span>';
                if (lMonth === 7 && lDay === 15) return '<span class="history-tag tag-holiday">ğŸ‘» ä¸­å…ƒ</span>';
                if (lMonth === 8 && lDay === 15) return '<span class="history-tag tag-holiday">ğŸ¥® ä¸­ç§‹</span>';
                
                const nextDay = Lunar.fromDate(new Date(y, m - 1, d + 1));
                if (nextDay.getYear() !== lunar.getYear()) return '<span class="history-tag tag-holiday">ğŸ² é™¤å¤•</span>';

                if (lDay === 1) return '<span class="history-tag tag-lunar">ğŸŒ‘ åˆä¸€</span>';
                if (lDay === 15) return '<span class="history-tag tag-lunar">ğŸŒ• åäº”</span>';

                return '';
            } catch (e) {
                return '';
            }
        }

        function render() {
            const listDiv = document.getElementById('historyList');
            listDiv.innerHTML = '';
            if (localRecords.length === 0) { listDiv.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">ç„¡ç´€éŒ„</p>'; }

            localRecords.forEach(rec => {
                let detailsHtml = rec.details.map(p => {
                    let colorClass = p.score > 0 ? 'win-text' : (p.score < 0 ? 'lose-text' : 'zero-text');
                    let sign = p.score > 0 ? '+' : '';
                    return `<div><span>${p.name}</span> <span class="${colorClass}">${sign}${p.score}</span></div>`;
                }).join('');

                let holidayTag = getHolidayTag(rec.date);
                let infoTags = "";
                if (rec.jiangCount) infoTags += `<span class="history-tag tag-info">ğŸ€„ ${rec.jiangCount}å°‡</span>`;
                if (rec.dongQian) infoTags += `<span class="history-tag tag-info">ğŸ’° æ±${rec.dongQian}</span>`;

                let item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div style="flex:1;">
                        <div class="history-header">
                            <span class="history-date">${rec.date}</span>
                            ${holidayTag}
                            ${infoTags}
                        </div>
                        <div class="history-scores">${detailsHtml}</div>
                    </div>
                    <div>
                        <button class="edit-btn" onclick="editRecord('${rec.id}')">âœ</button>
                        <button class="delete-btn" onclick="deleteRecord('${rec.id}')">âœ•</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });

            let stats = {};
            localRecords.forEach(rec => {
                rec.details.forEach(p => {
                    if (!stats[p.name]) stats[p.name] = 0;
                    stats[p.name] += p.score;
                });
            });
            const summaryBody = document.getElementById('summaryBody');
            summaryBody.innerHTML = '';
            
            if (Object.keys(stats).length === 0) { summaryBody.innerHTML = '<tr><td colspan="3" style="color:#999;">ç„¡è³‡æ–™</td></tr>'; }
            else {
                let sortedStats = Object.entries(stats).sort(([,a], [,b]) => b - a);
                
                sortedStats.forEach(([name, score], index) => {
                    let colorClass = score > 0 ? 'win-text' : (score < 0 ? 'lose-text' : 'zero-text');
                    let sign = score > 0 ? '+' : '';
                    
                    let rankContent = index + 1;
                    let rankClass = "rank-other";

                    if(index === 0) { rankContent = 'ğŸ¥‡'; rankClass = "rank-1"; }
                    else if(index === 1) { rankContent = 'ğŸ¥ˆ'; rankClass = "rank-2"; }
                    else if(index === 2) { rankContent = 'ğŸ¥‰'; rankClass = "rank-3"; }

                    if (index === sortedStats.length - 1 && sortedStats.length > 1) {
                        rankContent = 'è€é—†';
                        rankClass = 'rank-boss';
                    }
                    
                    summaryBody.innerHTML += `<tr>
                        <td><span class="rank-badge ${rankClass}">${rankContent}</span></td>
                        <td style="font-weight:500;">${name}</td>
                        <td class="${colorClass}">${sign}${score}</td>
                    </tr>`;
                });
            }

            let monthlyData = {}; 
            let yearlyJiang = {}; 
            let grandTotalJiang = 0; 
            let grandTotalDong = 0; 

            localRecords.forEach(rec => {
                let dateObj = new Date(rec.date);
                let year = dateObj.getFullYear();
                let month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                let key = `${month}æœˆ`;
                if (!monthlyData[key]) monthlyData[key] = { jiang: 0, dong: 0 };
                if (!yearlyJiang[year]) yearlyJiang[year] = 0;

                let j = parseInt(rec.jiangCount) || 0;
                let d = parseInt(rec.dongQian) || 0;

                monthlyData[key].jiang += j;
                monthlyData[key].dong += d;
                yearlyJiang[year] += j;
                
                grandTotalJiang += j;
                grandTotalDong += d;
            });

            document.getElementById('grandTotalJiang').innerText = grandTotalJiang;
            document.getElementById('grandTotalDong').innerText = "$" + grandTotalDong;

            const statsBody = document.getElementById('monthlyStatsBody');
            const yearFoot = document.getElementById('yearlyStatsFoot');
            statsBody.innerHTML = '';
            yearFoot.innerHTML = '';

            let sortedKeys = Object.keys(monthlyData).sort().reverse();
            if (sortedKeys.length === 0) { statsBody.innerHTML = '<tr><td colspan="3">ç„¡è³‡æ–™</td></tr>'; }
            else {
                sortedKeys.forEach(key => {
                    let d = monthlyData[key];
                    statsBody.innerHTML += `<tr><td>${key}</td><td>${d.jiang}</td><td>${d.dong}</td></tr>`;
                });
            }
            let sortedYears = Object.keys(yearlyJiang).sort().reverse();
            if(sortedYears.length > 0) {
                yearFoot.innerHTML = `${sortedYears[0]}å¹´ç¸½è¨ˆï¼š${yearlyJiang[sortedYears[0]]} å°‡`;
            }
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg; el.style.display = msg ? 'block' : 'none';
        }

        function exportCSV() {
            let csv = "\uFEFFæ—¥æœŸ,å°‡æ•¸,æ±éŒ¢,ç©å®¶,é‡‘é¡\n";
            localRecords.forEach(rec => {
                rec.details.forEach(p => {
                    csv += `${rec.date},${rec.jiangCount || 0},${rec.dongQian || 0},${p.name},${p.score}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `éº»å°‡_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function backupData() {
            const jsonStr = JSON.stringify(localRecords, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `éº»å°‡å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
        }
    </script>
</body>
</html>
