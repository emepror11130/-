<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ€„ é›€ç¥é›²ç«¯è¨˜å¸³ - å°Šçµ•ç‰ˆ</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* === ğŸ¨ æ–°ç‰ˆé…è‰²å®šç¾© (Dark Luxury Theme) === */
        :root { 
            --bg-dark-1: #0f172a; /* æ·±åˆå¤œè— */
            --bg-dark-2: #1e293b; /* ç¨äº®çš„è—ç° */
            --accent-gold: #d4af37; /* å¤éŠ…é‡‘ (è´å®¶/å¼·èª¿) */
            --accent-jade: #2dd4bf; /* é’ç‰ç¶  (è¼¸å®¶/æ¬¡è¦) */
            --text-light: #e2e8f0; /* ä¸»è¦æ·ºè‰²æ–‡å­— */
            --text-dim: #94a3b8;   /* æ¬¡è¦ç°è‰²æ–‡å­— */
            
            /* æ·±è‰²æ¯›ç»ç’ƒ */
            --card-glass-dark: rgba(30, 41, 59, 0.75);
            --border-glass: rgba(255, 255, 255, 0.1);
            --shadow-premium: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            color: var(--text-light);
            margin: 0; 
            padding: 12px; 
            padding-bottom: 90px; 
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            background-color: var(--bg-dark-1); /* é è¨­åº•è‰² */
        }

        /* === ğŸ€„ èƒŒæ™¯ç¾è¡“å·¥ç¨‹ (é«˜ç´šæ„Ÿ) === */
        .mahjong-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: -2;
            /* 1. æ·±è—æ¼¸å±¤åº• */
            background: radial-gradient(circle at 50% 0%, #2c3e50 0%, var(--bg-dark-1) 80%);
        }
        /* 2. æ±æ–¹æ ¼ç´‹ç–ŠåŠ å±¤ (å¢åŠ ç´°ç¯€è³ªæ„Ÿ) */
        .mahjong-bg::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-rule='evenodd'%3E%3Cpath d='M0 0h40v40H0V0zm20 20h20v20H20V20zM0 20h20v20H0V20zm20 0V0h20v20H20z' fill-opacity='0.2'/%3E%3Cpath d='M0 0h20v20H0V0zm20 20h20v20H20V20z' fill-opacity='0.1'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* æ¼‚æµ®éº»å°‡ç‰Œå®¹å™¨ */
        .tiles-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: -1; pointer-events: none; overflow: hidden;
        }

        /* éº»å°‡ç‰Œæ¨£å¼ (ç™¼å…‰çš„ç‰çŸ³æ„Ÿ) */
        .bg-tile {
            position: absolute; width: 130px; height: 180px;
            /* æ·±è‰²ç‰çŸ³è³ªæ„Ÿ */
            background: linear-gradient(145deg, rgba(255,255,255,0.15) 0%, rgba(0,0,0,0.05) 100%);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            font-family: 'Ma Shan Zheng', serif; 
            font-size: 100px; opacity: 0.25; 
            text-shadow: 0 0 20px currentColor; /* è‡ªé«”ç™¼å…‰æ•ˆæœ */
        }

        .tile-zhong { color: #ef4444; top: 8%; right: -25px; transform: rotate(20deg) scale(0.9); }
        .tile-fa { color: var(--accent-jade); bottom: 18%; left: -35px; transform: rotate(-15deg) scale(1.0); }
        .tile-bai { 
            top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(10deg) scale(0.7); opacity: 0.15;
        }
        .tile-bai::before { 
            content: ''; display: block; width: 86%; height: 89%; 
            border: 4px solid rgba(255,255,255,0.3); border-radius: 8px; 
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }


        /* === é ‚éƒ¨å°èˆª === */
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px; }
        h1 { 
            margin: 0; font-size: 24px; color: var(--accent-gold); font-weight: 700; 
            text-shadow: 0 2px 10px rgba(212, 175, 55, 0.3); letter-spacing: 1.5px;
        }
        
        .location-badge {
            background: rgba(20, 30, 48, 0.6); color: var(--accent-gold);
            padding: 8px 16px; border-radius: 50px; font-size: 14px; font-weight: 500;
            cursor: pointer; border: 1px solid var(--accent-gold);
            display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .location-badge:hover { background: var(--accent-gold); color: var(--bg-dark-1); }

        #status { text-align: center; font-size: 12px; color: var(--text-dim); margin-bottom: 20px; letter-spacing: 1px; }
        .online-dot { height: 8px; width: 8px; background-color: var(--text-dim); border-radius: 50%; display: inline-block; margin-right: 6px; }
        .connected { background-color: var(--accent-jade); box-shadow: 0 0 10px var(--accent-jade); }

        /* === å¡ç‰‡é€šç”¨æ¨£å¼ (æ·±è‰²æ¯›ç»ç’ƒ) === */
        .card { 
            background: var(--card-glass-dark);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 24px; border-radius: 24px; 
            box-shadow: var(--shadow-premium); 
            margin-bottom: 20px; width: 100%; overflow: hidden; 
            border: 1px solid var(--border-glass);
        }
        
        .card h3 { 
            margin: 0 0 20px 0; padding-bottom: 12px; 
            border-bottom: 1px solid rgba(255,255,255,0.08);
            color: var(--text-light); font-size: 18px; font-weight: 700; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center; 
        }
        .card h3 span { display: flex; align-items: center; gap: 8px; }

        /* === è¼¸å…¥å€å„ªåŒ– === */
        label { color: var(--text-dim) !important; font-weight: 500 !important; letter-spacing: 0.5px; }

        .input-style, .name-select, .score-input, .personal-select, .mem-select { 
            width: 100%; height: 50px; padding: 0 15px; 
            border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; 
            font-size: 16px; 
            background: rgba(255,255,255,0.05); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            color: var(--text-light); 
            transition: all 0.3s ease;
        }
        .input-style:focus, .name-select:focus, .score-input:focus, .personal-select:focus { 
            border-color: var(--accent-gold); background: rgba(255,255,255,0.1); 
            outline: none; box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); 
        }
        
        input[type="date"] { color-scheme: dark; } /* è®“æ—¥æœŸé¸æ“‡å™¨è®Šæ·±è‰² */

        /* ç¾¤çµ„æ¨¡å¼ */
        .group-mode .row-stats { display: flex; gap: 15px; margin-bottom: 25px; }
        .group-mode .player-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .group-mode .score-input { width: 95px; text-align: center; font-weight: bold; font-family: 'Roboto Mono', monospace; font-size: 18px; }
        .row-delete-btn { color: var(--text-dim); opacity: 0.7; }
        .row-delete-btn:hover { color: #ef4444; opacity: 1; }

        .sign-btn { 
            flex: 0 0 46px; height: 46px; border-radius: 12px; border: none; font-size: 24px; font-weight: bold; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .btn-plus { background: rgba(212, 175, 55, 0.15); color: var(--accent-gold); border: 1px solid var(--accent-gold); }
        .btn-minus { background: rgba(45, 212, 191, 0.15); color: var(--accent-jade); border: 1px solid var(--accent-jade); }

        /* === å¿«é€Ÿç™¼è»Š (æ™¶ç‰‡æ¨£å¼) === */
        .quick-scroll-wrapper { gap: 12px; padding-bottom: 10px; }
        .squad-chip {
            background: rgba(255,255,255,0.05);
            color: var(--text-light);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 18px; border-radius: 30px;
            font-size: 13px; font-weight: 500; letter-spacing: 0.5px;
            transition: all 0.3s;
        }
        .squad-chip:active, .squad-chip:hover { 
            background: var(--accent-gold); color: var(--bg-dark-1); border-color: var(--accent-gold); 
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
        }

        /* å¤§ç‰Œç´€éŒ„ */
        .highlight-section { 
            background: linear-gradient(to right, rgba(212, 175, 55, 0.1), rgba(0,0,0,0));
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-left: 4px solid var(--accent-gold);
        }
        .highlight-toggle { color: var(--accent-gold); }

        /* æŒ‰éˆ• (é«˜ç´šæ¼¸å±¤) */
        .action-btn { 
            padding: 16px; 
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b88a00 100%); 
            color: var(--bg-dark-1); font-size: 18px; font-weight: bold; letter-spacing: 1px;
            border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(212, 175, 55, 0.5); 
        }
        .action-btn:active { transform: scale(0.99); box-shadow: 0 5px 15px -5px rgba(212, 175, 55, 0.5); }
        
        .add-player-btn { 
            background: rgba(255,255,255,0.05); color: var(--text-dim);
            border: 1px dashed rgba(255,255,255,0.3);
        }
        .add-player-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

        /* çµ±è¨ˆèˆ‡åˆ—è¡¨ */
        table { margin-top: 10px; }
        th { background-color: rgba(0,0,0,0.2); color: var(--text-dim); font-weight: 500; padding: 12px; letter-spacing: 1px; }
        td { padding: 16px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .win-text { color: var(--accent-gold); font-weight: bold; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        .lose-text { color: var(--accent-jade); font-weight: bold; }
        
        /* æ’åå¾½ç«  (é‡‘å±¬è³ªæ„Ÿ) */
        .rank-badge { line-height: 24px; font-size: 16px; }
        .rank-1 { font-size: 24px; text-shadow: 0 2px 10px rgba(255,215,0,0.5); }
        .rank-2, .rank-3 { font-size: 22px; opacity: 0.9; }
        .rank-other { background: rgba(255,255,255,0.1); color: var(--text-dim); font-size: 12px; }
        .rank-badge.rank-boss { 
            background: var(--accent-gold); color: var(--bg-dark-1); border: none;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.4);
        }

        .dashboard-grid { gap: 15px; margin-bottom: 15px; }
        .dash-box { 
            padding: 20px 15px; border-radius: 20px; 
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
        }
        .dash-label { color: var(--text-dim); letter-spacing: 1px; }
        .dash-value { font-size: 24px; margin-top: 5px; }

        /* æ­·å²ç´€éŒ„åˆ—è¡¨ */
        .history-item { padding: 18px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .history-date { color: var(--text-light); font-size: 15px; letter-spacing: 0.5px; }
        .tag-holiday { background-color: rgba(239, 68, 68, 0.2); color: #fca5a5; border: none; }
        .tag-lunar { background-color: rgba(45, 212, 191, 0.2); color: var(--accent-jade); border: none; }
        .tag-info { background-color: rgba(255,255,255,0.1); color: var(--text-dim); border: none; }
        .tag-highlight { background: linear-gradient(135deg, var(--accent-gold), #b88a00); color: var(--bg-dark-1); box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3); }

        .history-scores { gap: 8px 20px; color: var(--text-dim); font-size: 14px; }
        
        .edit-btn { background: var(--accent-gold); color: var(--bg-dark-1); }
        .delete-btn { background: rgba(255,255,255,0.1); color: var(--text-dim); }
        .editing-mode { border: 2px solid var(--accent-gold); box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); }

        .backup-btn { background: rgba(45, 212, 191, 0.1); border: 1px solid var(--accent-jade); color: var(--accent-jade); }
        
        /* åœ°é»é¸å–® (æ·±è‰²æ¨¡å¼) */
        .location-card { background: var(--bg-dark-2); border: 1px solid var(--border-glass); box-shadow: var(--shadow-premium); color: var(--text-light); }
        .location-item { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.05); }
        .location-item:hover { background: rgba(255,255,255,0.08); border-color: var(--accent-gold); }
        .loc-name-area { color: var(--text-light); }
        .location-group-title { color: var(--accent-gold); border-color: rgba(255,255,255,0.1); }
        .loc-delete { border-color: rgba(255,255,255,0.1); }

        /* å¹´ä»½å¡ç‰‡ (æ·±è‰²) */
        .year-card { background: var(--card-glass-dark); border: 1px solid var(--border-glass); }
        .year-header { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.05); color: var(--text-light); }
        .year-title { color: var(--text-light); }
        .month-list { background: transparent; }
        .month-item { border-color: rgba(255,255,255,0.05); }
        .month-item:hover { background: rgba(255,255,255,0.03); }
        .month-name { color: var(--text-dim); }
        .month-count { background: rgba(255,255,255,0.1); color: var(--text-dim); }

        /* æ’è¡Œæ¦œé¦–åç‰¹æ•ˆ */
        #groupStatsTable tr:first-child td { 
            background: linear-gradient(to right, rgba(212, 175, 55, 0.2), transparent); 
            border-top: 1px solid rgba(212, 175, 55, 0.3); border-bottom: 1px solid rgba(212, 175, 55, 0.3); color: var(--text-light) !important;
        }
        #groupStatsTable tr:first-child td:first-child { border-left: 1px solid rgba(212, 175, 55, 0.3); }
        #groupStatsTable tr:first-child td:last-child { border-right: 1px solid rgba(212, 175, 55, 0.3); }
        
        /* Modal æ·±è‰²åŒ– */
        .player-stats-card { background: var(--bg-dark-2); border: 1px solid var(--border-glass); color: var(--text-light); }
        .player-stats-header { background: rgba(0,0,0,0.3); }
        .player-record-row { border-color: rgba(255,255,255,0.05); }
        .player-record-date { color: var(--text-dim); }
        .player-stats-footer { background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.05); color: var(--text-light); }

        /* æ‰¹æ¬¡å·¥å…·åˆ— */
        .batch-toolbar { background: var(--bg-dark-2); border-top: 1px solid var(--border-glass); }
    </style>
</head>
<body>
    
    <div class="mahjong-bg"></div>
    <div class="tiles-container">
        <div class="bg-tile tile-zhong">ä¸­</div>
        <div class="bg-tile tile-fa">ç™¼</div>
        <div class="bg-tile tile-bai"></div>
    </div>

    <div class="header-nav">
        <h1>ğŸ€„ é›€ç¥æ®¿</h1>
        <div class="location-badge" onclick="showLocationMenu()">
            <span id="currentLocationName">ğŸ“ è•™å„€å®¶</span>
        </div>
    </div>
    
    <div id="status"><span class="online-dot" id="dot"></span><span id="statusText">é€£ç·šä¸­...</span></div>

    <div id="playerStatsModal" onclick="if(event.target.id==='playerStatsModal') closePlayerStats()">
        <div class="player-stats-card">
            <div class="player-stats-header">
                <span id="playerStatsTitle"></span>
                <span class="player-stats-close" onclick="closePlayerStats()">âœ•</span>
            </div>
            <div class="player-stats-body" id="playerStatsList"></div>
            <div class="player-stats-footer" id="playerStatsTotal"></div>
        </div>
    </div>

    <div id="locationModal" class="location-menu" onclick="closeLocationMenu(event)">
        <div class="location-card">
            <h3 style="margin-top:0; border-bottom:none; padding-bottom:5px; color:var(--accent-gold);">åˆ‡æ›å¸³æœ¬</h3>
            <div class="location-group-title">ğŸ  å…¬é–‹æˆ°å ´ (ç„¡éœ€å¯†ç¢¼)</div>
            <div id="publicLocationList"></div>
            <div class="location-group-title">ğŸ”’ ç§äººé‡‘åº« (éœ€å¯†ç¢¼)</div>
            <div id="privateLocationList"></div>
            <div style="display:flex; gap:10px;">
                <div class="location-add" style="flex:1; border-color:var(--accent-gold); color:var(--accent-gold); background:rgba(212,175,55,0.1);" onclick="createNewLocation('personal')">â• æ–°å¢ç§äººé‡‘åº«</div>
            </div>
        </div>
    </div>

    <div id="importModal" class="location-menu" onclick="if(event.target.id==='importModal') document.getElementById('importModal').style.display='none'">
        <div class="location-card">
            <h3 style="margin-top:0; color:var(--accent-gold);">ğŸ“¥ åŒ¯å…¥æ­·å²ç´€éŒ„</h3>
            <p style="font-size:13px; color:var(--text-dim); line-height:1.5;">è«‹å°‡ JSON æ–‡å­—è²¼åœ¨ä¸‹æ–¹æ¡†æ¡†ä¸­ï¼š</p>
            <textarea id="importJsonArea" class="import-textarea" placeholder='[{"date": "2024-01-01", ...}]' style="background:rgba(0,0,0,0.2); color:var(--text-light); border-color:var(--border-glass);"></textarea>
            <button class="action-btn" onclick="processImport()" style="margin-top:15px;">ç¢ºèªåŒ¯å…¥</button>
        </div>
    </div>

    <div class="card" id="inputCard">
        <h3 id="inputTitle"><span>âœï¸ æ–°å¢æˆ°ç¸¾</span></h3>
        <div style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:8px; margin-left:4px;">æ—¥æœŸ</label>
            <input type="date" id="dateInput" class="input-style">
        </div>
        
        <div id="groupInputArea" class="group-mode">
            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom:10px; margin-left:4px; color:var(--accent-gold) !important;">âš¡ å¿«é€Ÿç™¼è»Š (é»æ“Šè‡ªå‹•å¸¶å…¥)</label>
                <div id="quickSquadArea" class="quick-scroll-wrapper"></div>
            </div>

            <div class="row-stats">
                <div class="col-half">
                    <label style="display:block; margin-bottom:8px; margin-left:4px;">å°‡æ•¸</label>
                    <input type="number" id="jiangInput" class="input-style" placeholder="0" value="1" inputmode="numeric">
                </div>
                <div class="col-half">
                    <label style="display:block; margin-bottom:8px; margin-left:4px;">æ±éŒ¢</label>
                    <input type="number" id="dongInput" class="input-style" placeholder="0" value="0" inputmode="numeric">
                </div>
            </div>
            <div id="playersArea"></div>
            <button class="add-player-btn" onclick="addPlayerRow()">â• æ–°å¢é¸æ‰‹</button>
            <div class="highlight-toggle" onclick="toggleHighlightInputs()">âœ¨ ç´€éŒ„æœ¬å ´å¤§ç‰Œ (é¸å¡«) â–¼</div>
            <div id="highlightInputs" class="highlight-inputs">
                <div class="highlight-section">
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;"><label style="font-size:12px;">è´å®¶</label><select id="hlWinnerSelect" class="mem-select"></select></div>
                        <div style="flex:1;"><label style="font-size:12px;">å°æ•¸</label><select id="hlTaiSelect" class="mem-select"></select></div>
                    </div>
                    <div style="margin-top:12px;"><label style="font-size:12px;">ç‰Œå‹</label><select id="hlHandSelect" class="mem-select"></select></div>
                </div>
            </div>
        </div>
        <div id="personalInputArea" class="personal-mode hidden">
            <div class="input-row">
                <label>åœ°é» / å±€å</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <select id="personalLocSelect" class="personal-select" onchange="handlePersonalSelect('Loc')" style="flex:1;"><option value="" disabled selected>è«‹é¸æ“‡åœ°é»...</option></select>
                    <button class="manage-btn" onclick="toggleLocManager()" style="background:rgba(255,255,255,0.1); border-radius:8px; padding:8px;">âš™ï¸</button>
                </div>
                <input type="text" id="personalLocCustom" class="personal-custom" placeholder="è¼¸å…¥æ–°åœ°é»åç¨±" style="margin-top:8px;">
                <div id="manageLocArea" class="manage-area" style="background:rgba(0,0,0,0.2); padding:12px; border-radius:12px; margin-top:10px; border:1px solid var(--border-glass);">
                    <div style="font-size:12px; color:var(--text-dim); margin-bottom:8px; font-weight:bold;">å¸¸ç”¨åœ°é»ç®¡ç† (é»æ“Šâœ•åˆªé™¤):</div>
                    <div id="manageLocList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                </div>
            </div>
            <div class="input-row">
                <label>æ‰“çš„å¤§å° (åº•/å°)</label>
                <select id="personalStakeSelect" class="personal-select" onchange="handlePersonalSelect('Stake')"><option value="" disabled selected>è«‹é¸æ“‡å¤§å°...</option></select>
                <input type="text" id="personalStakeCustom" class="personal-custom" placeholder="è¼¸å…¥å¤§å° (ä¾‹å¦‚: 300/100)" style="margin-top:8px;">
            </div>
            <div class="input-row">
                <label>ç•¶æ—¥è¼¸è´é‡‘é¡ (è´+ / è¼¸-)</label>
                <div style="display:flex; gap:12px; align-items:center;">
                    <button class="sign-btn btn-plus" onclick="togglePersonalSign(this)" id="personalSignBtn">+</button>
                    <input type="number" id="personalScoreInput" class="score-input-large" placeholder="0" inputmode="numeric">
                </div>
            </div>
            <div style="background:rgba(212,175,55,0.05); padding:15px; border-radius:16px; margin-top:20px; border:1px solid rgba(212,175,55,0.2);">
                <label style="color:var(--accent-gold) !important; font-weight:bold; margin-bottom:10px;">âœ¨ é›£å¿˜å›æ†¶ (é¸å¡«)</label>
                <div style="display:flex; gap:10px;"><select id="pHandSelect" class="mem-select" style="flex:2;"></select><select id="pTaiSelect" class="mem-select" style="flex:1;"></select></div>
            </div>
        </div>
        <p id="errorMsg" class="error-msg"></p>
        <button class="action-btn" id="saveBtn" onclick="saveData()">å„²å­˜ç´€éŒ„</button>
        <div id="groupManageControls" style="display:flex; justify-content:space-between; margin-top:15px; align-items:center;">
            <button class="manage-btn" onclick="togglePlayerManager()" style="color:var(--text-dim);">âš™ï¸ ç®¡ç†é¸æ‰‹</button>
            <button class="cancel-btn" id="cancelBtn" onclick="cancelEdit()" style="margin:0; width:auto; padding:8px 16px;">å–æ¶ˆä¿®æ”¹</button>
        </div>
        <div id="personalCancelControls" class="hidden" style="text-align:right; margin-top:15px;">
             <button class="cancel-btn" id="cancelBtnPersonal" onclick="cancelEdit()" style="margin:0; display:inline-block; width:auto; padding:8px 16px;">å–æ¶ˆä¿®æ”¹</button>
        </div>
        <div id="manageArea" class="manage-area">
            <div style="font-size:12px; color:var(--text-dim); margin-bottom:8px; text-align:center;">é»æ“Š âœ• å¯åˆªé™¤é¸æ‰‹ (éœ€å¯†ç¢¼é©—è­‰)</div>
            <div id="manageList" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;"></div>
        </div>
    </div>

    <div class="card" id="statsCard">
        <h3 id="statsTitle"><span>ğŸ† è‹±é›„æ¦œ</span></h3>
        <table id="groupStatsTable">
            <thead><tr><th width="15%">#</th><th width="40%">å§“å</th><th width="45%">ç´¯ç©</th></tr></thead>
            <tbody id="summaryBody"><tr><td colspan="3" style="color:var(--text-dim);">è¼‰å…¥ä¸­...</td></tr></tbody>
        </table>
        <div id="personalStatsView" class="hidden">
            <div class="dashboard-grid">
                <div class="dash-box">
                    <div class="dash-label">ç”Ÿæ¶¯ç¸½æç›Š</div>
                    <div class="dash-value" id="personalTotalScore" style="color: var(--accent-gold);">$0</div>
                </div>
                <div class="dash-box">
                    <div class="dash-label">ç¸½å ´æ¬¡</div>
                    <div class="dash-value" id="personalTotalCount" style="color: var(--text-light);">0</div>
                </div>
            </div>
            <div class="card" style="margin-top: 15px; padding: 0; overflow: hidden; border:none; box-shadow:none; background:transparent;">
                <h4 style="margin:0; padding:12px 15px; background:rgba(0,0,0,0.2); border-bottom:1px solid rgba(255,255,255,0.05); font-size:14px; color:var(--text-dim);">ğŸ“ å„åœ°æˆ°æ³</h4>
                <div id="personalLocationStats"></div>
            </div>
        </div>
    </div>

    <div class="card" id="groupDetailStats">
        <h3><span>ğŸ“Š çµ±è¨ˆæ•¸æ“š</span></h3>
        <div class="dashboard-grid">
            <div class="dash-box">
                <div class="dash-label">æ­·å²ç¸½å°‡æ•¸</div>
                <div class="dash-value" style="color: var(--accent-jade);" id="grandTotalJiang">0</div>
            </div>
            <div class="dash-box">
                <div class="dash-label">æ­·å²ç¸½æ±éŒ¢</div>
                <div class="dash-value" style="color: var(--accent-gold);" id="grandTotalDong">$0</div>
            </div>
        </div>
        <div style="margin-top:12px; padding:15px; background:rgba(212,175,55,0.05); border:1px solid rgba(212,175,55,0.2); border-radius:16px; display:flex; align-items:center; justify-content:center; gap:10px;">
            <span style="font-size:13px; color:var(--text-light);">ğŸ”¥ å–®å ´æœ€å¤§å°ï¼š</span>
            <span id="maxTaiRecord" style="font-weight:bold; color:var(--accent-gold); font-size:15px; text-shadow:0 0 10px rgba(212,175,55,0.3);">ç„¡ç´€éŒ„</span>
        </div>
        <table class="normal-table" style="margin-top:20px;">
            <thead><tr><th>æœˆä»½</th><th>å ´æ¬¡</th><th>æ±éŒ¢</th></tr></thead>
            <tbody id="monthlyStatsBody"><tr><td colspan="3" style="color:var(--text-dim);">è¨ˆç®—ä¸­...</td></tr></tbody>
        </table>
        <div id="yearlyStatsFoot" style="text-align:center; margin-top:15px; font-weight:bold; color:var(--accent-jade); font-size: 13px; opacity:0.8;"></div>
    </div>
    
    <div class="card" id="personalMonthlyStats" class="hidden" style="background:transparent; box-shadow:none; padding:0; border:none;">
        <div id="personalYearlyContainer"></div>
    </div>

    <div class="card">
        <h3>
            <span>ğŸ“œ ç´€éŒ„</span>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="filterYear" style="border:1px solid var(--border-glass); background:rgba(0,0,0,0.2); color:var(--text-light); padding:6px 10px; border-radius:10px; font-size:13px; outline:none;" onchange="handleYearFilter()">
                    <option value="ALL">å…¨éƒ¨å¹´ä»½</option>
                </select>
                <input type="month" id="filterMonth" style="border:1px solid var(--border-glass); background:rgba(0,0,0,0.2); color:var(--text-light); padding:4px 10px; border-radius:10px; font-size:13px; outline:none;" onchange="handleMonthFilter()">
            </div>
        </h3>
        <div style="display:flex; justify-content:flex-end; margin-bottom:15px; gap:10px; flex-wrap:wrap;">
            <button class="backup-btn" onclick="toggleBatchMode()" style="color:#ef4444; border-color:#ef4444;">ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤</button>
            <button class="backup-btn" onclick="showImportModal()">ğŸ“¥ åŒ¯å…¥</button>
            <button class="backup-btn" onclick="backupData()">ğŸ’¾ å‚™ä»½</button>
            <button onclick="exportCSV()" style="background:rgba(45,212,191,0.1); border:1px solid var(--accent-jade); color:var(--accent-jade); border-radius:20px; padding:6px 12px; font-size:12px; cursor:pointer; font-weight:600;">ğŸ“¥ Excel</button>
        </div>
        <div id="historyList"></div>
    </div>

    <div id="batchToolbar" class="batch-toolbar hidden">
        <button class="batch-action-btn" style="background:var(--accent-jade); color:var(--bg-dark-1);" onclick="toggleSelectAll()">âœ… å…¨é¸</button>
        <button class="batch-action-btn" style="background:#ef4444; color:white;" onclick="deleteBatch()">ğŸ—‘ï¸ åˆªé™¤</button>
        <button class="batch-action-btn" style="background:var(--text-dim); color:var(--bg-dark-1);" onclick="toggleBatchMode()">âŒ å–æ¶ˆ</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBuqMMuRwgysCZrSJagYmZLd2OOciJC1Rc",
            authDomain: "mahjong-app-d6267.firebaseapp.com",
            projectId: "mahjong-app-d6267",
            storageBucket: "mahjong-app-d6267.firebasestorage.app",
            messagingSenderId: "1083238926870",
            appId: "1:1083238926870:web:f1ffe3b5eadf959bcd8337",
            measurementId: "G-H7T8N8YCG1"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentLocId = 'default'; 
        let currentLocType = 'group'; 
        let recordsRef, playersRef, settingsRef;
        let localRecords = [];
        let displayRecords = []; 
        let currentEditId = null;
        let publicLocationNames = ["è•™å„€å®¶"]; 
        let publicLocationsMeta = {};
        let myLocations = [];
        let myStakes = ["50/20", "100/20"];
        let isBatchMode = false;

        const SAFETY_PASSWORD = "8888"; 
        const DEFAULT_PLAYERS = ["å®¥è¾°", "å¤ç‘‹", "è•™å„€", "H", "ç››å®‰", "ä¸€ä¸­"];
        const PRESET_SQUADS = [
            { name: "å¤ç‘‹ / å®¥è¾° / è•™å„€ / ç››å®‰", players: ["å¤ç‘‹", "å®¥è¾°", "è•™å„€", "ç››å®‰"] },
            { name: "å¤ç‘‹ / å®¥è¾° / è•™å„€ / H", players: ["å¤ç‘‹", "å®¥è¾°", "è•™å„€", "H"] },
            { name: "å¤ç‘‹ / è•™å„€ / H / ä¸€ä¸­", players: ["å¤ç‘‹", "è•™å„€", "H", "ä¸€ä¸­"] }
        ];
        const HAND_TYPES = ["å¹³èƒ¡", "ç¢°ç¢°èƒ¡", "æ··ä¸€è‰²", "æ¸…ä¸€è‰²", "ä¸‰æš—åˆ»", "å››æš—åˆ»", "äº”æš—åˆ»", "é–€æ¸…è‡ªæ‘¸", "å…¨æ±‚äºº", "å¤§ä¸‰å…ƒ", "å°ä¸‰å…ƒ", "å¤§å››å–œ", "å°å››å–œ", "å­—ä¸€è‰²", "ä¸ƒæ¶ä¸€", "å…«ä»™éæµ·", "å¤©èƒ¡", "åœ°èƒ¡", "äººèƒ¡", "æµå±€"];
        let allPlayers = [...DEFAULT_PLAYERS];

        const savedLocId = localStorage.getItem('mj_last_loc_id');
        const savedLocName = localStorage.getItem('mj_last_loc_name');
        const savedLocType = localStorage.getItem('mj_last_loc_type');

        if (savedLocId && savedLocName && savedLocType) {
            initLocation(savedLocId, savedLocName, savedLocType);
        } else {
            initLocation('default', 'è•™å„€å®¶', 'group');
        }
        
        initSelectOptions(); 
        initQuickSquads();
        renderLocationList();

        db.ref('.info/connected').on('value', function(snap) {
            const statusText = document.getElementById('statusText');
            const dot = document.getElementById('dot');
            if (snap.val() === true) {
                statusText.innerText = "å·²é€£ç·š"; dot.classList.add('connected');
            } else {
                statusText.innerText = "é€£ç·šä¸­..."; dot.classList.remove('connected');
            }
        });

        function initSelectOptions() {
            let handHtml = '<option value="">é¸æ“‡ç‰Œå‹ (é¸å¡«)</option>';
            HAND_TYPES.forEach(h => handHtml += `<option value="${h}">${h}</option>`);
            document.getElementById('hlHandSelect').innerHTML = handHtml;
            document.getElementById('pHandSelect').innerHTML = handHtml;

            let taiHtml = '<option value="">å°æ•¸ (é¸å¡«)</option>';
            for(let i=1; i<=30; i++) taiHtml += `<option value="${i}">${i}å°</option>`;
            document.getElementById('hlTaiSelect').innerHTML = taiHtml;
            document.getElementById('pTaiSelect').innerHTML = taiHtml;
        }

        function initQuickSquads() {
            const container = document.getElementById('quickSquadArea');
            let html = '';
            PRESET_SQUADS.forEach((squad, index) => {
                html += `<div class="squad-chip" onclick="applyQuickSquad(${index})">${squad.name}</div>`;
            });
            container.innerHTML = html;
        }

        function applyQuickSquad(index) {
            const squad = PRESET_SQUADS[index];
            const container = document.getElementById('playersArea');
            container.innerHTML = ''; 

            squad.players.forEach(name => {
                addPlayerRow(name); 
            });
            
            while(container.children.length < 4) {
                addPlayerRow();
            }
        }

        function initLocation(id, name, type) {
            if (recordsRef) recordsRef.off();
            if (playersRef) playersRef.off();
            if (settingsRef) settingsRef.off();

            currentLocId = id;
            currentLocType = type;
            document.getElementById('currentLocationName').innerText = `ğŸ“ ${name}`;

            let pathPrefix = id === 'default' ? '' : `locations/${id}/`;
            recordsRef = db.ref(pathPrefix + 'records');
            
            const groupArea = document.getElementById('groupInputArea');
            const personalArea = document.getElementById('personalInputArea');
            const groupStats = document.getElementById('groupStatsTable');
            const personalStats = document.getElementById('personalStatsView');
            const groupDetailStats = document.getElementById('groupDetailStats');
            const personalMonthlyStats = document.getElementById('personalMonthlyStats'); 
            const groupManageCtrl = document.getElementById('groupManageControls');
            const personalCancelCtrl = document.getElementById('personalCancelControls');

            if (type === 'group') {
                playersRef = db.ref(pathPrefix + 'players');
                setupGroupListeners();
                
                groupArea.classList.remove('hidden');
                personalArea.classList.add('hidden');
                groupStats.classList.remove('hidden');
                personalStats.classList.add('hidden');
                groupDetailStats.classList.remove('hidden'); 
                personalMonthlyStats.classList.add('hidden'); 
                groupManageCtrl.style.display = 'flex';
                personalCancelCtrl.classList.add('hidden');
                document.getElementById('statsTitle').innerHTML = "<span>ğŸ† è‹±é›„æ¦œ</span>";
                
                initPlayerInputs(); 
            } else {
                settingsRef = db.ref(pathPrefix + 'settings');
                setupPersonalListeners();
                
                groupArea.classList.add('hidden');
                personalArea.classList.remove('hidden');
                groupStats.classList.add('hidden');
                personalStats.classList.remove('hidden');
                groupDetailStats.classList.add('hidden'); 
                personalMonthlyStats.classList.remove('hidden'); 
                groupManageCtrl.style.display = 'none';
                personalCancelCtrl.classList.remove('hidden');
                document.getElementById('statsTitle').innerHTML = "<span>ğŸ’° æˆ‘çš„é‡‘åº«</span>";
                
                updatePersonalSelects();
            }
            cancelEdit();
            isBatchMode = false; 
            document.getElementById('batchToolbar').classList.add('hidden');
        }

        function setupGroupListeners() {
            playersRef.on('value', (snap) => {
                const data = snap.val();
                if (data) {
                    const cloudPlayers = Object.keys(data);
                    const newPlayers = cloudPlayers.filter(p => !DEFAULT_PLAYERS.includes(p));
                    let sortedPlayers = [];
                    DEFAULT_PLAYERS.forEach(p => { if (cloudPlayers.includes(p)) sortedPlayers.push(p); });
                    cloudPlayers.forEach(p => { if (!sortedPlayers.includes(p)) sortedPlayers.push(p); });
                    allPlayers = sortedPlayers;
                } else {
                    let updates = {};
                    DEFAULT_PLAYERS.forEach(n => updates[n] = true);
                    playersRef.update(updates);
                    allPlayers = DEFAULT_PLAYERS;
                }
                updateAllPlayerSelects(); 
                renderManageList(); 
            });
            listenToRecords();
        }

        function setupPersonalListeners() {
            listenToRecords();
            settingsRef.on('value', snap => {
                const data = snap.val() || {};
                if (data.myLocations) myLocations = Object.keys(data.myLocations); else myLocations = [];
                if (data.myStakes) myStakes = Object.keys(data.myStakes); else myStakes = ["50/20", "100/20"];
                updatePersonalSelects();
                renderManageLocList(); 
            });
        }

        function updatePersonalSelects() {
            const locSelect = document.getElementById('personalLocSelect');
            const stakeSelect = document.getElementById('personalStakeSelect');
            let locHtml = `<option value="" disabled selected>è«‹é¸æ“‡åœ°é»...</option>`;
            publicLocationNames.forEach(name => { locHtml += `<option value="${name}">ğŸ  ${name}</option>`; });
            myLocations.forEach(name => { if (!publicLocationNames.includes(name)) { locHtml += `<option value="${name}">ğŸ“ ${name}</option>`; } });
            locHtml += `<option value="CUSTOM" style="color:var(--accent-gold);">âœï¸ è‡ªè¨‚åœ°é»...</option>`;
            locSelect.innerHTML = locHtml;
            let stakeHtml = `<option value="" disabled selected>è«‹é¸æ“‡å¤§å°...</option>`;
            myStakes.forEach(s => { stakeHtml += `<option value="${s}">${s}</option>`; });
            stakeHtml += `<option value="CUSTOM" style="color:var(--accent-gold);">âœï¸ è‡ªè¨‚å¤§å°...</option>`;
            stakeSelect.innerHTML = stakeHtml;
        }

        function handlePersonalSelect(type) {
            const select = document.getElementById(`personal${type}Select`);
            const customInput = document.getElementById(`personal${type}Custom`);
            if (select.value === 'CUSTOM') { select.style.display = 'none'; customInput.style.display = 'block'; customInput.focus(); customInput.value = ''; }
            else { select.style.display = 'block'; customInput.style.display = 'none'; }
        }

        function listenToRecords() {
            recordsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                localRecords = [];
                if (data) {
                    Object.keys(data).forEach(key => { localRecords.push({ id: key, ...data[key] }); });
                    localRecords.sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateB - dateA || b.timestamp - a.timestamp;
                    });
                }
                updateYearFilter(); 
                render();
            });
        }

        function updateYearFilter() {
            const yearSelect = document.getElementById('filterYear');
            const currentVal = yearSelect.value;
            let years = new Set();
            localRecords.forEach(r => years.add(r.date.substring(0, 4)));
            let sortedYears = Array.from(years).sort().reverse();
            
            let html = '<option value="ALL">å…¨éƒ¨å¹´ä»½</option>';
            sortedYears.forEach(y => html += `<option value="${y}">${y}å¹´</option>`);
            yearSelect.innerHTML = html;
            
            if(sortedYears.includes(currentVal)) yearSelect.value = currentVal;
        }

        function handleYearFilter() {
            document.getElementById('filterMonth').value = ''; 
            render();
        }

        function handleMonthFilter() {
            document.getElementById('filterYear').value = 'ALL'; 
            render();
        }

        function toggleHighlightInputs() {
            const el = document.getElementById('highlightInputs');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
            if(el.style.display === 'block') {
                const rows = document.querySelectorAll('.player-row .name-select');
                const winnerSelect = document.getElementById('hlWinnerSelect');
                let html = '<option value="">è«‹é¸æ“‡è´å®¶</option>';
                rows.forEach(r => {
                    const name = r.value !== 'Other' && r.value !== 'ADD_NEW' ? r.value : r.parentElement.querySelector('.custom-name').value;
                    if(name) html += `<option value="${name}">${name}</option>`;
                });
                winnerSelect.innerHTML = html;
            }
        }

        function toggleLocManager() {
            const area = document.getElementById('manageLocArea');
            area.style.display = area.style.display === 'block' ? 'none' : 'block';
        }

        function renderManageLocList() {
            const list = document.getElementById('manageLocList');
            list.innerHTML = '';
            Object.keys(publicLocationsMeta).forEach(key => {
                const loc = publicLocationsMeta[key];
                if (key !== 'default') { 
                    list.innerHTML += `<div class="player-tag" style="border-color:var(--accent-gold); color:var(--accent-gold);">ğŸ  ${loc.name} <span class="player-delete" onclick="deleteLocation('${key}', '${loc.name}', '${loc.password}')">âœ•</span></div>`;
                }
            });
            myLocations.forEach(name => {
                list.innerHTML += `<div class="player-tag">ğŸ“ ${name} <span class="player-delete" onclick="deleteCustomLocation('${name}')">âœ•</span></div>`;
            });
        }

        function deleteCustomLocation(name) {
            if (confirm(`ç¢ºå®šè¦å¾é¸å–®ç§»é™¤ã€Œ${name}ã€å—ï¼Ÿ`)) { settingsRef.child('myLocations/' + name).remove(); }
        }

        function showLocationMenu() { document.getElementById('locationModal').style.display = 'flex'; renderLocationList(); }
        function closeLocationMenu(e) { if (e.target.id === 'locationModal') document.getElementById('locationModal').style.display = 'none'; }

        function renderLocationList() {
            const publicList = document.getElementById('publicLocationList');
            const privateList = document.getElementById('privateLocationList');
            publicList.innerHTML = `<div class="location-item"><div class="loc-name-area" onclick="switchLocation('default', 'è•™å„€å®¶', 'group')"><span>ğŸ  è•™å„€å®¶ (é è¨­)</span> ${currentLocId === 'default' ? 'âœ…' : ''}</div></div>`;
            privateList.innerHTML = '';
            publicLocationNames = ["è•™å„€å®¶"]; publicLocationsMeta = {}; 

            db.ref('locations_meta').once('value', snap => {
                const data = snap.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        const loc = data[key];
                        const type = loc.type || 'group'; 
                        if (type === 'group') { publicLocationNames.push(loc.name); publicLocationsMeta[key] = loc; }
                        const icon = type === 'group' ? 'ğŸ ' : 'ğŸ”’';
                        const check = currentLocId === key ? 'âœ…' : '';
                        const html = `<div class="location-item"><div class="loc-name-area" onclick="verifyAndSwitch('${key}', '${loc.name}', '${loc.password}', '${type}')"><span>${icon} ${loc.name}</span> ${check}</div><div class="loc-delete" onclick="deleteLocation('${key}', '${loc.name}', '${loc.password}')">âœ•</div></div>`;
                        if (type === 'group') { publicList.innerHTML += html; } else { privateList.innerHTML += html; }
                    });
                }
                if (privateList.innerHTML === '') privateList.innerHTML = '<div style="padding:10px; color:var(--text-dim); font-size:13px; text-align:center;">å°šç„¡ç§äººé‡‘åº«</div>';
                if (currentLocType === 'personal') { updatePersonalSelects(); renderManageLocList(); }
            });
        }

        function createNewLocation(type) {
            const name = prompt(type === 'group' ? "è«‹è¼¸å…¥æ–°æˆ°å ´åç¨±" : "è«‹è¼¸å…¥æ–°é‡‘åº«åç¨±");
            if (!name) return;
            const password = prompt("è«‹è¨­å®šé€²å…¥èˆ‡åˆªé™¤å¯†ç¢¼ï¼š");
            if (!password) return;
            const newId = 'loc_' + Date.now();
            db.ref('locations_meta/' + newId).set({ name: name, password: password, type: type }).then(() => { alert("âœ… å»ºç«‹æˆåŠŸï¼"); renderLocationList(); });
        }

        function deleteLocation(id, name, password) {
            const input = prompt(`âš ï¸ ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ\nè«‹è¼¸å…¥ç•¶åˆè¨­å®šçš„å¯†ç¢¼ä»¥ç¢ºèªï¼š`);
            if (input === password) {
                db.ref('locations_meta/' + id).remove(); db.ref('locations/' + id).remove(); alert("ğŸ—‘ï¸ å·²åˆªé™¤");
                if (currentLocId === id) switchLocation('default', 'è•™å„€å®¶', 'group'); else renderLocationList();
            } else { if(input !== null) alert("âŒ å¯†ç¢¼éŒ¯èª¤"); }
        }

        function verifyAndSwitch(id, name, password, type) {
            if (currentLocId === id) { document.getElementById('locationModal').style.display = 'none'; return; }
            if (type === 'group') { switchLocation(id, name, type); } 
            else {
                const input = prompt(`è«‹è¼¸å…¥ã€Œ${name}ã€çš„å¯†ç¢¼ï¼š`);
                if (input === password) { switchLocation(id, name, type); } else { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); }
            }
        }

        function switchLocation(id, name, type) {
            localStorage.setItem('mj_last_loc_id', id);
            localStorage.setItem('mj_last_loc_name', name);
            localStorage.setItem('mj_last_loc_type', type);
            initLocation(id, name, type); document.getElementById('locationModal').style.display = 'none';
        }

        document.getElementById('dateInput').valueAsDate = new Date();
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        // document.getElementById('filterMonth').value = `${year}-${month}`; // ç§»é™¤ï¼Œé è¨­å…¨éƒ¨

        function initPlayerInputs() {
            const container = document.getElementById('playersArea');
            container.innerHTML = '';
            for (let i = 1; i <= 4; i++) {
                addPlayerRow();
            }
        }

        function addPlayerRow(name = "", score = "") {
            const container = document.getElementById('playersArea');
            const div = document.createElement('div');
            div.className = 'player-row';
            
            let optionsHtml = `<option value="" disabled selected>è«‹é¸æ“‡é¸æ‰‹...</option>`;
            allPlayers.forEach(p => { 
                const selected = p === name ? 'selected' : '';
                optionsHtml += `<option value="${p}" ${selected}>${p}</option>`; 
            });
            optionsHtml += `<option value="ADD_NEW" style="color:var(--accent-gold); font-weight:bold;">â• æ–°å¢å›ºå®šç‰Œå‹...</option>`;
            optionsHtml += `<option value="Other" style="color:var(--accent-jade);">âœï¸ å–®æ¬¡è‡ªè¨‚...</option>`;

            let nameInputHtml = `
                <div class="name-wrapper" style="flex:1;">
                    <select class="name-select" onchange="handleNameChange(this)">${optionsHtml}</select>
                    <input type="text" class="custom-name" placeholder="è¼¸å…¥åå­—" style="display:none; width:100%; height:50px; border-radius:12px; border:1px solid var(--border-glass); padding:0 15px; background:rgba(255,255,255,0.05); color:var(--text-light);" value="${name}">
                </div>
            `;
            
            if (name && !allPlayers.includes(name)) {
                 nameInputHtml = nameInputHtml.replace('style="display:none;"', '').replace('class="name-select"', 'class="name-select" style="display:none;"');
            }

            const sign = score < 0 ? '-' : '+';
            const absScore = score ? Math.abs(score) : '';
            const btnClass = score < 0 ? 'sign-btn btn-minus' : 'sign-btn btn-plus';

            div.innerHTML = `
                ${nameInputHtml}
                <button class="${btnClass}" onclick="toggleSign(this)">${sign}</button>
                <input type="number" class="score-input" placeholder="0" inputmode="numeric" value="${absScore}">
                <div class="row-delete-btn" onclick="removePlayerRow(this)">âœ•</div>
            `;
            container.appendChild(div);
        }

        function removePlayerRow(btn) {
            btn.parentElement.remove();
        }

        function updateAllPlayerSelects() {
            if (currentLocType !== 'group') return;
            let optionsHtml = `<option value="" disabled selected>è«‹é¸æ“‡é¸æ‰‹...</option>`;
            allPlayers.forEach(name => { optionsHtml += `<option value="${name}">${name}</option>`; });
            optionsHtml += `<option value="ADD_NEW" style="color:var(--accent-gold); font-weight:bold;">â• æ–°å¢å›ºå®šç‰Œå‹...</option>`;
            optionsHtml += `<option value="Other" style="color:var(--accent-jade);">âœï¸ å–®æ¬¡è‡ªè¨‚...</option>`;
            document.querySelectorAll('.name-select').forEach(select => {
                const currentVal = select.value;
                select.innerHTML = optionsHtml;
                if (currentVal) select.value = currentVal;
            });
        }

        function togglePlayerManager() {
            const area = document.getElementById('manageArea');
            if (area.style.display === 'block') { area.style.display = 'none'; }
            else { if (checkPassword()) { area.style.display = 'block'; renderManageList(); } else { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); } }
        }

        function renderManageList() {
            const list = document.getElementById('manageList');
            list.innerHTML = '';
            allPlayers.forEach(name => { list.innerHTML += `<div class="player-tag">${name} <span class="player-delete" onclick="deletePlayerFromList('${name}')">âœ•</span></div>`; });
        }

        function deletePlayerFromList(name) { if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) { playersRef.child(name).remove(); } }

        function handleNameChange(select) {
            const wrapper = select.parentElement; const custom = wrapper.querySelector('.custom-name'); const val = select.value;
            if (val === 'Other') { select.style.display = 'none'; custom.style.display = 'block'; custom.focus(); }
            else if (val === 'ADD_NEW') {
                const newName = prompt("è«‹è¼¸å…¥æ–°ç‰Œå‹çš„åå­—ï¼š");
                if (newName && newName.trim() !== "") { playersRef.child(newName.trim()).set(true).then(() => { setTimeout(() => { select.value = newName.trim(); }, 100); }); } else { select.value = ""; }
            } else { custom.style.display = 'none'; select.style.display = 'block'; custom.value = ''; }
        }

        function toggleSign(btn) { if (btn.innerText === '+') { btn.innerText = '-'; btn.className = 'sign-btn btn-minus'; } else { btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; } }
        function togglePersonalSign(btn) { if (btn.innerText === '+') { btn.innerText = '-'; btn.className = 'sign-btn btn-minus'; } else { btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; } }
        function checkPassword() { return prompt("è«‹è¼¸å…¥å®‰å…¨å¯†ç¢¼ (é è¨­ 8888)ï¼š") === SAFETY_PASSWORD; }
        function showError(msg) { const el = document.getElementById('errorMsg'); el.innerText = msg; el.style.display = msg ? 'block' : 'none'; }
        
        function getHolidayTag(dateStr) {
            try {
                const dateParts = dateStr.split('-'); const y = parseInt(dateParts[0]); const m = parseInt(dateParts[1]); const d = parseInt(dateParts[2]);
                if (m === 2 && d === 14) return '<span class="history-tag tag-holiday">ğŸ’˜ æƒ…äººç¯€</span>';
                if (m === 1 && d === 1) return '<span class="history-tag tag-holiday">ğŸ‰ å…ƒæ—¦</span>';
                const lunar = Lunar.fromDate(new Date(y, m - 1, d)); const lMonth = lunar.getMonth(); const lDay = lunar.getDay();
                if (lMonth === 1 && lDay === 1) return '<span class="history-tag tag-holiday">ğŸ§§ æ˜¥ç¯€</span>';
                if (lMonth === 1 && lDay === 15) return '<span class="history-tag tag-holiday">ğŸ® å…ƒå®µ</span>';
                if (lMonth === 5 && lDay === 5) return '<span class="history-tag tag-holiday">ğŸ‰ ç«¯åˆ</span>';
                if (lMonth === 8 && lDay === 15) return '<span class="history-tag tag-holiday">ğŸ¥® ä¸­ç§‹</span>';
                if (lDay === 1) return '<span class="history-tag tag-lunar">ğŸŒ‘ åˆä¸€</span>';
                if (lDay === 15) return '<span class="history-tag tag-lunar">ğŸŒ• åäº”</span>';
                return '';
            } catch (e) { return ''; }
        }

        function saveData() {
            if (currentEditId && currentLocType === 'group') { if (!checkPassword()) { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); return; } }
            const date = document.getElementById('dateInput').value;
            let recordData = { date: date, timestamp: Date.now() };

            if (currentLocType === 'group') {
                const jiangCount = parseInt(document.getElementById('jiangInput').value) || 0;
                const dongQian = parseInt(document.getElementById('dongInput').value) || 0;
                const rows = document.querySelectorAll('.player-row');
                let currentEntry = []; let totalScore = 0; let namesCheck = new Set();
                
                for (let row of rows) {
                    const select = row.querySelector('.name-select'); 
                    const customInput = row.querySelector('.custom-name'); 
                    const signBtn = row.querySelector('.sign-btn'); 
                    const scoreInput = row.querySelector('.score-input');
                    
                    let name = select.style.display !== 'none' ? select.value : customInput.value.trim();
                    if (name === "ADD_NEW") name = ""; 
                    if (!name) { showError("âš ï¸ è«‹è¼¸å…¥/é¸æ“‡é¸æ‰‹"); return; }
                    if (namesCheck.has(name)) { showError(`âš ï¸ åå­—é‡è¤‡ï¼š${name}`); return; } namesCheck.add(name);
                    
                    let rawScore = parseInt(scoreInput.value); 
                    if (isNaN(rawScore)) { showError(`âš ï¸ è«‹è¼¸å…¥é‡‘é¡`); return; }
                    let finalScore = Math.abs(rawScore) * (signBtn.innerText === '+' ? 1 : -1);
                    
                    currentEntry.push({ name: name, score: finalScore }); 
                    totalScore += finalScore;
                }
                
                if (totalScore + dongQian !== 0) { 
                    showError(`âš ï¸ å¸³ç›®ä¸å¹³ï¼ç©å®¶ç¸½å’Œ(${totalScore}) + æ±éŒ¢(${dongQian}) â‰  0 (å·®é¡: ${totalScore + dongQian})`); 
                    return; 
                }

                const hlWinner = document.getElementById('hlWinnerSelect').value;
                const hlHand = document.getElementById('hlHandSelect').value;
                const hlTai = document.getElementById('hlTaiSelect').value;
                if (hlWinner && hlHand) { recordData.highlight = { player: hlWinner, hand: hlHand, tai: parseInt(hlTai) || 0 }; }
                recordData.jiangCount = jiangCount; recordData.dongQian = dongQian; recordData.details = currentEntry;
            } else {
                const locSelect = document.getElementById('personalLocSelect'); const locCustom = document.getElementById('personalLocCustom');
                const stakeSelect = document.getElementById('personalStakeSelect'); const stakeCustom = document.getElementById('personalStakeCustom');
                let loc = locSelect.style.display !== 'none' ? locSelect.value : locCustom.value.trim();
                let stake = stakeSelect.style.display !== 'none' ? stakeSelect.value : stakeCustom.value.trim();
                if (!loc || loc === "CUSTOM") { showError("âš ï¸ è«‹è¼¸å…¥åœ°é»"); return; }
                const scoreInput = document.getElementById('personalScoreInput'); const score = parseInt(scoreInput.value); const signBtn = document.getElementById('personalSignBtn');
                if (isNaN(score)) { showError("âš ï¸ è«‹è¼¸å…¥é‡‘é¡"); return; }
                let finalScore = Math.abs(score) * (signBtn.innerText === '+' ? 1 : -1);
                const pHand = document.getElementById('pHandSelect').value;
                const pTai = document.getElementById('pTaiSelect').value;
                if (pHand) recordData.highlight = { hand: pHand, tai: parseInt(pTai) || 0 };
                recordData.location = loc; recordData.score = finalScore; recordData.note = stake;
                if (locSelect.style.display === 'none' && !myLocations.includes(loc)) settingsRef.child('myLocations/' + loc).set(true);
                if (stakeSelect.style.display === 'none' && stake && !myStakes.includes(stake)) settingsRef.child('myStakes/' + stake).set(true);
            }

            if (currentEditId) { recordsRef.child(currentEditId).update(recordData).then(() => { alert("âœ… ä¿®æ”¹æˆåŠŸ"); cancelEdit(); }); }
            else { recordsRef.push(recordData).then(() => { resetForm(); alert("âœ… å„²å­˜æˆåŠŸ"); }); }
        }

        function editRecord(id) {
            const record = localRecords.find(r => r.id === id); if (!record) return;
            document.getElementById('dateInput').value = record.date;
            
            if (currentLocType === 'group') {
                document.getElementById('jiangInput').value = record.jiangCount || 0; 
                document.getElementById('dongInput').value = record.dongQian || 0;
                
                if (record.highlight) {
                    document.getElementById('highlightInputs').style.display = 'block';
                    document.getElementById('hlHandSelect').value = record.highlight.hand;
                    document.getElementById('hlTaiSelect').value = record.highlight.tai;
                }
                
                const container = document.getElementById('playersArea');
                container.innerHTML = ''; 
                record.details.forEach(p => { addPlayerRow(p.name, p.score); });
                while(container.children.length < 4) { addPlayerRow(); }
                toggleHighlightInputs(); 
                if(record.highlight) document.getElementById('hlWinnerSelect').value = record.highlight.player;
            } else {
                const locSelect = document.getElementById('personalLocSelect'); const locCustom = document.getElementById('personalLocCustom');
                const stakeSelect = document.getElementById('personalStakeSelect'); const stakeCustom = document.getElementById('personalStakeCustom');
                let isKnownLoc = false; Array.from(locSelect.options).forEach(opt => { if(opt.value === record.location) isKnownLoc = true; });
                if (isKnownLoc) { locSelect.value = record.location; locSelect.style.display = 'block'; locCustom.style.display = 'none'; }
                else { locSelect.value = 'CUSTOM'; locCustom.value = record.location; locSelect.style.display = 'none'; locCustom.style.display = 'block'; }
                let stakeVal = record.note || ''; let isKnownStake = false; Array.from(stakeSelect.options).forEach(opt => { if(opt.value === stakeVal) isKnownStake = true; });
                if (isKnownStake) { stakeSelect.value = stakeVal; stakeSelect.style.display = 'block'; stakeCustom.style.display = 'none'; }
                else { stakeSelect.value = 'CUSTOM'; stakeCustom.value = stakeVal; stakeSelect.style.display = 'none'; stakeCustom.style.display = 'block'; }
                if (record.highlight) { document.getElementById('pHandSelect').value = record.highlight.hand; document.getElementById('pTaiSelect').value = record.highlight.tai; }
                document.getElementById('personalScoreInput').value = Math.abs(record.score);
                const btn = document.getElementById('personalSignBtn'); btn.innerText = record.score < 0 ? '-' : '+'; btn.className = record.score < 0 ? 'sign-btn btn-minus' : 'sign-btn btn-plus';
            }
            currentEditId = id; document.getElementById('inputCard').classList.add('editing-mode'); document.getElementById('inputTitle').innerText = "âœï¸ ä¿®æ”¹ä¸­..."; document.getElementById('saveBtn').innerText = "ç¢ºèªä¿®æ”¹"; document.getElementById('saveBtn').style.background = "linear-gradient(135deg, var(--accent-gold) 0%, #b88a00 100%)"; document.getElementById('cancelBtn').style.display = "block"; if(currentLocType !== 'group') document.getElementById('cancelBtnPersonal').style.display = "inline-block"; window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRecord(id) {
            if (currentLocType === 'group') { if (!checkPassword()) { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); return; } }
            if(!confirm("âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) return;
            recordsRef.child(id).remove();
            if (currentEditId === id) cancelEdit();
        }

        function cancelEdit() {
            currentEditId = null; document.getElementById('inputCard').classList.remove('editing-mode'); document.getElementById('inputTitle').innerText = "âœï¸ æ–°å¢æˆ°ç¸¾"; document.getElementById('saveBtn').innerText = "å„²å­˜ç´€éŒ„"; document.getElementById('saveBtn').style.background = ""; document.getElementById('cancelBtn').style.display = "none"; document.getElementById('cancelBtnPersonal').style.display = "none"; document.getElementById('manageArea').style.display = 'none'; resetForm();
        }

        function resetForm() {
            if (currentLocType === 'group') {
                initPlayerInputs(); // é‡ç½®ç‚ºé è¨­4äºº
                document.getElementById('dongInput').value = 0; document.getElementById('jiangInput').value = 1;
                document.getElementById('highlightInputs').style.display = 'none';
                document.getElementById('hlHandSelect').value = ''; document.getElementById('hlTaiSelect').value = '';
            } else {
                document.getElementById('personalLocSelect').value = ''; document.getElementById('personalLocSelect').style.display = 'block'; document.getElementById('personalLocCustom').style.display = 'none';
                document.getElementById('personalStakeSelect').value = ''; document.getElementById('personalStakeSelect').style.display = 'block'; document.getElementById('personalStakeCustom').style.display = 'none';
                document.getElementById('personalScoreInput').value = ''; let btn = document.getElementById('personalSignBtn'); btn.innerText = '+'; btn.className = 'sign-btn btn-plus';
                document.getElementById('pHandSelect').value = ''; document.getElementById('pTaiSelect').value = '';
                document.getElementById('manageLocArea').style.display = 'none';
            }
            showError("");
        }

        function render() {
            const filterYear = document.getElementById('filterYear').value;
            const filterMonth = document.getElementById('filterMonth').value; 
            const listDiv = document.getElementById('historyList');
            listDiv.innerHTML = '';
            
            displayRecords = localRecords; // é è¨­é¡¯ç¤ºå…¨éƒ¨
            
            if (filterMonth) { 
                displayRecords = localRecords.filter(rec => rec.date.startsWith(filterMonth)); 
            } else if (filterYear !== 'ALL') {
                displayRecords = localRecords.filter(rec => rec.date.startsWith(filterYear));
            }

            if (displayRecords.length === 0) { listDiv.innerHTML = '<p style="text-align:center; color:var(--text-dim); padding:20px;">ç„¡ç´€éŒ„</p>'; }

            displayRecords.forEach(rec => {
                let html = ''; let holidayTag = getHolidayTag(rec.date);
                let highlightTag = '';
                if (rec.highlight && rec.highlight.hand) {
                    const playerStr = rec.highlight.player ? `${rec.highlight.player}: ` : '';
                    highlightTag = `<div style="margin-top:8px;"><span class="history-tag tag-highlight">ğŸ† ${playerStr}${rec.highlight.hand} ${rec.highlight.tai}å°</span></div>`;
                }
                
                let checkboxHtml = isBatchMode ? `<input type="checkbox" class="batch-checkbox" value="${rec.id}">` : '';

                if (currentLocType === 'group') {
                    let detailsHtml = rec.details.map(p => {
                        let colorClass = p.score > 0 ? 'win-text' : (p.score < 0 ? 'lose-text' : 'zero-text'); let sign = p.score > 0 ? '+' : '';
                        return `<div><span>${p.name}</span> <span class="${colorClass}">${sign}${p.score}</span></div>`;
                    }).join('');
                    let infoTags = ""; if (rec.jiangCount) infoTags += `<span class="history-tag tag-info">ğŸ€„ ${rec.jiangCount}å°‡</span>`; if (rec.dongQian) infoTags += `<span class="history-tag tag-info">ğŸ’° æ±${rec.dongQian}</span>`;
                    html = `<div style="display:flex; align-items:center;">${checkboxHtml}<div style="flex:1;"><div class="history-header"><span class="history-date">${rec.date}</span> ${holidayTag} ${infoTags}</div><div class="history-scores">${detailsHtml}</div>${highlightTag}</div></div>`;
                } else {
                    let colorClass = rec.score > 0 ? 'win-text' : (rec.score < 0 ? 'lose-text' : 'zero-text'); let sign = rec.score > 0 ? '+' : ''; let noteHtml = rec.note ? `<div style="font-size:12px; color:var(--text-dim); margin-top:4px;">ğŸ“ ${rec.note}</div>` : '';
                    html = `<div style="display:flex; align-items:center;">${checkboxHtml}<div style="flex:1;"><div class="history-header"><span class="history-date">${rec.date}</span> ${holidayTag} <span class="history-tag tag-info">ğŸ“ ${rec.location}</span></div><div style="font-size:20px; margin-top:8px;" class="${colorClass}">${sign}${rec.score}</div>${noteHtml}${highlightTag}</div></div>`;
                }
                let item = document.createElement('div'); item.className = 'history-item'; 
                let actionButtons = isBatchMode ? '' : `<div><button class="edit-btn" onclick="editRecord('${rec.id}')">âœ</button><button class="delete-btn" onclick="deleteRecord('${rec.id}')">âœ•</button></div>`;
                item.innerHTML = html + actionButtons;
                listDiv.appendChild(item);
            });

            if (currentLocType === 'group') renderGroupStats(displayRecords); else renderPersonalStats(displayRecords);
        }

        // === æ‰¹æ¬¡åˆªé™¤åŠŸèƒ½ ===
        function toggleBatchMode() {
            isBatchMode = !isBatchMode;
            document.getElementById('batchToolbar').classList.toggle('hidden');
            render();
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.batch-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        function deleteBatch() {
            const checkboxes = document.querySelectorAll('.batch-checkbox:checked');
            if (checkboxes.length === 0) { alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é …ç›®"); return; }
            if (currentLocType === 'group') { if (!checkPassword()) { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); return; } }
            if (!confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™ ${checkboxes.length} ç­†ç´€éŒ„å—ï¼Ÿ`)) return;
            const updates = {};
            checkboxes.forEach(cb => { updates[cb.value] = null; });
            recordsRef.update(updates).then(() => { alert("ğŸ—‘ï¸ åˆªé™¤æˆåŠŸï¼"); toggleBatchMode(); });
        }

        // ä¿®æ”¹ï¼šæ¥æ”¶ filteredRecords åƒæ•¸ï¼Œä¸¦ä½¿ç”¨æ•¸å­—é‹ç®—
        function renderGroupStats(filteredRecords) {
            let stats = {}; let monthlyData = {}; let yearlyJiang = {}; let grandTotalJiang = 0; let grandTotalDong = 0; 
            let maxTai = { tai: 0, player: '', hand: '' };

            const targetRecords = filteredRecords || localRecords;

            targetRecords.forEach(rec => {
                if (rec.details) {
                    rec.details.forEach(p => { 
                        if (!stats[p.name]) stats[p.name] = 0; 
                        stats[p.name] += parseInt(p.score) || 0; 
                    });
                }
                
                if (rec.highlight && rec.highlight.tai > maxTai.tai) { maxTai = rec.highlight; }
                
                let dateObj = new Date(rec.date); let year = dateObj.getFullYear(); let month = (dateObj.getMonth() + 1).toString().padStart(2, '0'); let key = `${month}æœˆ`;
                let j = parseInt(rec.jiangCount) || 0; let d = parseInt(rec.dongQian) || 0;
                
                if (!monthlyData[key]) monthlyData[key] = { jiang: 0, dong: 0 }; 
                if (!yearlyJiang[year]) yearlyJiang[year] = 0;
                
                monthlyData[key].jiang += j; monthlyData[key].dong += d; yearlyJiang[year] += j; grandTotalJiang += j; grandTotalDong += d;
            });

            const maxTaiEl = document.getElementById('maxTaiRecord');
            if (maxTai.tai > 0) { maxTaiEl.innerText = `${maxTai.player} / ${maxTai.hand} (${maxTai.tai}å°)`; } else { maxTaiEl.innerText = "å°šç„¡ç´€éŒ„"; }

            const summaryBody = document.getElementById('summaryBody'); summaryBody.innerHTML = '';
            if (Object.keys(stats).length === 0) { summaryBody.innerHTML = '<tr><td colspan="3" style="color:var(--text-dim);">ç„¡è³‡æ–™</td></tr>'; }
            else {
                let sortedStats = Object.entries(stats).sort(([,a], [,b]) => b - a);
                sortedStats.forEach(([name, score], index) => {
                    let colorClass = score > 0 ? 'win-text' : (score < 0 ? 'lose-text' : 'zero-text'); let sign = score > 0 ? '+' : '';
                    let rankContent = index + 1; let rankClass = "rank-other";
                    if(index === 0) { rankContent = 'ğŸ¥‡'; rankClass = "rank-1"; } else if(index === 1) { rankContent = 'ğŸ¥ˆ'; rankClass = "rank-2"; } else if(index === 2) { rankContent = 'ğŸ¥‰'; rankClass = "rank-3"; }
                    if (index === sortedStats.length - 1 && sortedStats.length > 1) { rankContent = 'ğŸ‘‘ è€é—†'; rankClass = 'rank-boss'; }
                    
                    summaryBody.innerHTML += `
                        <tr onclick="showPlayerStats('${name}')" style="cursor:pointer;">
                            <td><span class="rank-badge ${rankClass}">${rankContent}</span></td>
                            <td style="font-weight:500; font-size:16px;">${name}</td>
                            <td class="${colorClass}" style="font-size:18px;">${sign}${score}</td>
                        </tr>`;
                });
            }
            document.getElementById('grandTotalJiang').innerText = grandTotalJiang; document.getElementById('grandTotalDong').innerText = "$" + grandTotalDong;
            const statsBody = document.getElementById('monthlyStatsBody'); const yearFoot = document.getElementById('yearlyStatsFoot'); statsBody.innerHTML = ''; yearFoot.innerHTML = '';
            let sortedKeys = Object.keys(monthlyData).sort().reverse();
            if (sortedKeys.length === 0) { statsBody.innerHTML = '<tr><td colspan="3" style="color:var(--text-dim);">ç„¡è³‡æ–™</td></tr>'; } else { sortedKeys.forEach(key => { let d = monthlyData[key]; statsBody.innerHTML += `<tr><td>${key}</td><td>${d.jiang}</td><td>${d.dong}</td></tr>`; }); }
            let sortedYears = Object.keys(yearlyJiang).sort().reverse(); if(sortedYears.length > 0) { yearFoot.innerHTML = `${sortedYears[0]}å¹´ç¸½è¨ˆï¼š${yearlyJiang[sortedYears[0]]} å°‡`; }
        }

        // é¡¯ç¤ºé¸æ‰‹æˆ°ç¸¾è©³ç´° (é©—ç®—åŠŸèƒ½)
        function showPlayerStats(playerName) {
            const modal = document.getElementById('playerStatsModal');
            const title = document.getElementById('playerStatsTitle');
            const list = document.getElementById('playerStatsList');
            const footer = document.getElementById('playerStatsTotal');
            
            title.innerText = `${playerName} çš„æˆ°ç¸¾`;
            list.innerHTML = '';
            
            let total = 0;
            displayRecords.forEach(rec => {
                if (rec.details) {
                    const playerRecord = rec.details.find(p => p.name === playerName);
                    if (playerRecord) {
                        const s = parseInt(playerRecord.score);
                        total += s;
                        const colorClass = s > 0 ? 'win-text' : (s < 0 ? 'lose-text' : '');
                        const sign = s > 0 ? '+' : '';
                        list.innerHTML += `
                            <div class="player-record-row">
                                <span class="player-record-date">${rec.date}</span>
                                <span class="player-record-score ${colorClass}">${sign}${s}</span>
                            </div>
                        `;
                    }
                }
            });
            
            const totalSign = total > 0 ? '+' : '';
            const totalColor = total > 0 ? 'var(--accent-gold)' : (total < 0 ? 'var(--accent-jade)' : 'var(--text-light)');
            footer.innerHTML = `ç¸½è¨ˆ: <span style="color:${totalColor}; font-size:20px;">${totalSign}${total}</span>`;
            
            if (list.innerHTML === '') list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-dim);">æ­¤å€é–“ç„¡æˆ°ç¸¾</div>';
            
            modal.style.display = 'flex';
        }

        function closePlayerStats() {
            document.getElementById('playerStatsModal').style.display = 'none';
        }

        // æ¥æ”¶ filteredRecords åƒæ•¸ï¼Œé”åˆ°ç¸½è³‡ç”¢é€£å‹•
        function renderPersonalStats(filteredRecords) {
            let totalScore = 0; 
            let yearlyData = {};
            let locationStats = {};

            const targetRecords = filteredRecords || localRecords;

            targetRecords.forEach(rec => { 
                let score = parseInt(rec.score) || 0;
                totalScore += score; 
                let loc = rec.location || 'æœªçŸ¥';
                if (!locationStats[loc]) locationStats[loc] = 0;
                locationStats[loc] += score;
                let year = rec.date.substring(0, 4);
                let month = rec.date.substring(5, 7);
                if (!yearlyData[year]) yearlyData[year] = { total: 0, months: {} };
                yearlyData[year].total += score;
                if (!yearlyData[year].months[month]) yearlyData[year].months[month] = { count: 0, score: 0 };
                yearlyData[year].months[month].count += 1;
                yearlyData[year].months[month].score += score;
            });

            const sign = totalScore > 0 ? '+' : ''; const color = totalScore > 0 ? 'var(--accent-gold)' : (totalScore < 0 ? 'var(--accent-jade)' : 'var(--text-dim)');
            document.getElementById('personalTotalScore').innerText = `${sign}$${totalScore}`;
            document.getElementById('personalTotalScore').style.color = color;
            document.getElementById('personalTotalCount').innerText = targetRecords.length;

            const locContainer = document.getElementById('personalLocationStats');
            let sortedLocs = Object.keys(locationStats).sort((a,b) => locationStats[b] - locationStats[a]); 
            let locHtml = '';
            if (sortedLocs.length === 0) locHtml = '<div style="padding:12px; text-align:center; color:var(--text-dim); font-size:13px;">æš«ç„¡æˆ°ç¸¾</div>';
            else {
                sortedLocs.forEach(loc => {
                    let s = locationStats[loc];
                    let lSign = s > 0 ? '+' : '';
                    let lColor = s > 0 ? 'var(--accent-gold)' : (s < 0 ? 'var(--accent-jade)' : 'var(--text-light)');
                    locHtml += `<div class="loc-stat-item"><span>ğŸ“ ${loc}</span><span style="color:${lColor}; font-weight:bold; font-size:16px;">${lSign}$${s}</span></div>`;
                });
            }
            locContainer.innerHTML = locHtml;

            const container = document.getElementById('personalYearlyContainer');
            container.innerHTML = '';
            let sortedYears = Object.keys(yearlyData).sort().reverse();
            if (sortedYears.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim);">å°šç„¡è³‡æ–™</div>';
                return;
            }
            sortedYears.forEach(year => {
                let yData = yearlyData[year];
                let ySign = yData.total > 0 ? '+' : '';
                let yClass = yData.total > 0 ? 'win' : (yData.total < 0 ? 'lose' : '');
                let yColor = yData.total > 0 ? 'var(--accent-gold)' : (yData.total < 0 ? 'var(--accent-jade)' : 'var(--text-light)');
                let monthsHtml = '';
                let sortedMonths = Object.keys(yData.months).sort().reverse();
                sortedMonths.forEach(m => {
                    let mData = yData.months[m];
                    let mSign = mData.score > 0 ? '+' : '';
                    let mColor = mData.score > 0 ? 'var(--accent-gold)' : (mData.score < 0 ? 'var(--accent-jade)' : 'var(--text-light)');
                    monthsHtml += `<div class="month-item"><span class="month-name">${m}æœˆ</span><span class="month-count">${mData.count}å ´</span><span class="month-score" style="color:${mColor}">${mSign}$${mData.score}</span></div>`;
                });
                container.innerHTML += `<div class="year-card ${yClass}"><div class="year-header" onclick="toggleYear(this)"><div class="year-title"><span class="year-arrow">â–¼</span> ${year}å¹´</div><div class="year-score" style="color:${yColor}">${ySign}$${yData.total}</div></div><div class="month-list">${monthsHtml}</div></div>`;
            });
        }

        function toggleYear(header) {
            header.classList.toggle('year-expanded');
            const content = header.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }

        function exportCSV() {
            let csv = currentLocType === 'group' ? "\uFEFFæ—¥æœŸ,å°‡æ•¸,æ±éŒ¢,ç©å®¶,é‡‘é¡\n" : "\uFEFFæ—¥æœŸ,åœ°é»,é‡‘é¡,å‚™è¨»\n";
            localRecords.forEach(rec => {
                if(currentLocType === 'group') { rec.details.forEach(p => { csv += `${rec.date},${rec.jiangCount || 0},${rec.dongQian || 0},${p.name},${p.score}\n`; }); }
                else { csv += `${rec.date},${rec.location},${rec.score},${rec.note || ''}\n`; }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `éº»å°‡_${currentLocType}_${new Date().toISOString().slice(0,10)}.csv`; link.click();
        }

        function backupData() {
            const jsonStr = JSON.stringify(localRecords, null, 2); const blob = new Blob([jsonStr], { type: 'application/json' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `éº»å°‡å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`; link.click();
        }

        function showImportModal() { document.getElementById('importModal').style.display='flex'; }
        
        function processImport() {
            const jsonText = document.getElementById('importJsonArea').value.trim();
            if (!jsonText) { alert("è«‹å…ˆè²¼ä¸Š JSON è³‡æ–™ï¼"); return; }
            try {
                const data = JSON.parse(jsonText);
                if (!Array.isArray(data)) { alert("æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯ JSON é™£åˆ— [ ... ]"); return; }
                if (currentLocType === 'personal') {
                    data.forEach(item => {
                        recordsRef.push({
                            date: item.date,
                            location: item.location || "è‡ªå‹•åŒ¯å…¥",
                            score: item.score,
                            note: item.note || "",
                            timestamp: Date.now()
                        });
                    });
                } else {
                    alert("âš ï¸ é€™æ˜¯ç§äººæˆ°ç¸¾ï¼Œè«‹å…ˆåˆ‡æ›åˆ°ç§äººé‡‘åº«å†åŒ¯å…¥ï¼");
                    return;
                }
                alert("âœ… æˆåŠŸåŒ¯å…¥ " + data.length + " ç­†è³‡æ–™ï¼");
                document.getElementById('importModal').style.display='none';
                document.getElementById('importJsonArea').value = ''; 
            } catch (e) {
                alert("âŒ JSON è§£æå¤±æ•—ï¼š" + e.message);
            }
        }
    </script>
</body>
</html>
