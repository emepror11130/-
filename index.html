<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üÄÑ ÈõÄÁ•ûÈõ≤Á´ØË®òÂ∏≥</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ÂÖ®ÂüüË®≠ÂÆö */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --bg-color: #1e6f50; --card-bg: #ffffff; --win-color: #e74c3c; --lose-color: #27ae60; --text-main: #2c3e50; }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            padding: 10px; 
            padding-bottom: 50px;
        }

        h1 { text-align: center; color: #fff; margin: 10px 0; font-size: 20px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        #status { text-align: center; font-size: 12px; color: rgba(255,255,255,0.9); margin-bottom: 10px; }
        .online-dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; width: 100%; }
        .card h3 { margin: 0 0 10px 0; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; color: var(--bg-color); font-size: 16px; display: flex; justify-content: space-between; align-items: center; }

        /* Á∏ΩË®àÁúãÊùø (Êñ∞ÂäüËÉΩ) */
        .dashboard-grid { display: flex; gap: 10px; margin-bottom: 15px; }
        .dash-box { flex: 1; padding: 10px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .dash-label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .dash-value { font-size: 18px; font-weight: bold; }

        /* Ëº∏ÂÖ•ÂçÄ */
        .top-inputs { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-group { flex: 1; }
        .input-group label { display: block; font-size: 12px; color: #888; margin-bottom: 2px; text-align: center;}
        .input-style { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; background: #f9f9f9; text-align: center; height: 38px; }

        .player-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
        .name-wrapper { flex: 4; }
        .name-select, .custom-name { width: 100%; padding: 0 8px; height: 42px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; background: white; appearance: none; -webkit-appearance: none; }
        
        .sign-btn { flex: 0 0 36px; height: 36px; width: 36px; font-size: 20px; font-weight: bold; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
        .btn-plus { background-color: #fff; color: var(--win-color); border: 1px solid var(--win-color); }
        .btn-minus { background-color: var(--lose-color); color: white; border: 1px solid var(--lose-color); }

        .score-input { flex: 2.5; padding: 8px; height: 42px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; text-align: center; font-weight: bold; color: var(--text-main); width: 100%; }

        .action-btn { width: 100%; padding: 12px; background-color: var(--text-main); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .cancel-btn { width: 100%; padding: 10px; background-color: #95a5a6; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-top: 8px; display: none; }

        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 14px; table-layout: fixed; }
        th { background-color: #f8f9fa; color: #888; font-weight: 600; padding: 8px 4px; text-align: center; font-size: 13px; }
        td { padding: 10px 4px; text-align: center; border-bottom: 1px solid #eee; word-wrap: break-word; }
        
        .win-text { color: var(--win-color); font-weight: bold; }
        .lose-text { color: var(--lose-color); font-weight: bold; }
        
        .rank-badge { display: inline-block; width: 20px; height: 20px; line-height: 20px; border-radius: 50%; background: #eee; font-size: 11px; }
        .rank-1 { background: #f1c40f; color: white; }
        
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .history-date { font-size: 12px; color: #999; margin-bottom: 2px; }
        .history-scores { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 10px; margin-top: 4px; font-size: 13px; }
        
        .edit-btn { background: #f39c12; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 14px; }
        .delete-btn { background: #ff7675; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 14px; margin-left: 5px;}
        .error-msg { background: #ffebee; color: #c62828; padding: 8px; border-radius: 6px; text-align: center; font-weight: bold; display: none; margin-top: 8px; font-size: 14px;}
        .editing-mode { border: 2px solid #f39c12; }
    </style>
</head>
<body>

    <h1>üÄÑ ÈõÄÁ•ûË®òÂ∏≥Êú¨</h1>
    <div id="status"><span class="online-dot" id="dot"></span><span id="statusText">ÈÄ£Á∑ö‰∏≠...</span></div>

    <div class="card" id="inputCard">
        <h3 id="inputTitle"><span>‚úèÔ∏è Êñ∞Â¢ûÊà∞Á∏æ</span></h3>
        <div class="top-inputs">
            <div class="input-group" style="flex:1.2;">
                <label>Êó•Êúü</label>
                <input type="date" id="dateInput" class="input-style">
            </div>
            <div class="input-group">
                <label>Â∞áÊï∏</label>
                <input type="number" id="jiangInput" class="input-style" placeholder="Â†¥" value="1" inputmode="numeric">
            </div>
            <div class="input-group">
                <label>Êù±Èå¢</label>
                <input type="number" id="dongInput" class="input-style" placeholder="$" value="0" inputmode="numeric">
            </div>
        </div>
        <div id="playersArea"></div>
        <p id="errorMsg" class="error-msg"></p>
        <button class="action-btn" id="saveBtn" onclick="saveData()">ÂÑ≤Â≠òÁ¥ÄÈåÑ</button>
        <button class="cancel-btn" id="cancelBtn" onclick="cancelEdit()">ÂèñÊ∂à‰øÆÊîπ</button>
    </div>

    <div class="card">
        <h3>üèÜ Ëã±ÈõÑÊ¶ú</h3>
        <table>
            <thead><tr><th width="15%">#</th><th width="40%">ÂßìÂêç</th><th width="45%">Á¥ØÁ©ç</th></tr></thead>
            <tbody id="summaryBody"><tr><td colspan="3">ËºâÂÖ•‰∏≠...</td></tr></tbody>
        </table>
    </div>

    <div class="card">
        <h3>üìä Áµ±Ë®àÊï∏Êìö</h3>
        
        <div class="dashboard-grid">
            <div class="dash-box" style="background: #e8f5e9;">
                <div class="dash-label">Ê≠∑Âè≤Á∏ΩÂ∞áÊï∏</div>
                <div class="dash-value" style="color: #2e7d32;" id="grandTotalJiang">0</div>
            </div>
            <div class="dash-box" style="background: #fff3e0;">
                <div class="dash-label">Ê≠∑Âè≤Á∏ΩÊù±Èå¢</div>
                <div class="dash-value" style="color: #ef6c00;" id="grandTotalDong">$0</div>
            </div>
        </div>

        <table>
            <thead><tr><th>Êúà‰ªΩ</th><th>Â†¥Ê¨°</th><th>Êù±Èå¢</th></tr></thead>
            <tbody id="monthlyStatsBody"><tr><td colspan="3">Ë®àÁÆó‰∏≠...</td></tr></tbody>
        </table>
        <div id="yearlyStatsFoot" style="text-align:center; margin-top:10px; font-weight:bold; color:#1e6f50; font-size: 13px;"></div>
    </div>

    <div class="card">
        <h3>
            üìú Á¥ÄÈåÑ
            <button onclick="exportCSV()" style="background:transparent; border:1px solid #3498db; color:#3498db; border-radius:20px; padding:2px 8px; font-size:12px;">üì• Excel</button>
        </h3>
        <div id="historyList"></div>
    </div>

    <script>
        // ==========================================
        // ‚ñº ÊÇ®ÁöÑ Firebase Ë®≠ÂÆö ‚ñº
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBuqMMuRwgysCZrSJagYmZLd2OOciJC1Rc",
            authDomain: "mahjong-app-d6267.firebaseapp.com",
            projectId: "mahjong-app-d6267",
            storageBucket: "mahjong-app-d6267.firebasestorage.app",
            messagingSenderId: "1083238926870",
            appId: "1:1083238926870:web:f1ffe3b5eadf959bcd8337",
            measurementId: "G-H7T8N8YCG1"
        };
        // ==========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const recordsRef = db.ref('records');
        let localRecords = [];
        let currentEditId = null;

        db.ref('.info/connected').on('value', function(snap) {
            const statusText = document.getElementById('statusText');
            const dot = document.getElementById('dot');
            if (snap.val() === true) {
                statusText.innerText = "Â∑≤ÈÄ£Á∑ö"; dot.classList.add('connected');
            } else {
                statusText.innerText = "ÈÄ£Á∑ö‰∏≠..."; dot.classList.remove('connected');
            }
        });

        recordsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            localRecords = [];
            if (data) {
                Object.keys(data).forEach(key => {
                    localRecords.push({ id: key, ...data[key] });
                });
                localRecords.sort((a, b) => b.timestamp - a.timestamp);
            }
            render();
        });

        const PREDEFINED_NAMES = ["ÂÆ•Ëæ∞", "Â§èÁëã", "H", "Â≠∏Âßä", "‰∏Ä‰∏≠", "ÁõõÂÆâ"];
        document.getElementById('dateInput').valueAsDate = new Date();
        initPlayerInputs();

        function initPlayerInputs() {
            const container = document.getElementById('playersArea');
            let html = '';
            let optionsHtml = `<option value="" disabled selected>ÈÅ∏Êìá</option>`;
            PREDEFINED_NAMES.forEach(name => optionsHtml += `<option value="${name}">${name}</option>`);
            optionsHtml += `<option value="Other">Ëá™Ë®Ç...</option>`;

            for (let i = 1; i <= 4; i++) {
                html += `
                <div class="player-row">
                    <div class="name-wrapper">
                        <select class="name-select" onchange="handleNameChange(this)">${optionsHtml}</select>
                        <input type="text" class="custom-name" placeholder="ÂêçÂ≠ó">
                    </div>
                    <button class="sign-btn btn-plus" onclick="toggleSign(this)">+</button>
                    <input type="number" class="score-input" placeholder="0" inputmode="numeric">
                </div>`;
            }
            container.innerHTML = html;
        }

        function handleNameChange(select) {
            const wrapper = select.parentElement;
            const custom = wrapper.querySelector('.custom-name');
            if (select.value === 'Other') { select.style.display='none'; custom.style.display='block'; custom.focus(); }
            else { custom.style.display='none'; select.style.display='block'; custom.value=''; }
        }

        function toggleSign(btn) {
            if (btn.innerText === '+') { btn.innerText = '-'; btn.className = 'sign-btn btn-minus'; } 
            else { btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; }
        }

        function saveData() {
            const date = document.getElementById('dateInput').value;
            const jiangCount = parseInt(document.getElementById('jiangInput').value) || 0;
            const dongQian = parseInt(document.getElementById('dongInput').value) || 0;
            const rows = document.querySelectorAll('.player-row');
            
            let currentEntry = [];
            let totalScore = 0;
            let namesCheck = new Set();

            for (let row of rows) {
                const select = row.querySelector('.name-select');
                const customInput = row.querySelector('.custom-name');
                const signBtn = row.querySelector('.sign-btn');
                const scoreInput = row.querySelector('.score-input');
                
                let name = select.style.display !== 'none' ? select.value : customInput.value.trim();
                if (!name || name === "Other") { showError("‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÂêçÂ≠ó"); return; }
                if (namesCheck.has(name)) { showError(`‚ö†Ô∏è ÂêçÂ≠óÈáçË§áÔºö${name}`); return; }
                namesCheck.add(name);

                let rawScore = parseInt(scoreInput.value);
                if (isNaN(rawScore)) { showError(`‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÈáëÈ°ç`); return; }
                let finalScore = Math.abs(rawScore) * (signBtn.innerText === '+' ? 1 : -1);

                currentEntry.push({ name: name, score: finalScore });
                totalScore += finalScore;
            }

            if (totalScore !== 0) { showError(`‚ö†Ô∏è Â∏≥ÁõÆ‰∏çÂπ≥ÔºÅÁõÆÂâçÁ∏ΩÂíå ${totalScore}`); return; }

            const recordData = {
                date: date,
                timestamp: Date.now(),
                jiangCount: jiangCount,
                dongQian: dongQian,
                details: currentEntry
            };

            if (currentEditId) {
                recordsRef.child(currentEditId).update(recordData)
                    .then(() => { alert("‚úÖ ‰øÆÊîπÊàêÂäü"); cancelEdit(); })
                    .catch(err => alert("Â§±Êïó: " + err.message));
            } else {
                recordsRef.push(recordData)
                    .then(() => { resetForm(); alert("‚úÖ ÂÑ≤Â≠òÊàêÂäü"); })
                    .catch(err => alert("Â§±Êïó: " + err.message));
            }
        }

        function editRecord(id) {
            const record = localRecords.find(r => r.id === id);
            if (!record) return;

            document.getElementById('dateInput').value = record.date;
            document.getElementById('jiangInput').value = record.jiangCount || 0;
            document.getElementById('dongInput').value = record.dongQian || 0;

            const rows = document.querySelectorAll('.player-row');
            for (let i = 0; i < 4; i++) {
                if (i < record.details.length) {
                    const p = record.details[i];
                    const row = rows[i];
                    const select = row.querySelector('.name-select');
                    const custom = row.querySelector('.custom-name');
                    const score = row.querySelector('.score-input');
                    const btn = row.querySelector('.sign-btn');

                    if (PREDEFINED_NAMES.includes(p.name)) {
                        select.value = p.name; select.style.display = 'block'; custom.style.display = 'none';
                    } else {
                        select.value = 'Other'; select.style.display = 'none'; custom.style.display = 'block'; custom.value = p.name;
                    }

                    score.value = Math.abs(p.score);
                    if (p.score < 0) { btn.innerText = '-'; btn.className = 'sign-btn btn-minus'; }
                    else { btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; }
                }
            }

            currentEditId = id;
            document.getElementById('inputCard').classList.add('editing-mode');
            document.getElementById('inputTitle').innerText = "‚úèÔ∏è ‰øÆÊîπ‰∏≠...";
            document.getElementById('saveBtn').innerText = "Á¢∫Ë™ç‰øÆÊîπ";
            document.getElementById('saveBtn').style.backgroundColor = "#f39c12";
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            currentEditId = null;
            document.getElementById('inputCard').classList.remove('editing-mode');
            document.getElementById('inputTitle').innerText = "‚úèÔ∏è Êñ∞Â¢ûÊà∞Á∏æ";
            document.getElementById('saveBtn').innerText = "ÂÑ≤Â≠òÁ¥ÄÈåÑ";
            document.getElementById('saveBtn').style.backgroundColor = "";
            document.getElementById('cancelBtn').style.display = "none";
            resetForm();
        }

        function resetForm() {
            const rows = document.querySelectorAll('.player-row');
            rows.forEach(row => {
                row.querySelector('.score-input').value = '';
                let btn = row.querySelector('.sign-btn');
                btn.innerText = '+'; btn.className = 'sign-btn btn-plus';
            });
            document.getElementById('dongInput').value = 0;
            document.getElementById('jiangInput').value = 1;
            showError("");
        }

        function deleteRecord(id) {
            if(!confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) return;
            recordsRef.child(id).remove();
            if (currentEditId === id) cancelEdit();
        }

        function render() {
            const listDiv = document.getElementById('historyList');
            listDiv.innerHTML = '';
            if (localRecords.length === 0) { listDiv.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">ÁÑ°Á¥ÄÈåÑ</p>'; }

            localRecords.forEach(rec => {
                let detailsHtml = rec.details.map(p => {
                    let colorClass = p.score > 0 ? 'win-text' : (p.score < 0 ? 'lose-text' : 'zero-text');
                    let sign = p.score > 0 ? '+' : '';
                    return `<div><span>${p.name}</span> <span class="${colorClass}">${sign}${p.score}</span></div>`;
                }).join('');

                let item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div style="flex:1;">
                        <div class="history-date">${rec.date} ${rec.jiangCount ? `| ${rec.jiangCount}Â∞á` : ''}</div>
                        <div class="history-scores">${detailsHtml}</div>
                    </div>
                    <div>
                        <button class="edit-btn" onclick="editRecord('${rec.id}')">‚úé</button>
                        <button class="delete-btn" onclick="deleteRecord('${rec.id}')">‚úï</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });

            // Á∏ΩÁµêÁÆó
            let stats = {};
            localRecords.forEach(rec => {
                rec.details.forEach(p => {
                    if (!stats[p.name]) stats[p.name] = 0;
                    stats[p.name] += p.score;
                });
            });
            const summaryBody = document.getElementById('summaryBody');
            summaryBody.innerHTML = '';
            
            if (Object.keys(stats).length === 0) { summaryBody.innerHTML = '<tr><td colspan="3" style="color:#999;">ÁÑ°Ë≥áÊñô</td></tr>'; }
            else {
                Object.entries(stats).sort(([,a], [,b]) => b - a).forEach(([name, score], index) => {
                    let colorClass = score > 0 ? 'win-text' : (score < 0 ? 'lose-text' : 'zero-text');
                    let sign = score > 0 ? '+' : '';
                    let rankText = index + 1;
                    if(index === 0) rankText = 'ü•á';
                    
                    summaryBody.innerHTML += `<tr>
                        <td><span class="rank-badge ${index === 0 ? 'rank-1' : ''}">${rankText}</span></td>
                        <td style="font-weight:500;">${name}</td>
                        <td class="${colorClass}">${sign}${score}</td>
                    </tr>`;
                });
            }

            // Áµ±Ë®àË®àÁÆó (ÊúàÂ∫¶ + Á∏ΩÊ≠∑Âè≤)
            let monthlyData = {}; 
            let yearlyJiang = {}; 
            let grandTotalJiang = 0; // Ê≠∑Âè≤Á∏ΩÂ∞áÊï∏
            let grandTotalDong = 0; // Ê≠∑Âè≤Á∏ΩÊù±Èå¢

            localRecords.forEach(rec => {
                let dateObj = new Date(rec.date);
                let year = dateObj.getFullYear();
                let month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                let key = `${month}Êúà`;
                if (!monthlyData[key]) monthlyData[key] = { jiang: 0, dong: 0 };
                if (!yearlyJiang[year]) yearlyJiang[year] = 0;

                let j = parseInt(rec.jiangCount) || 0;
                let d = parseInt(rec.dongQian) || 0;

                monthlyData[key].jiang += j;
                monthlyData[key].dong += d;
                yearlyJiang[year] += j;
                
                // Á¥ØÂä†Ê≠∑Âè≤Á∏ΩÈ°ç
                grandTotalJiang += j;
                grandTotalDong += d;
            });

            // Êõ¥Êñ∞Á∏ΩË®àÁúãÊùø DOM
            document.getElementById('grandTotalJiang').innerText = grandTotalJiang;
            document.getElementById('grandTotalDong').innerText = "$" + grandTotalDong;

            const statsBody = document.getElementById('monthlyStatsBody');
            const yearFoot = document.getElementById('yearlyStatsFoot');
            statsBody.innerHTML = '';
            yearFoot.innerHTML = '';

            let sortedKeys = Object.keys(monthlyData).sort().reverse();
            if (sortedKeys.length === 0) { statsBody.innerHTML = '<tr><td colspan="3">ÁÑ°Ë≥áÊñô</td></tr>'; }
            else {
                sortedKeys.forEach(key => {
                    let d = monthlyData[key];
                    statsBody.innerHTML += `<tr><td>${key}</td><td>${d.jiang}</td><td>${d.dong}</td></tr>`;
                });
            }
            let sortedYears = Object.keys(yearlyJiang).sort().reverse();
            if(sortedYears.length > 0) {
                yearFoot.innerHTML = `${sortedYears[0]}Âπ¥Á∏ΩË®àÔºö${yearlyJiang[sortedYears[0]]} Â∞á`;
            }
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg; el.style.display = msg ? 'block' : 'none';
        }

        function exportCSV() {
            let csv = "\uFEFFÊó•Êúü,Â∞áÊï∏,Êù±Èå¢,Áé©ÂÆ∂,ÈáëÈ°ç\n";
            localRecords.forEach(rec => {
                rec.details.forEach(p => {
                    csv += `${rec.date},${rec.jiangCount || 0},${rec.dongQian || 0},${p.name},${p.score}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `È∫ªÂ∞á_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</body>
</html>
