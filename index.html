<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ€„ é›€ç¥é›²ç«¯è¨˜å¸³</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --bg-color: #1e6f50; --card-bg: #ffffff; --win-color: #e74c3c; --lose-color: #27ae60; --text-main: #2c3e50; }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            padding: 12px; 
            padding-bottom: 60px;
        }

        /* é ‚éƒ¨å°èˆª */
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        h1 { margin: 0; font-size: 18px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        
        .location-badge {
            background: rgba(255,255,255,0.2); color: white; padding: 5px 12px; border-radius: 20px;
            font-size: 14px; cursor: pointer; border: 1px solid rgba(255,255,255,0.4);
            display: flex; align-items: center; gap: 5px;
        }
        .location-badge:active { background: rgba(255,255,255,0.4); }

        #status { text-align: center; font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 10px; }
        .online-dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        .card { background: var(--card-bg); padding: 16px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; width: 100%; overflow: hidden; }
        .card h3 { margin: 0 0 12px 0; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; color: var(--bg-color); font-size: 17px; display: flex; justify-content: space-between; align-items: center; }

        /* è¼¸å…¥å€æ¨£å¼ */
        .input-style { width: 100%; height: 44px; padding: 0 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #f9f9f9; color: #333; display: flex; align-items: center; justify-content: center; }
        input[type="date"] { -webkit-appearance: none; appearance: none; display: flex; align-items: center; justify-content: center; line-height: normal; padding: 0; }
        input[type="date"]::-webkit-date-and-time-value { line-height: 1.5; padding-top: 2px; }

        /* ç¾¤çµ„æ¨¡å¼æ¨£å¼ */
        .group-mode .row-date { margin-bottom: 12px; }
        .group-mode .row-stats { display: flex; gap: 12px; margin-bottom: 20px; }
        .group-mode .col-half { flex: 1; }
        .group-mode .player-row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .group-mode .name-select { width: 100%; height: 44px; border-radius: 8px; border: 1px solid #ddd; background: white; font-size: 15px; padding: 0 10px; }
        .group-mode .score-input { width: 80px; height: 44px; text-align: center; font-weight: bold; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        .sign-btn { flex: 0 0 40px; height: 40px; border-radius: 50%; border: none; font-size: 24px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-plus { background: #fff; color: var(--win-color); border: 1.5px solid var(--win-color); }
        .btn-minus { background: var(--lose-color); color: white; border: 1.5px solid var(--lose-color); }

        /* å¤§ç‰Œç´€éŒ„å€å¡Š (æ–°ç‰ˆé¸å–®æ¨£å¼) */
        .highlight-section { background: #fffcf5; border: 1px solid #fae588; border-radius: 10px; padding: 10px; margin-top: 15px; margin-bottom: 5px; }
        .highlight-toggle { color: #f39c12; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; margin-top: 10px; }
        .highlight-inputs { display: none; margin-top: 10px; }
        
        /* é¸å–®é€šç”¨æ¨£å¼ */
        .mem-select { width: 100%; height: 44px; border: 1px solid #ddd; border-radius: 8px; background: #fff; font-size: 15px; padding: 0 10px; color: #333; }

        /* å€‹äººæ¨¡å¼æ¨£å¼ */
        .personal-mode .input-row { margin-bottom: 12px; }
        .personal-mode label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; font-weight: bold; margin-left: 2px; }
        .personal-mode .score-input-large { width: 100%; height: 50px; font-size: 24px; text-align: center; border: 2px solid #ddd; border-radius: 10px; font-weight: bold; color: var(--text-main); }
        .personal-mode .score-input-large:focus { border-color: var(--bg-color); outline: none; }
        
        .personal-select { width: 100%; height: 44px; padding: 0 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; background: white; appearance: none; -webkit-appearance: none; color: #333; }
        .personal-custom { width: 100%; height: 44px; padding: 0 10px; border: 1px solid #3498db; border-radius: 8px; font-size: 15px; display: none; }

        /* å…±ç”¨æŒ‰éˆ• */
        .action-btn { width: 100%; padding: 14px; background-color: var(--text-main); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .cancel-btn { width: 100%; padding: 10px; background-color: #95a5a6; color: white; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; margin-top: 8px; display: none; }

        /* çµ±è¨ˆèˆ‡åˆ—è¡¨ */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 14px; table-layout: fixed; }
        th { background-color: #f8f9fa; color: #888; font-weight: 600; padding: 10px 4px; text-align: center; font-size: 13px; border-radius: 4px; }
        td { padding: 12px 4px; text-align: center; border-bottom: 1px solid #eee; word-wrap: break-word; }
        
        .win-text { color: var(--win-color); font-weight: bold; }
        .lose-text { color: var(--lose-color); font-weight: bold; }
        .rank-badge { display: inline-block; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; font-size: 14px; }
        .rank-1 { background: transparent; font-size: 20px; text-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .rank-2 { background: transparent; font-size: 20px; text-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .rank-3 { background: transparent; font-size: 20px; text-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .rank-other { background: #eee; font-size: 12px; color: #666; }
        .rank-boss { background: #2c3e50; color: #f1c40f; font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; width: auto; height: auto; line-height: normal; }

        .dashboard-grid { display: flex; gap: 10px; margin-bottom: 5px; }
        .dash-box { flex: 1; padding: 12px 5px; border-radius: 10px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .dash-label { font-size: 11px; color: #666; margin-bottom: 2px; }
        .dash-value { font-size: 18px; font-weight: bold; line-height: 1.2; }

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .history-header { margin-bottom: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .history-date { font-size: 13px; color: #333; font-weight: 500; }
        .history-tag { font-size: 11px; padding: 1px 5px; border-radius: 4px; display: inline-block; white-space: nowrap; }
        .tag-holiday { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-weight: bold; }
        .tag-lunar { background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        .tag-info { background-color: #f5f5f5; color: #666; border: 1px solid #e0e0e0; }
        .tag-highlight { background: linear-gradient(135deg, #f1c40f, #f39c12); color: white; font-weight: bold; border: none; box-shadow: 0 1px 3px rgba(243, 156, 18, 0.4); }

        .history-scores { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 10px; margin-top: 5px; font-size: 13px; }
        
        .edit-btn { background: #f39c12; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 14px; }
        .delete-btn { background: #ff7675; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 14px; margin-left: 8px;}
        .error-msg { background: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; display: none; margin-top: 10px; font-size: 14px;}
        .editing-mode { border: 2px solid #f39c12; }

        .backup-btn { background: transparent; border: 1px solid #2ecc71; color: #2ecc71; border-radius: 20px; padding: 2px 8px; font-size: 12px; cursor: pointer; margin-left: 5px;}
        
        /* ç®¡ç†èˆ‡é¸å–® */
        .manage-btn { background: none; border: none; color: #7f8c8d; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .location-menu { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .location-card { background: white; width: 85%; max-width: 320px; padding: 20px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .location-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; border-radius: 8px; margin-bottom: 8px; }
        .location-item:hover { background: #f0f0f0; }
        .loc-name-area { flex: 1; cursor: pointer; }
        .loc-delete { padding: 5px 10px; color: #ccc; font-size: 16px; cursor: pointer; }
        .loc-delete:hover { color: #e74c3c; }
        .location-group-title { font-size: 12px; color: #999; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
        .location-add { margin-top: 15px; text-align: center; padding: 10px; border: 1px dashed #aaa; border-radius: 8px; color: #666; cursor: pointer; font-size: 14px; }
        
        .hidden { display: none !important; }
        .manage-area { margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 10px; display: none; }
        .player-tag { background: #f0f2f5; border: 1px solid #dcdfe6; border-radius: 20px; padding: 5px 12px; font-size: 14px; color: #606266; display: flex; align-items: center; gap: 8px; }
        .player-delete { color: #f56c6c; cursor: pointer; font-weight: bold; font-size: 16px; line-height: 1; }
        .player-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header-nav">
        <h1>ğŸ€„ é›€ç¥è¨˜å¸³æœ¬</h1>
        <div class="location-badge" onclick="showLocationMenu()">
            <span id="currentLocationName">ğŸ“ è•™å„€å®¶</span>
        </div>
    </div>
    
    <div id="status"><span class="online-dot" id="dot"></span><span id="statusText">é€£ç·šä¸­...</span></div>

    <div id="locationModal" class="location-menu" onclick="closeLocationMenu(event)">
        <div class="location-card">
            <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">åˆ‡æ›å¸³æœ¬</h3>
            
            <div class="location-group-title">ğŸ  å…¬é–‹æˆ°å ´ (ç„¡éœ€å¯†ç¢¼)</div>
            <div id="publicLocationList"></div>

            <div class="location-group-title">ğŸ”’ ç§äººé‡‘åº« (éœ€å¯†ç¢¼)</div>
            <div id="privateLocationList"></div>

            <div style="display:flex; gap:10px;">
                <div class="location-add" style="flex:1; border-color:#e67e22; color:#e67e22;" onclick="createNewLocation('personal')">â• æ–°å¢ç§äººé‡‘åº«</div>
            </div>
        </div>
    </div>

    <div class="card" id="inputCard">
        <h3 id="inputTitle"><span>âœï¸ æ–°å¢æˆ°ç¸¾</span></h3>
        
        <div style="margin-bottom: 12px;">
            <label style="display:block; font-size:13px; color:#666; margin-bottom:5px; font-weight:bold;">æ—¥æœŸ</label>
            <input type="date" id="dateInput" class="input-style">
        </div>

        <div id="groupInputArea" class="group-mode">
            <div class="row-stats">
                <div class="col-half">
                    <label style="display:block; font-size:13px; color:#666; margin-bottom:5px; font-weight:bold;">å°‡æ•¸</label>
                    <input type="number" id="jiangInput" class="input-style" placeholder="0" value="1" inputmode="numeric">
                </div>
                <div class="col-half">
                    <label style="display:block; font-size:13px; color:#666; margin-bottom:5px; font-weight:bold;">æ±éŒ¢</label>
                    <input type="number" id="dongInput" class="input-style" placeholder="0" value="0" inputmode="numeric">
                </div>
            </div>
            <div id="playersArea"></div>
            
            <div class="highlight-toggle" onclick="toggleHighlightInputs()">
                âœ¨ ç´€éŒ„æœ¬å ´å¤§ç‰Œ (é¸å¡«) â–¼
            </div>
            <div id="highlightInputs" class="highlight-inputs">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:12px; color:#888;">è´å®¶</label>
                        <select id="hlWinnerSelect" class="mem-select"></select>
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:12px; color:#888;">å°æ•¸</label>
                        <select id="hlTaiSelect" class="mem-select"></select>
                    </div>
                </div>
                <div style="margin-top:8px;">
                    <label style="font-size:12px; color:#888;">ç‰Œå‹</label>
                    <select id="hlHandSelect" class="mem-select"></select>
                </div>
            </div>
        </div>

        <div id="personalInputArea" class="personal-mode hidden">
            <div class="input-row">
                <label>åœ°é» / å±€å (å¯é¸å…¬é–‹æˆ°å ´æˆ–è‡ªè¨‚)</label>
                <select id="personalLocSelect" class="personal-select" onchange="handlePersonalSelect('Loc')">
                    <option value="" disabled selected>è«‹é¸æ“‡åœ°é»...</option>
                </select>
                <input type="text" id="personalLocCustom" class="personal-custom" placeholder="è¼¸å…¥æ–°åœ°é»åç¨±">
            </div>
            
            <div class="input-row">
                <label>æ‰“çš„å¤§å° (åº•/å°)</label>
                <select id="personalStakeSelect" class="personal-select" onchange="handlePersonalSelect('Stake')">
                    <option value="" disabled selected>è«‹é¸æ“‡å¤§å°...</option>
                </select>
                <input type="text" id="personalStakeCustom" class="personal-custom" placeholder="è¼¸å…¥å¤§å° (ä¾‹å¦‚: 300/100)">
            </div>

            <div class="input-row">
                <label>ç•¶æ—¥è¼¸è´é‡‘é¡ (è´+ / è¼¸-)</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="sign-btn btn-plus" onclick="togglePersonalSign(this)" id="personalSignBtn">+</button>
                    <input type="number" id="personalScoreInput" class="score-input-large" placeholder="0" inputmode="numeric">
                </div>
            </div>

            <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-top:10px;">
                <label style="color:#f39c12; font-weight:bold;">âœ¨ é›£å¿˜å›æ†¶ (é¸å¡«)</label>
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <select id="pHandSelect" class="mem-select" style="flex:2;"></select>
                    <select id="pTaiSelect" class="mem-select" style="flex:1;"></select>
                </div>
            </div>
        </div>

        <p id="errorMsg" class="error-msg"></p>
        
        <button class="action-btn" id="saveBtn" onclick="saveData()">å„²å­˜ç´€éŒ„</button>
        
        <div id="groupManageControls" style="display:flex; justify-content:space-between; margin-top:10px; align-items:center;">
            <button class="manage-btn" onclick="togglePlayerManager()">âš™ï¸ ç®¡ç†é¸æ‰‹</button>
            <button class="cancel-btn" id="cancelBtn" onclick="cancelEdit()" style="margin:0;">å–æ¶ˆä¿®æ”¹</button>
        </div>
        <div id="personalCancelControls" class="hidden" style="text-align:right; margin-top:10px;">
             <button class="cancel-btn" id="cancelBtnPersonal" onclick="cancelEdit()" style="margin:0; display:inline-block;">å–æ¶ˆä¿®æ”¹</button>
        </div>

        <div id="manageArea" class="manage-area">
            <div style="font-size:12px; color:#999; margin-bottom:5px;">é»æ“Š âœ• å¯åˆªé™¤é¸æ‰‹ (éœ€å¯†ç¢¼é©—è­‰)</div>
            <div id="manageList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>
    </div>

    <div class="card" id="statsCard">
        <h3 id="statsTitle">ğŸ† è‹±é›„æ¦œ</h3>
        <table id="groupStatsTable">
            <thead><tr><th width="15%">#</th><th width="40%">å§“å</th><th width="45%">ç´¯ç©</th></tr></thead>
            <tbody id="summaryBody"><tr><td colspan="3">è¼‰å…¥ä¸­...</td></tr></tbody>
        </table>
        <div id="personalStatsView" class="hidden">
            <div class="dashboard-grid">
                <div class="dash-box" style="background: #fff3e0;">
                    <div class="dash-label">ç”Ÿæ¶¯ç¸½æç›Š</div>
                    <div class="dash-value" id="personalTotalScore" style="color: #e67e22;">$0</div>
                </div>
                <div class="dash-box" style="background: #e8f5e9;">
                    <div class="dash-label">ç¸½å ´æ¬¡</div>
                    <div class="dash-value" id="personalTotalCount" style="color: #2e7d32;">0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="groupDetailStats">
        <h3>ğŸ“Š çµ±è¨ˆæ•¸æ“š</h3>
        <div class="dashboard-grid">
            <div class="dash-box" style="background: #e8f5e9;">
                <div class="dash-label">æ­·å²ç¸½å°‡æ•¸</div>
                <div class="dash-value" style="color: #2e7d32;" id="grandTotalJiang">0</div>
            </div>
            <div class="dash-box" style="background: #fff3e0;">
                <div class="dash-label">æ­·å²ç¸½æ±éŒ¢</div>
                <div class="dash-value" style="color: #ef6c00;" id="grandTotalDong">$0</div>
            </div>
        </div>
        <div style="margin-top:10px; padding:10px; background:#fffcf5; border:1px dashed #f39c12; border-radius:8px; display:flex; align-items:center; justify-content:center; gap:10px;">
            <span>ğŸ”¥ å–®å ´æœ€å¤§å°ï¼š</span>
            <span id="maxTaiRecord" style="font-weight:bold; color:#d35400;">ç„¡ç´€éŒ„</span>
        </div>
        
        <table>
            <thead><tr><th>æœˆä»½</th><th>å ´æ¬¡</th><th>æ±éŒ¢</th></tr></thead>
            <tbody id="monthlyStatsBody"><tr><td colspan="3">è¨ˆç®—ä¸­...</td></tr></tbody>
        </table>
        <div id="yearlyStatsFoot" style="text-align:center; margin-top:10px; font-weight:bold; color:#1e6f50; font-size: 13px;"></div>
    </div>

    <div class="card">
        <h3>
            <span>ğŸ“œ ç´€éŒ„</span>
            <div style="display:flex; gap:5px; align-items:center;">
                <input type="month" id="filterMonth" style="border:1px solid #ddd; background:#fff; padding:2px 5px; border-radius:6px; font-size:13px;" onchange="render()">
            </div>
        </h3>
        <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
            <button class="backup-btn" onclick="backupData()">ğŸ’¾ å‚™ä»½</button>
            <button onclick="exportCSV()" style="background:transparent; border:1px solid #3498db; color:#3498db; border-radius:20px; padding:2px 8px; font-size:12px; margin-left:5px;">ğŸ“¥ Excel</button>
        </div>
        <div id="historyList"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBuqMMuRwgysCZrSJagYmZLd2OOciJC1Rc",
            authDomain: "mahjong-app-d6267.firebaseapp.com",
            projectId: "mahjong-app-d6267",
            storageBucket: "mahjong-app-d6267.firebasestorage.app",
            messagingSenderId: "1083238926870",
            appId: "1:1083238926870:web:f1ffe3b5eadf959bcd8337",
            measurementId: "G-H7T8N8YCG1"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentLocId = 'default'; 
        let currentLocType = 'group'; 
        let recordsRef, playersRef, settingsRef;
        let localRecords = [];
        let currentEditId = null;
        let publicLocationNames = ["è•™å„€å®¶"]; 
        let myStakes = ["50/20", "100/20"];

        const SAFETY_PASSWORD = "8888"; 
        const DEFAULT_PLAYERS = ["å®¥è¾°", "å¤ç‘‹", "è•™å„€", "H", "ç››å®‰", "ä¸€ä¸­"];
        const HAND_TYPES = ["å¹³èƒ¡", "ç¢°ç¢°èƒ¡", "æ··ä¸€è‰²", "æ¸…ä¸€è‰²", "ä¸‰æš—åˆ»", "å››æš—åˆ»", "äº”æš—åˆ»", "é–€æ¸…è‡ªæ‘¸", "å…¨æ±‚äºº", "å¤§ä¸‰å…ƒ", "å°ä¸‰å…ƒ", "å¤§å››å–œ", "å°å››å–œ", "å­—ä¸€è‰²", "ä¸ƒæ¶ä¸€", "å…«ä»™éæµ·", "å¤©èƒ¡", "åœ°èƒ¡", "äººèƒ¡", "æµå±€"];
        let allPlayers = [...DEFAULT_PLAYERS];

        initLocation('default', 'è•™å„€å®¶', 'group');
        initSelectOptions(); // åˆå§‹åŒ–é¸å–®

        db.ref('.info/connected').on('value', function(snap) {
            const statusText = document.getElementById('statusText');
            const dot = document.getElementById('dot');
            if (snap.val() === true) {
                statusText.innerText = "å·²é€£ç·š"; dot.classList.add('connected');
            } else {
                statusText.innerText = "é€£ç·šä¸­..."; dot.classList.remove('connected');
            }
        });

        // åˆå§‹åŒ–é¸å–®é¸é … (ç‰Œå‹ & å°æ•¸)
        function initSelectOptions() {
            let handHtml = '<option value="">é¸æ“‡ç‰Œå‹ (é¸å¡«)</option>';
            HAND_TYPES.forEach(h => handHtml += `<option value="${h}">${h}</option>`);
            document.getElementById('hlHandSelect').innerHTML = handHtml;
            document.getElementById('pHandSelect').innerHTML = handHtml;

            let taiHtml = '<option value="">å°æ•¸ (é¸å¡«)</option>';
            for(let i=1; i<=30; i++) taiHtml += `<option value="${i}">${i}å°</option>`;
            document.getElementById('hlTaiSelect').innerHTML = taiHtml;
            document.getElementById('pTaiSelect').innerHTML = taiHtml;
        }

        // === æ ¸å¿ƒï¼šåˆå§‹åŒ–èˆ‡åˆ‡æ› ===
        function initLocation(id, name, type) {
            if (recordsRef) recordsRef.off();
            if (playersRef) playersRef.off();
            if (settingsRef) settingsRef.off();

            currentLocId = id;
            currentLocType = type;
            document.getElementById('currentLocationName').innerText = `ğŸ“ ${name}`;

            let pathPrefix = id === 'default' ? '' : `locations/${id}/`;
            recordsRef = db.ref(pathPrefix + 'records');
            
            const groupArea = document.getElementById('groupInputArea');
            const personalArea = document.getElementById('personalInputArea');
            const groupStats = document.getElementById('groupStatsTable');
            const personalStats = document.getElementById('personalStatsView');
            const groupDetailStats = document.getElementById('groupDetailStats');
            const groupManageCtrl = document.getElementById('groupManageControls');
            const personalCancelCtrl = document.getElementById('personalCancelControls');

            if (type === 'group') {
                playersRef = db.ref(pathPrefix + 'players');
                setupGroupListeners();
                
                groupArea.classList.remove('hidden');
                personalArea.classList.add('hidden');
                groupStats.classList.remove('hidden');
                personalStats.classList.add('hidden');
                groupDetailStats.classList.remove('hidden'); 
                groupManageCtrl.style.display = 'flex';
                personalCancelCtrl.classList.add('hidden');
                document.getElementById('statsTitle').innerText = "ğŸ† è‹±é›„æ¦œ";
                
                initPlayerInputs(); 
            } else {
                settingsRef = db.ref(pathPrefix + 'settings');
                setupPersonalListeners();
                
                groupArea.classList.add('hidden');
                personalArea.classList.remove('hidden');
                groupStats.classList.add('hidden');
                personalStats.classList.remove('hidden');
                groupDetailStats.classList.add('hidden'); 
                groupManageCtrl.style.display = 'none';
                personalCancelCtrl.classList.remove('hidden');
                document.getElementById('statsTitle').innerText = "ğŸ’° æˆ‘çš„é‡‘åº«";
                
                updatePersonalSelects();
            }
            cancelEdit();
        }

        function setupGroupListeners() {
            playersRef.on('value', (snap) => {
                const data = snap.val();
                if (data) {
                    const cloudPlayers = Object.keys(data);
                    const newPlayers = cloudPlayers.filter(p => !DEFAULT_PLAYERS.includes(p));
                    let sortedPlayers = [];
                    DEFAULT_PLAYERS.forEach(p => { if (cloudPlayers.includes(p)) sortedPlayers.push(p); });
                    cloudPlayers.forEach(p => { if (!sortedPlayers.includes(p)) sortedPlayers.push(p); });
                    allPlayers = sortedPlayers;
                } else {
                    let updates = {};
                    DEFAULT_PLAYERS.forEach(n => updates[n] = true);
                    playersRef.update(updates);
                    allPlayers = DEFAULT_PLAYERS;
                }
                updateAllPlayerSelects(); 
                renderManageList(); 
            });
            listenToRecords();
        }

        function setupPersonalListeners() {
            listenToRecords();
            settingsRef.on('value', snap => {
                const data = snap.val() || {};
                if (data.myStakes) myStakes = Object.keys(data.myStakes); else myStakes = ["50/20", "100/20"];
                updatePersonalSelects();
            });
        }

        function updatePersonalSelects() {
            const locSelect = document.getElementById('personalLocSelect');
            const stakeSelect = document.getElementById('personalStakeSelect');
            
            // åœ°é»é¸å–®ï¼šåªé¡¯ç¤ºå…¬é–‹æˆ°å ´
            let locHtml = `<option value="" disabled selected>è«‹é¸æ“‡åœ°é»...</option>`;
            publicLocationNames.forEach(name => { locHtml += `<option value="${name}">ğŸ  ${name}</option>`; });
            locHtml += `<option value="CUSTOM" style="color:#e67e22;">âœï¸ è‡ªè¨‚åœ°é»...</option>`;
            locSelect.innerHTML = locHtml;

            let stakeHtml = `<option value="" disabled selected>è«‹é¸æ“‡å¤§å°...</option>`;
            myStakes.forEach(s => { stakeHtml += `<option value="${s}">${s}</option>`; });
            stakeHtml += `<option value="CUSTOM" style="color:#e67e22;">âœï¸ è‡ªè¨‚å¤§å°...</option>`;
            stakeSelect.innerHTML = stakeHtml;
        }

        function handlePersonalSelect(type) {
            const select = document.getElementById(`personal${type}Select`);
            const customInput = document.getElementById(`personal${type}Custom`);
            if (select.value === 'CUSTOM') {
                select.style.display = 'none'; customInput.style.display = 'block'; customInput.focus(); customInput.value = '';
            } else {
                select.style.display = 'block'; customInput.style.display = 'none';
            }
        }

        function listenToRecords() {
            recordsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                localRecords = [];
                if (data) {
                    Object.keys(data).forEach(key => {
                        localRecords.push({ id: key, ...data[key] });
                    });
                    localRecords.sort((a, b) => b.timestamp - a.timestamp);
                }
                render();
            });
        }

        function toggleHighlightInputs() {
            const el = document.getElementById('highlightInputs');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
            if(el.style.display === 'block') {
                const rows = document.querySelectorAll('.player-row .name-select');
                const winnerSelect = document.getElementById('hlWinnerSelect');
                let html = '<option value="">è«‹é¸æ“‡è´å®¶</option>';
                rows.forEach(r => {
                    const name = r.value !== 'Other' && r.value !== 'ADD_NEW' ? r.value : r.parentElement.querySelector('.custom-name').value;
                    if(name) html += `<option value="${name}">${name}</option>`;
                });
                winnerSelect.innerHTML = html;
            }
        }

        // === åœ°é»é¸å–®èˆ‡ç®¡ç† ===
        function showLocationMenu() { document.getElementById('locationModal').style.display = 'flex'; renderLocationList(); }
        function closeLocationMenu(e) { if (e.target.id === 'locationModal') document.getElementById('locationModal').style.display = 'none'; }

        function renderLocationList() {
            const publicList = document.getElementById('publicLocationList');
            const privateList = document.getElementById('privateLocationList');
            
            publicList.innerHTML = `<div class="location-item"><div class="loc-name-area" onclick="switchLocation('default', 'è•™å„€å®¶', 'group')"><span>ğŸ  è•™å„€å®¶ (é è¨­)</span> ${currentLocId === 'default' ? 'âœ…' : ''}</div></div>`;
            privateList.innerHTML = '';
            publicLocationNames = ["è•™å„€å®¶"]; 

            db.ref('locations_meta').once('value', snap => {
                const data = snap.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        const loc = data[key];
                        const type = loc.type || 'group'; 
                        if (type === 'group') publicLocationNames.push(loc.name);
                        const icon = type === 'group' ? 'ğŸ ' : 'ğŸ”’';
                        const check = currentLocId === key ? 'âœ…' : '';
                        const html = `<div class="location-item"><div class="loc-name-area" onclick="verifyAndSwitch('${key}', '${loc.name}', '${loc.password}', '${type}')"><span>${icon} ${loc.name}</span> ${check}</div><div class="loc-delete" onclick="deleteLocation('${key}', '${loc.name}', '${loc.password}')">âœ•</div></div>`;
                        if (type !== 'group') privateList.innerHTML += html;
                    });
                }
                if (privateList.innerHTML === '') privateList.innerHTML = '<div style="padding:10px; color:#999; font-size:13px; text-align:center;">å°šç„¡ç§äººé‡‘åº«</div>';
                if (currentLocType === 'personal') updatePersonalSelects();
            });
        }

        function createNewLocation(type) {
            const name = prompt(type === 'group' ? "è«‹è¼¸å…¥æ–°æˆ°å ´åç¨±" : "è«‹è¼¸å…¥æ–°é‡‘åº«åç¨±");
            if (!name) return;
            const password = prompt("è«‹è¨­å®šé€²å…¥èˆ‡åˆªé™¤å¯†ç¢¼ï¼š");
            if (!password) return;
            const newId = 'loc_' + Date.now();
            db.ref('locations_meta/' + newId).set({ name: name, password: password, type: type }).then(() => { alert("âœ… å»ºç«‹æˆåŠŸï¼"); renderLocationList(); });
        }

        function deleteLocation(id, name, password) {
            const input = prompt(`âš ï¸ ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ\nè«‹è¼¸å…¥ç•¶åˆè¨­å®šçš„å¯†ç¢¼ä»¥ç¢ºèªï¼š`);
            if (input === password) {
                db.ref('locations_meta/' + id).remove();
                db.ref('locations/' + id).remove();
                alert("ğŸ—‘ï¸ å·²åˆªé™¤");
                if (currentLocId === id) switchLocation('default', 'è•™å„€å®¶', 'group'); else renderLocationList();
            } else { if(input !== null) alert("âŒ å¯†ç¢¼éŒ¯èª¤"); }
        }

        function verifyAndSwitch(id, name, password, type) {
            if (currentLocId === id) { document.getElementById('locationModal').style.display = 'none'; return; }
            if (type === 'group') { switchLocation(id, name, type); } 
            else {
                const input = prompt(`è«‹è¼¸å…¥ã€Œ${name}ã€çš„å¯†ç¢¼ï¼š`);
                if (input === password) { switchLocation(id, name, type); } else { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); }
            }
        }

        function switchLocation(id, name, type) {
            initLocation(id, name, type);
            document.getElementById('locationModal').style.display = 'none';
        }

        // === æ—¢æœ‰é‚è¼¯ ===
        document.getElementById('dateInput').valueAsDate = new Date();
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('filterMonth').value = `${year}-${month}`;

        function initPlayerInputs() {
            const container = document.getElementById('playersArea');
            let html = '';
            for (let i = 1; i <= 4; i++) {
                html += `<div class="player-row"><div class="name-wrapper"><select class="name-select" onchange="handleNameChange(this)"></select><input type="text" class="custom-name" placeholder="è¼¸å…¥åå­—" style="display:none;"></div><button class="sign-btn btn-plus" onclick="toggleSign(this)">+</button><input type="number" class="score-input" placeholder="0" inputmode="numeric"></div>`;
            }
            container.innerHTML = html;
        }

        function updateAllPlayerSelects() {
            if (currentLocType !== 'group') return;
            let optionsHtml = `<option value="" disabled selected>è«‹é¸æ“‡é¸æ‰‹...</option>`;
            allPlayers.forEach(name => { optionsHtml += `<option value="${name}">${name}</option>`; });
            optionsHtml += `<option value="ADD_NEW" style="color:#2ecc71; font-weight:bold;">â• æ–°å¢å›ºå®šç‰Œå‹...</option>`;
            optionsHtml += `<option value="Other" style="color:#e67e22;">âœï¸ å–®æ¬¡è‡ªè¨‚...</option>`;
            document.querySelectorAll('.name-select').forEach(select => {
                const currentVal = select.value; select.innerHTML = optionsHtml;
                if (currentVal && (allPlayers.includes(currentVal) || currentVal === 'Other' || currentVal === 'ADD_NEW')) select.value = currentVal;
            });
        }

        function togglePlayerManager() {
            const area = document.getElementById('manageArea');
            if (area.style.display === 'block') { area.style.display = 'none'; }
            else { if (checkPassword()) { area.style.display = 'block'; renderManageList(); } else { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); } }
        }

        function renderManageList() {
            const list = document.getElementById('manageList');
            list.innerHTML = '';
            allPlayers.forEach(name => { list.innerHTML += `<div class="player-tag">${name} <span class="player-delete" onclick="deletePlayerFromList('${name}')">âœ•</span></div>`; });
        }

        function deletePlayerFromList(name) { if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) { playersRef.child(name).remove(); } }

        function handleNameChange(select) {
            const wrapper = select.parentElement; const custom = wrapper.querySelector('.custom-name'); const val = select.value;
            if (val === 'Other') { select.style.display = 'none'; custom.style.display = 'block'; custom.focus(); }
            else if (val === 'ADD_NEW') {
                const newName = prompt("è«‹è¼¸å…¥æ–°ç‰Œå‹çš„åå­—ï¼š");
                if (newName && newName.trim() !== "") { playersRef.child(newName.trim()).set(true).then(() => { setTimeout(() => { select.value = newName.trim(); }, 100); }); } else { select.value = ""; }
            } else { custom.style.display = 'none'; select.style.display = 'block'; custom.value = ''; }
        }

        function toggleSign(btn) { if (btn.innerText === '+') { btn.innerText = '-'; btn.className = 'sign-btn btn-minus'; } else { btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; } }
        function togglePersonalSign(btn) { if (btn.innerText === '+') { btn.innerText = '-'; btn.className = 'sign-btn btn-minus'; } else { btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; } }
        function checkPassword() { return prompt("è«‹è¼¸å…¥å®‰å…¨å¯†ç¢¼ (é è¨­ 8888)ï¼š") === SAFETY_PASSWORD; }
        function showError(msg) { const el = document.getElementById('errorMsg'); el.innerText = msg; el.style.display = msg ? 'block' : 'none'; }
        
        function getHolidayTag(dateStr) {
            try {
                const dateParts = dateStr.split('-'); const y = parseInt(dateParts[0]); const m = parseInt(dateParts[1]); const d = parseInt(dateParts[2]);
                if (m === 2 && d === 14) return '<span class="history-tag tag-holiday">ğŸ’˜ æƒ…äººç¯€</span>';
                if (m === 1 && d === 1) return '<span class="history-tag tag-holiday">ğŸ‰ å…ƒæ—¦</span>';
                const lunar = Lunar.fromDate(new Date(y, m - 1, d)); const lMonth = lunar.getMonth(); const lDay = lunar.getDay();
                if (lMonth === 1 && lDay === 1) return '<span class="history-tag tag-holiday">ğŸ§§ æ˜¥ç¯€</span>';
                if (lMonth === 1 && lDay === 15) return '<span class="history-tag tag-holiday">ğŸ® å…ƒå®µ</span>';
                if (lMonth === 5 && lDay === 5) return '<span class="history-tag tag-holiday">ğŸ‰ ç«¯åˆ</span>';
                if (lMonth === 8 && lDay === 15) return '<span class="history-tag tag-holiday">ğŸ¥® ä¸­ç§‹</span>';
                if (lDay === 1) return '<span class="history-tag tag-lunar">ğŸŒ‘ åˆä¸€</span>';
                if (lDay === 15) return '<span class="history-tag tag-lunar">ğŸŒ• åäº”</span>';
                return '';
            } catch (e) { return ''; }
        }

        function saveData() {
            // åªæœ‰åœ¨å…¬é–‹ç¾¤çµ„æ¨¡å¼æ‰éœ€è¦å¯†ç¢¼é©—è­‰
            if (currentEditId && currentLocType === 'group') { if (!checkPassword()) { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); return; } }
            
            const date = document.getElementById('dateInput').value;
            let recordData = { date: date, timestamp: Date.now() };

            if (currentLocType === 'group') {
                const jiangCount = parseInt(document.getElementById('jiangInput').value) || 0;
                const dongQian = parseInt(document.getElementById('dongInput').value) || 0;
                const rows = document.querySelectorAll('.player-row');
                let currentEntry = []; let totalScore = 0; let namesCheck = new Set();
                for (let row of rows) {
                    const select = row.querySelector('.name-select'); const customInput = row.querySelector('.custom-name'); const signBtn = row.querySelector('.sign-btn'); const scoreInput = row.querySelector('.score-input');
                    let name = select.style.display !== 'none' ? select.value : customInput.value.trim();
                    if (name === "ADD_NEW") name = ""; if (!name) { showError("âš ï¸ è«‹è¼¸å…¥/é¸æ“‡é¸æ‰‹"); return; }
                    if (namesCheck.has(name)) { showError(`âš ï¸ åå­—é‡è¤‡ï¼š${name}`); return; } namesCheck.add(name);
                    let rawScore = parseInt(scoreInput.value); if (isNaN(rawScore)) { showError(`âš ï¸ è«‹è¼¸å…¥é‡‘é¡`); return; }
                    let finalScore = Math.abs(rawScore) * (signBtn.innerText === '+' ? 1 : -1);
                    currentEntry.push({ name: name, score: finalScore }); totalScore += finalScore;
                }
                if (totalScore !== 0) { showError(`âš ï¸ å¸³ç›®ä¸å¹³ï¼ç›®å‰ ${totalScore}`); return; }
                
                const hlWinner = document.getElementById('hlWinnerSelect').value;
                const hlHand = document.getElementById('hlHandSelect').value;
                const hlTai = document.getElementById('hlTaiSelect').value;
                if (hlWinner && hlHand) {
                    recordData.highlight = { player: hlWinner, hand: hlHand, tai: parseInt(hlTai) || 0 };
                }

                recordData.jiangCount = jiangCount; recordData.dongQian = dongQian; recordData.details = currentEntry;
            } else {
                const locSelect = document.getElementById('personalLocSelect'); const locCustom = document.getElementById('personalLocCustom');
                const stakeSelect = document.getElementById('personalStakeSelect'); const stakeCustom = document.getElementById('personalStakeCustom');
                let loc = locSelect.style.display !== 'none' ? locSelect.value : locCustom.value.trim();
                let stake = stakeSelect.style.display !== 'none' ? stakeSelect.value : stakeCustom.value.trim();
                if (!loc || loc === "CUSTOM") { showError("âš ï¸ è«‹è¼¸å…¥åœ°é»"); return; }
                const scoreInput = document.getElementById('personalScoreInput'); const score = parseInt(scoreInput.value); const signBtn = document.getElementById('personalSignBtn');
                if (isNaN(score)) { showError("âš ï¸ è«‹è¼¸å…¥é‡‘é¡"); return; }
                let finalScore = Math.abs(score) * (signBtn.innerText === '+' ? 1 : -1);
                
                const pHand = document.getElementById('pHandSelect').value;
                const pTai = document.getElementById('pTaiSelect').value;
                if (pHand) recordData.highlight = { hand: pHand, tai: parseInt(pTai) || 0 };

                recordData.location = loc; recordData.score = finalScore; recordData.note = stake;
                if (stakeSelect.style.display === 'none' && stake && !myStakes.includes(stake)) settingsRef.child('myStakes/' + stake).set(true);
            }

            if (currentEditId) { recordsRef.child(currentEditId).update(recordData).then(() => { alert("âœ… ä¿®æ”¹æˆåŠŸ"); cancelEdit(); }); }
            else { recordsRef.push(recordData).then(() => { resetForm(); alert("âœ… å„²å­˜æˆåŠŸ"); }); }
        }

        function editRecord(id) {
            const record = localRecords.find(r => r.id === id); if (!record) return;
            document.getElementById('dateInput').value = record.date;
            if (currentLocType === 'group') {
                document.getElementById('jiangInput').value = record.jiangCount || 0; document.getElementById('dongInput').value = record.dongQian || 0;
                if (record.highlight) {
                    document.getElementById('highlightInputs').style.display = 'block';
                    document.getElementById('hlHandSelect').value = record.highlight.hand;
                    document.getElementById('hlTaiSelect').value = record.highlight.tai;
                }
                const rows = document.querySelectorAll('.player-row');
                for (let i = 0; i < 4; i++) {
                    if (i < record.details.length) {
                        const p = record.details[i]; const row = rows[i]; const select = row.querySelector('.name-select'); const custom = row.querySelector('.custom-name'); const score = row.querySelector('.score-input'); const btn = row.querySelector('.sign-btn');
                        if (allPlayers.includes(p.name)) { select.value = p.name; select.style.display = 'block'; custom.style.display = 'none'; } else { select.value = 'Other'; select.style.display = 'none'; custom.style.display = 'block'; custom.value = p.name; }
                        score.value = Math.abs(p.score); btn.innerText = p.score < 0 ? '-' : '+'; btn.className = p.score < 0 ? 'sign-btn btn-minus' : 'sign-btn btn-plus';
                    }
                }
                toggleHighlightInputs(); if(record.highlight) document.getElementById('hlWinnerSelect').value = record.highlight.player;

            } else {
                const locSelect = document.getElementById('personalLocSelect'); const locCustom = document.getElementById('personalLocCustom');
                const stakeSelect = document.getElementById('personalStakeSelect'); const stakeCustom = document.getElementById('personalStakeCustom');
                let isKnownLoc = false; Array.from(locSelect.options).forEach(opt => { if(opt.value === record.location) isKnownLoc = true; });
                if (isKnownLoc) { locSelect.value = record.location; locSelect.style.display = 'block'; locCustom.style.display = 'none'; }
                else { locSelect.value = 'CUSTOM'; locCustom.value = record.location; locSelect.style.display = 'none'; locCustom.style.display = 'block'; }

                let stakeVal = record.note || ''; let isKnownStake = false; Array.from(stakeSelect.options).forEach(opt => { if(opt.value === stakeVal) isKnownStake = true; });
                if (isKnownStake) { stakeSelect.value = stakeVal; stakeSelect.style.display = 'block'; stakeCustom.style.display = 'none'; }
                else { stakeSelect.value = 'CUSTOM'; stakeCustom.value = stakeVal; stakeSelect.style.display = 'none'; stakeCustom.style.display = 'block'; }

                if (record.highlight) {
                    document.getElementById('pHandSelect').value = record.highlight.hand;
                    document.getElementById('pTaiSelect').value = record.highlight.tai;
                }

                document.getElementById('personalScoreInput').value = Math.abs(record.score);
                const btn = document.getElementById('personalSignBtn');
                btn.innerText = record.score < 0 ? '-' : '+'; btn.className = record.score < 0 ? 'sign-btn btn-minus' : 'sign-btn btn-plus';
            }
            currentEditId = id; document.getElementById('inputCard').classList.add('editing-mode'); document.getElementById('inputTitle').innerText = "âœï¸ ä¿®æ”¹ä¸­..."; document.getElementById('saveBtn').innerText = "ç¢ºèªä¿®æ”¹" + (currentLocType==='group' ? " (éœ€å¯†ç¢¼)" : ""); document.getElementById('saveBtn').style.backgroundColor = "#f39c12"; document.getElementById('cancelBtn').style.display = "block"; if(currentLocType !== 'group') document.getElementById('cancelBtnPersonal').style.display = "inline-block"; window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRecord(id) {
            if (currentLocType === 'group') { if (!checkPassword()) { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); return; } }
            if(!confirm("âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) return;
            recordsRef.child(id).remove();
            if (currentEditId === id) cancelEdit();
        }

        function cancelEdit() {
            currentEditId = null; document.getElementById('inputCard').classList.remove('editing-mode'); document.getElementById('inputTitle').innerText = "âœï¸ æ–°å¢æˆ°ç¸¾"; document.getElementById('saveBtn').innerText = "å„²å­˜ç´€éŒ„"; document.getElementById('saveBtn').style.backgroundColor = ""; document.getElementById('cancelBtn').style.display = "none"; document.getElementById('cancelBtnPersonal').style.display = "none"; document.getElementById('manageArea').style.display = 'none'; resetForm();
        }

        function resetForm() {
            if (currentLocType === 'group') {
                const rows = document.querySelectorAll('.player-row'); rows.forEach(row => { row.querySelector('.score-input').value = ''; let btn = row.querySelector('.sign-btn'); btn.innerText = '+'; btn.className = 'sign-btn btn-plus'; const select = row.querySelector('.name-select'); const custom = row.querySelector('.custom-name'); select.value = ""; select.style.display = 'block'; custom.style.display = 'none'; });
                document.getElementById('dongInput').value = 0; document.getElementById('jiangInput').value = 1;
                document.getElementById('highlightInputs').style.display = 'none';
                document.getElementById('hlHandSelect').value = ''; document.getElementById('hlTaiSelect').value = '';
            } else {
                document.getElementById('personalLocSelect').value = ''; document.getElementById('personalLocSelect').style.display = 'block'; document.getElementById('personalLocCustom').style.display = 'none';
                document.getElementById('personalStakeSelect').value = ''; document.getElementById('personalStakeSelect').style.display = 'block'; document.getElementById('personalStakeCustom').style.display = 'none';
                document.getElementById('personalScoreInput').value = ''; let btn = document.getElementById('personalSignBtn'); btn.innerText = '+'; btn.className = 'sign-btn btn-plus';
                document.getElementById('pHandSelect').value = ''; document.getElementById('pTaiSelect').value = '';
            }
            showError("");
        }

        function render() {
            const filterValue = document.getElementById('filterMonth').value; 
            const listDiv = document.getElementById('historyList');
            listDiv.innerHTML = '';
            
            let displayRecords = localRecords;
            if (filterValue) { displayRecords = localRecords.filter(rec => rec.date.startsWith(filterValue)); }
            if (displayRecords.length === 0) { listDiv.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">ç„¡ç´€éŒ„</p>'; }

            displayRecords.forEach(rec => {
                let html = ''; let holidayTag = getHolidayTag(rec.date);
                
                let highlightTag = '';
                if (rec.highlight && rec.highlight.hand) {
                    const playerStr = rec.highlight.player ? `${rec.highlight.player}: ` : '';
                    highlightTag = `<div style="margin-top:4px;"><span class="history-tag tag-highlight">ğŸ† ${playerStr}${rec.highlight.hand} ${rec.highlight.tai}å°</span></div>`;
                }

                if (currentLocType === 'group') {
                    let detailsHtml = rec.details.map(p => {
                        let colorClass = p.score > 0 ? 'win-text' : (p.score < 0 ? 'lose-text' : 'zero-text'); let sign = p.score > 0 ? '+' : '';
                        return `<div><span>${p.name}</span> <span class="${colorClass}">${sign}${p.score}</span></div>`;
                    }).join('');
                    let infoTags = ""; if (rec.jiangCount) infoTags += `<span class="history-tag tag-info">ğŸ€„ ${rec.jiangCount}å°‡</span>`; if (rec.dongQian) infoTags += `<span class="history-tag tag-info">ğŸ’° æ±${rec.dongQian}</span>`;
                    html = `<div style="flex:1;"><div class="history-header"><span class="history-date">${rec.date}</span> ${holidayTag} ${infoTags}</div><div class="history-scores">${detailsHtml}</div>${highlightTag}</div>`;
                } else {
                    let colorClass = rec.score > 0 ? 'win-text' : (rec.score < 0 ? 'lose-text' : 'zero-text'); let sign = rec.score > 0 ? '+' : ''; let noteHtml = rec.note ? `<div style="font-size:12px; color:#888;">ğŸ“ ${rec.note}</div>` : '';
                    html = `<div style="flex:1;"><div class="history-header"><span class="history-date">${rec.date}</span> ${holidayTag} <span class="history-tag tag-info">ğŸ“ ${rec.location}</span></div><div style="font-size:18px; font-weight:bold; margin-top:5px;" class="${colorClass}">${sign}${rec.score}</div>${noteHtml}${highlightTag}</div>`;
                }
                let item = document.createElement('div'); item.className = 'history-item'; item.innerHTML = html + `<div><button class="edit-btn" onclick="editRecord('${rec.id}')">âœ</button><button class="delete-btn" onclick="deleteRecord('${rec.id}')">âœ•</button></div>`;
                listDiv.appendChild(item);
            });

            if (currentLocType === 'group') renderGroupStats(); else renderPersonalStats();
        }

        function renderGroupStats() {
            let stats = {}; let monthlyData = {}; let yearlyJiang = {}; let grandTotalJiang = 0; let grandTotalDong = 0; 
            let maxTai = { tai: 0, player: '', hand: '' };

            localRecords.forEach(rec => {
                rec.details.forEach(p => { if (!stats[p.name]) stats[p.name] = 0; stats[p.name] += p.score; });
                if (rec.highlight && rec.highlight.tai > maxTai.tai) { maxTai = rec.highlight; }
                let dateObj = new Date(rec.date); let year = dateObj.getFullYear(); let month = (dateObj.getMonth() + 1).toString().padStart(2, '0'); let key = `${month}æœˆ`;
                if (!monthlyData[key]) monthlyData[key] = { jiang: 0, dong: 0 }; if (!yearlyJiang[year]) yearlyJiang[year] = 0;
                let j = parseInt(rec.jiangCount) || 0; let d = parseInt(rec.dongQian) || 0;
                monthlyData[key].jiang += j; monthlyData[key].dong += d; yearlyJiang[year] += j; grandTotalJiang += j; grandTotalDong += d;
            });

            const maxTaiEl = document.getElementById('maxTaiRecord');
            if (maxTai.tai > 0) { maxTaiEl.innerText = `${maxTai.player} / ${maxTai.hand} (${maxTai.tai}å°)`; } else { maxTaiEl.innerText = "å°šç„¡ç´€éŒ„"; }

            const summaryBody = document.getElementById('summaryBody'); summaryBody.innerHTML = '';
            if (Object.keys(stats).length === 0) { summaryBody.innerHTML = '<tr><td colspan="3" style="color:#999;">ç„¡è³‡æ–™</td></tr>'; }
            else {
                let sortedStats = Object.entries(stats).sort(([,a], [,b]) => b - a);
                sortedStats.forEach(([name, score], index) => {
                    let colorClass = score > 0 ? 'win-text' : (score < 0 ? 'lose-text' : 'zero-text'); let sign = score > 0 ? '+' : '';
                    let rankContent = index + 1; let rankClass = "rank-other";
                    if(index === 0) { rankContent = 'ğŸ¥‡'; rankClass = "rank-1"; } else if(index === 1) { rankContent = 'ğŸ¥ˆ'; rankClass = "rank-2"; } else if(index === 2) { rankContent = 'ğŸ¥‰'; rankClass = "rank-3"; }
                    if (index === sortedStats.length - 1 && sortedStats.length > 1) { rankContent = 'è€é—†'; rankClass = 'rank-boss'; }
                    summaryBody.innerHTML += `<tr><td><span class="rank-badge ${rankClass}">${rankContent}</span></td><td style="font-weight:500;">${name}</td><td class="${colorClass}">${sign}${score}</td></tr>`;
                });
            }
            document.getElementById('grandTotalJiang').innerText = grandTotalJiang; document.getElementById('grandTotalDong').innerText = "$" + grandTotalDong;
            const statsBody = document.getElementById('monthlyStatsBody'); const yearFoot = document.getElementById('yearlyStatsFoot'); statsBody.innerHTML = ''; yearFoot.innerHTML = '';
            let sortedKeys = Object.keys(monthlyData).sort().reverse();
            if (sortedKeys.length === 0) { statsBody.innerHTML = '<tr><td colspan="3">ç„¡è³‡æ–™</td></tr>'; } else { sortedKeys.forEach(key => { let d = monthlyData[key]; statsBody.innerHTML += `<tr><td>${key}</td><td>${d.jiang}</td><td>${d.dong}</td></tr>`; }); }
            let sortedYears = Object.keys(yearlyJiang).sort().reverse(); if(sortedYears.length > 0) { yearFoot.innerHTML = `${sortedYears[0]}å¹´ç¸½è¨ˆï¼š${yearlyJiang[sortedYears[0]]} å°‡`; }
        }

        function renderPersonalStats() {
            let totalScore = 0; localRecords.forEach(rec => { totalScore += (parseInt(rec.score) || 0); });
            const sign = totalScore > 0 ? '+' : ''; const color = totalScore > 0 ? '#e74c3c' : (totalScore < 0 ? '#27ae60' : '#666');
            const scoreEl = document.getElementById('personalTotalScore'); scoreEl.innerText = `${sign}$${totalScore}`; scoreEl.style.color = color;
            document.getElementById('personalTotalCount').innerText = localRecords.length;
        }

        function exportCSV() {
            let csv = currentLocType === 'group' ? "\uFEFFæ—¥æœŸ,å°‡æ•¸,æ±éŒ¢,ç©å®¶,é‡‘é¡\n" : "\uFEFFæ—¥æœŸ,åœ°é»,é‡‘é¡,å‚™è¨»\n";
            localRecords.forEach(rec => {
                if(currentLocType === 'group') { rec.details.forEach(p => { csv += `${rec.date},${rec.jiangCount || 0},${rec.dongQian || 0},${p.name},${p.score}\n`; }); }
                else { csv += `${rec.date},${rec.location},${rec.score},${rec.note || ''}\n`; }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `éº»å°‡_${currentLocType}_${new Date().toISOString().slice(0,10)}.csv`; link.click();
        }

        function backupData() {
            const jsonStr = JSON.stringify(localRecords, null, 2); const blob = new Blob([jsonStr], { type: 'application/json' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `éº»å°‡å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`; link.click();
        }
    </script>
</body>
</html>
